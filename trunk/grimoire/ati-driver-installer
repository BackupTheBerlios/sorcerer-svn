# This probably does not compile
# Compile log suggests that the source in ati-driver-installer has errors.
# Mon-Thu, eastern times
# 1 877 284 1566
# Phone number for ATI support

    stable 10-4-x86.x86_64 9-3-x86.x86_64 9-1-x86.x86_64 8-5-x86.x86_64 8-4-x86.x86_64 8-3-x86.x86_64 8.443.1-x86.x86_64 7-11-x86.x86_64 8.42.3-x86.x86_64 8.40.4-x86.x86_64
#  require MesaLib gcc-v3.3 xorg-legacy
  optional rovclock '' '' to underclock the ATI GPU before the fan melts
  category kernel
 attribute linux-26-module x11 x86
 attribute broke
    source http://www2.ati.com/drivers/linux/ati-driver-installer-$VERSION.run
  homepage http://www.ati.com/support/drivers/linux/radeon-linux.html
      vurl http://ati.amd.com/support/drivers/linux/linux-radeon.html
  eprovide ati_firegl fglrx
  estimate 50
      desc 'xorg and linux kernel drivers provided by ATI for radeon class graphics cards

The fglrx module will probably load if agpgart and radeon
modules are not loaded nor compiled directly into the kernel.

A sample configuration file is in:
$GRIMOIRE/ati-driver-installer.d/

You may also want to install rovclock and reduce the clock speed of
the ATI GPU in order to prevent lockups, fan meltdown, and chip meltdown.

The display driver requires linux versions 2.6.x and POSIX shared memory.'


build_broke(){
# running sh $SOURCE --install does not install anything.
 prepare_install &&
 sh $SOURCE --install
}


pre_build(){
 default_pre_build
 BUILD_DIR="${BUILD_DIR:-$SOURCE_DIR/ati-driver-installer}"
 cd $BUILD_DIR
 sh $SOURCE --extract $BUILD_DIR
 chown -R root:root   $BUILD_DIR
}


build(){
 make_install(){
  cd        $BUILD_DIR

  /sbin/ldconfig -n           arch/$AVER/usr/X11R6/lib
  rm -rf common/{lib,usr/src} arch/$AVER/lib

  cp -av common/* $XVER/* arch/$AVER/* /

#  find common $XVER arch/$AVER -type f -printf "%p %P\n" |
#  while read         FROM   TO
#  do    install -vD $FROM /$TO
#  done
#  find common $XVER arch/$AVER -type l -printf "%p %P\n" |
#  while read         FROM   TO
#  do    mv     -v   $FROM /$TO
#  done

  # cp  -rv  common/*  $XVER/*     arch/$AVER/usr  /
 }


 case $HOSTTYPE in
  x86_64) XVER+=x750_64a ; AVER=x86_64 ;;
       *) XVER+=x750     ; AVER=x86    ;;
 esac

 LVER=$( installed_version $( get_provider linux-kernel ) )
 LVER="${LVER:-$( uname -r )}"

 cd common/lib/modules/fglrx/build_mod

 sed -i "s:modprobe \$module:true:
         s:rmmod \$module:true:"     ../make_install.sh
 sed -i "s:\`uname -r\`:\"$LVER\":"  ../make_install.sh make.sh
 sed -i "s:hit=0:hit=1:"                                make.sh
 sed -i "s:\$\(shell uname -r\):$LVER:" 2.6.x/Makefile
#sed -i "/LIBIP_PREFIX=/d"           make.sh
 sed -i '/LIBIP_PREFIX=\./d' make.sh
 sed -i "s:LIBIP_PREFIX=\$.*:LIBIP_PREFIX=\$LIBIP_PREFIX \\\:" make.sh

 LIBIP_PREFIX=../../../../../../arch/$AVER/lib/modules/fglrx/build_mod  \
 sh -x ./make.sh         &&
 prepare_install      &&
 cd ..                &&
 sh ./make_install.sh &&
      make_install
}

# post_install(){ depmod -a -q -F /boot/System.map; }
