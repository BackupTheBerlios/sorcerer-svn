lilo_image_entry()  {

  cat  <<  EOF

image			=	/boot/$VERSION-gr/linux
	label		=	$VERSION-gr
	read-only
	restricted

EOF

}


update_lilo()  {


  if    !  [  -f  /etc/lilo.conf  ]
  then  return
  fi

  if    !  grep  -q  -w  "$VERSION-gr"  /etc/lilo.conf
  then

    IFS_OLD=$IFS
    export  IFS="$ENTER_IFS"

    rm     -rf  /etc/lilo.conf.old
    touch       /etc/lilo.conf.old
    chmod  600  /etc/lilo.conf.old

    rm     -rf  /etc/lilo.conf.new
    touch       /etc/lilo.conf.new
    chmod  600  /etc/lilo.conf.new

    cp  /etc/lilo.conf  /etc/lilo.conf.old

    (( IMAGE_COUNT=0  ))

    for  LINE  in  `cat /etc/lilo.conf`;  do

      if   echo  "$LINE"  |  grep  -q -w "image\|other";  then
        if    (( IMAGE_COUNT  == 0  ))
        then  lilo_image_entry  >>  /etc/lilo.conf.new
        fi
        ((  IMAGE_COUNT++  ))
      fi

      if    ((  IMAGE_COUNT == 14  ))
      then  break
      fi
    
      echo  "$LINE"  >>  /etc/lilo.conf.new

    done

    if    ((  IMAGE_COUNT ==  0  ))
    then  lilo_image_entry  >>  /etc/lilo.conf.new
    fi

    cp  /etc/lilo.conf.new  /etc/lilo.conf
    rm  /etc/lilo.conf.new

    export  IFS=$IFS_OLD

  fi

  /sbin/lilo

}


update_yaboot()  {

  if    !  [  -f  /etc/yaboot.conf  ]
  then  return
  fi

  if    !  grep  -q  -w "$VERSION-gr"  /etc/yaboot.conf
  then

    IFS_OLD=$IFS
    export  IFS="$ENTER_IFS"

    rm     -rf  /etc/yaboot.conf.old
    touch       /etc/yaboot.conf.old
    chmod  600  /etc/yaboot.conf.old

    rm     -rf  /etc/yaboot.conf.new
    touch       /etc/yaboot.conf.new
    chmod  600  /etc/yaboot.conf.new

    cp  /etc/yaboot.conf  /etc/lilo.conf.old

    (( IMAGE_COUNT=0  ))

    for  LINE  in  `cat /etc/yaboot.conf`;  do

      if   echo  "$LINE"  |  grep  -q -w  "image\|other";  then

        if    (( IMAGE_COUNT  == 0  ))
        then  lilo_image_entry  >>  /etc/yaboot.conf.new
        fi
        ((  IMAGE_COUNT++  ))
      fi

      if    ((  IMAGE_COUNT == 14  ))
      then  break
      fi

      echo  "$LINE"  >>  /etc/yaboot.conf.new

    done

    if    ((  IMAGE_COUNT ==  0  ))
    then  lilo_image_entry  >>  /etc/yaboot.conf.new
    fi

    cp  /etc/yaboot.conf.new  /etc/yaboot.conf

    export  IFS=$IFS_OLD

  fi

  /usr/sbin/ybin

}


case  $BUILD  in
  powerpc-linux-gnu)  update_yaboot  ;;
                  *)  update_lilo    ;;
esac


               RECAST=$(  show_installed  linux-26-module  )
if    [  -n  "$RECAST"  ]
then  unlock_cast;  cast  -c  "$RECAST"
fi

backup_lib

if    [  -x  /usr/bin/mail   ]
then  MAILER=/usr/bin/mail
elif  [  -x  /usr/bin/mailx  ]
then  MAILER=/usr/bin/mailx
fi

if    [  -n  "$MAILER"    ]  &&
      [  -n  "$SORCERER"  ]
then
  (
    echo  "New linux kernel installed."
    echo  "Remember to reboot the box, please."
  )  |  $MAILER  -s  "Reboot reminder from sorcery."  $SORCERER
fi
