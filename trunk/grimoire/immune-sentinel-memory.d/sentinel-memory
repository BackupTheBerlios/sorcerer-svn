#!/bin/bash
# Copyright 2011 by Kyle Sallee,
# All rights reserved.
# For use with the Sorcerer distribution only.

swap_scan(){
 while read F S U; do
  if    [[ $F = SwapFree: ]]; then
   if   ((  S > 65536 ))
   then return 0
   else return 1
   fi
  fi
 done < /proc/meminfo
}

# 10M reserve worked in trials.

pawn(){
 mkdir -p        $CG/pawn
 echo $BASHPID > $CG/pawn/tasks
 echo 0        > $CG/pawn/memory.oom_control
 echo 1000     > /proc/$BASHPID/oom_score_adj
 local RESERVE="$( dd if=/dev/zero bs=12M count=1 2>/dev/null | tr '\0' ' ' )"
 while sleep 60 && swap_scan; do :; done
}

oom_control(){
 find $CG -mindepth 2 -maxdepth 2 -type f -name memory.oom_control |
 grep -v memory/pawn/memory |
 while read; do echo $1 > $REPLY; done
}

main(){
 allocate(){
  fallocate "-l$SIZE" "$SWAP" ||
  dd if=/dev/zero  of="$SWAP" bs=1M count=${SIZE%M}
 }

 local PASS=0
 echo -1000    > /proc/$BASHPID/oom_score_adj
 while
  (( PASS++ ))
  SWAP=$SDIR/swap.$$.$RANDOM.$PASS &&
  allocate &&
  mkswap  "$SWAP" &&
  chmod 0 "$SWAP" &&
  coproc pawn
 do
  read <& ${COPROC[0]}
  swapon "$SWAP"
 done
 oom_control 0
 exit 0
}

on_exit(){ oom_control 0; }

[ -f /lib/cgroup/functions ] &&
   . /lib/cgroup/functions   &&
cgroup_find ||
exit 0

if   [[     -x /usr/libexec/bash/sleep ]]
then enable -f /usr/libexec/bash/sleep sleep
fi

SDIR=$1
SIZE=$2
if   [     -d      $SDIR ]
then rm    -f      $SDIR/swap* &>/dev/null
else mkdir -pm 700 $SDIR
fi
trap on_exit EXIT
oom_control 1
main &>/dev/null &
exit 0
