diff -r -U2 xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_io.c xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_io.c
--- xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_io.c	2002-10-20 14:45:27.000000000 -0700
+++ xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_io.c	2004-11-09 21:28:38.000000000 -0700
@@ -1,3 +1,3 @@
-/* $XFree86: xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_io.c,v 3.24 2002/10/20 21:45:27 tsi Exp $ */
+/* $XFree86: xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_io.c,v 3.29 2004/11/10 04:28:38 dawes Exp $ */
 /*
  * Copyright 1992 by Orest Zborowski <obz@Kodak.com>
@@ -24,5 +24,50 @@
  *
  */
-/* $XConsortium: lnx_io.c /main/8 1996/10/19 18:06:28 kaleb $ */
+/*
+ * Copyright (c) 1994-2004 by The XFree86 Project, Inc.
+ * All rights reserved.
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining
+ * a copy of this software and associated documentation files (the
+ * "Software"), to deal in the Software without restriction, including
+ * without limitation the rights to use, copy, modify, merge, publish,
+ * distribute, sublicense, and/or sell copies of the Software, and to
+ * permit persons to whom the Software is furnished to do so, subject
+ * to the following conditions:
+ *
+ *   1.  Redistributions of source code must retain the above copyright
+ *       notice, this list of conditions, and the following disclaimer.
+ *
+ *   2.  Redistributions in binary form must reproduce the above copyright
+ *       notice, this list of conditions and the following disclaimer
+ *       in the documentation and/or other materials provided with the
+ *       distribution, and in the same place and form as other copyright,
+ *       license and disclaimer information.
+ *
+ *   3.  The end-user documentation included with the redistribution,
+ *       if any, must include the following acknowledgment: "This product
+ *       includes software developed by The XFree86 Project, Inc
+ *       (http://www.xfree86.org/) and its contributors", in the same
+ *       place and form as other third-party acknowledgments.  Alternately,
+ *       this acknowledgment may appear in the software itself, in the
+ *       same form and location as other such third-party acknowledgments.
+ *
+ *   4.  Except as contained in this notice, the name of The XFree86
+ *       Project, Inc shall not be used in advertising or otherwise to
+ *       promote the sale, use or other dealings in this Software without
+ *       prior written authorization from The XFree86 Project, Inc.
+ *
+ * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
+ * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+ * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE XFREE86 PROJECT, INC OR ITS CONTRIBUTORS BE
+ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
+ * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT
+ * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
+ * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
+ * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
+ * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
 
 #define NEED_EVENTS
@@ -37,4 +82,13 @@
 #define KBC_TIMEOUT 250        /* Timeout in ms for sending to keyboard controller */
 
+#ifndef KBD_DIRECTHW
+#define KBD_DIRECTHW 0
+#endif
+
+#if !(defined(__alpha__) || defined (__i386__) || defined(__ia64__))
+#undef KBD_DIRECTHW
+#define KBD_DIRECTHW 0
+#endif
+
 void
 xf86SoundKbdBell(int loudness, int pitch, int duration)
@@ -68,4 +122,5 @@
 
 #include <linux/kd.h>
+#include <linux/version.h>
 #ifdef __sparc__
 #include <asm/param.h>
@@ -81,5 +136,5 @@
 
 static int
-KDKBDREP_ioctl_ok(int rate, int delay) {
+KDKBDREP_ioctl_ok(int fd, int rate, int delay) {
 #if defined(KDKBDREP) && !defined(__sparc__)
      /* This ioctl is defined in <linux/kd.h> but is not
@@ -90,5 +145,5 @@
    kbdrep_s.rate = -1;
    kbdrep_s.delay = -1;
-   if (ioctl( 0, KDKBDREP, &kbdrep_s )) {
+   if (ioctl( fd, KDKBDREP, &kbdrep_s )) {
        return 0;
    }
@@ -105,5 +160,5 @@
      kbdrep_s.delay = 1;
    
-   if (ioctl( 0, KDKBDREP, &kbdrep_s )) {
+   if (ioctl( fd, KDKBDREP, &kbdrep_s )) {
      return 0;
    }
@@ -143,10 +198,5 @@
 #undef rate
 
-#if NeedFunctionPrototypes
 void xf86SetKbdRepeat(char rad)
-#else
-void xf86SetKbdRepeat(rad)
-char rad;
-#endif
 {
 #ifdef __sparc__
@@ -158,5 +208,5 @@
 #endif
 
-#if defined(__alpha__) || defined (__i386__) || defined(__ia64__)
+#if KBD_DIRECTHW
   int i;
   int timeout;
@@ -179,5 +229,5 @@
 
 
-  if(KDKBDREP_ioctl_ok(rate, delay)) 	/* m68k? */
+  if(KDKBDREP_ioctl_ok(xf86Info.consoleFd, rate, delay)) 	/* m68k? */
     return;
 
@@ -188,5 +238,5 @@
     return;
 
-#if defined(__alpha__) || defined (__i386__) || defined(__ia64__)
+#if KBD_DIRECTHW
 
   /* The ioport way */
@@ -220,5 +270,5 @@
   outb(0x60, value);
 
-#endif /* __alpha__ || __i386__ || __ia64__ */
+#endif /* KBD_DIRECTHW */
 }
 
diff -r -U2 xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_kbd.c xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_kbd.c
--- xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_kbd.c	2003-02-17 08:11:57.000000000 -0700
+++ xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_kbd.c	2004-11-09 21:28:38.000000000 -0700
@@ -1,3 +1,3 @@
-/* $XFree86: xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_kbd.c,v 1.2 2003/02/17 15:11:57 dawes Exp $ */
+/* $XFree86: xc/programs/Xserver/hw/xfree86/os-support/linux/lnx_kbd.c,v 1.9 2004/11/10 04:28:38 dawes Exp $ */
 
 /*
@@ -9,4 +9,50 @@
  * Copyright 1993 by David Dawes <dawes@xfree86.org>
  */
+/*
+ * Copyright (c) 1994-2004 by The XFree86 Project, Inc.
+ * All rights reserved.
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining
+ * a copy of this software and associated documentation files (the
+ * "Software"), to deal in the Software without restriction, including
+ * without limitation the rights to use, copy, modify, merge, publish,
+ * distribute, sublicense, and/or sell copies of the Software, and to
+ * permit persons to whom the Software is furnished to do so, subject
+ * to the following conditions:
+ *
+ *   1.  Redistributions of source code must retain the above copyright
+ *       notice, this list of conditions, and the following disclaimer.
+ *
+ *   2.  Redistributions in binary form must reproduce the above copyright
+ *       notice, this list of conditions and the following disclaimer
+ *       in the documentation and/or other materials provided with the
+ *       distribution, and in the same place and form as other copyright,
+ *       license and disclaimer information.
+ *
+ *   3.  The end-user documentation included with the redistribution,
+ *       if any, must include the following acknowledgment: "This product
+ *       includes software developed by The XFree86 Project, Inc
+ *       (http://www.xfree86.org/) and its contributors", in the same
+ *       place and form as other third-party acknowledgments.  Alternately,
+ *       this acknowledgment may appear in the software itself, in the
+ *       same form and location as other such third-party acknowledgments.
+ *
+ *   4.  Except as contained in this notice, the name of The XFree86
+ *       Project, Inc shall not be used in advertising or otherwise to
+ *       promote the sale, use or other dealings in this Software without
+ *       prior written authorization from The XFree86 Project, Inc.
+ *
+ * THIS SOFTWARE IS PROVIDED ``AS IS'' AND ANY EXPRESSED OR IMPLIED
+ * WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
+ * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
+ * IN NO EVENT SHALL THE XFREE86 PROJECT, INC OR ITS CONTRIBUTORS BE
+ * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY,
+ * OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT
+ * OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
+ * BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY,
+ * WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE
+ * OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE,
+ * EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
+ */
 
 #define NEED_EVENTS
@@ -26,7 +72,17 @@
 #define KBC_TIMEOUT 250        /* Timeout in ms for sending to keyboard controller */
 
+#ifndef KBD_DIRECTHW
+#define KBD_DIRECTHW 0
+#endif
+
+#if !(defined(__alpha__) || defined (__i386__) || defined(__ia64__))
+#undef KBD_DIRECTHW
+#define KBD_DIRECTHW 0
+#endif
+
+
 static KbdProtocolRec protocols[] = {
    {"standard", PROT_STD },
-   { NULL, PROT_UNKNOWN }
+   { NULL, PROT_UNKNOWN_KBD }
 };
 
@@ -94,5 +150,6 @@
  * from util-linux-2.9t package */
 
-
+#include <linux/kd.h>
+#include <linux/version.h>
 #ifdef __sparc__
 #include <asm/param.h>
@@ -100,6 +157,13 @@
 #endif
 
+/* Deal with spurious kernel header change */
+#if defined(LINUX_VERSION_CODE) && defined(KERNEL_VERSION)
+# if LINUX_VERSION_CODE >= KERNEL_VERSION(2,5,42)
+#  define rate period
+# endif
+#endif
+
 static int
-KDKBDREP_ioctl_ok(int rate, int delay) {
+KDKBDREP_ioctl_ok(int fd, int rate, int delay) {
 #if defined(KDKBDREP) && !defined(__sparc__)
      /* This ioctl is defined in <linux/kd.h> but is not
@@ -110,5 +174,5 @@
    kbdrep_s.rate = -1;
    kbdrep_s.delay = -1;
-   if (ioctl( 0, KDKBDREP, &kbdrep_s )) {
+   if (ioctl( fd, KDKBDREP, &kbdrep_s )) {
        return 0;
    }
@@ -125,5 +189,5 @@
      kbdrep_s.delay = 1;
    
-   if (ioctl( 0, KDKBDREP, &kbdrep_s )) {
+   if (ioctl( fd, KDKBDREP, &kbdrep_s )) {
      return 0;
    }
@@ -161,11 +225,10 @@
 }
 
+#undef rate
+
 static void
 SetKbdRepeat(InputInfoPtr pInfo, char rad)
 {
   KbdDevPtr pKbd = (KbdDevPtr) pInfo->private;
-  int i;
-  int timeout;
-  int         value = 0x7f;    /* Maximum delay with slowest rate */
 
 #ifdef __sparc__
@@ -175,5 +238,9 @@
   int         rate  = 300;     /* Default rate */
   int         delay = 250;     /* Default delay */
-#endif
+
+# if KBD_DIRECTHW
+  int i;
+  int timeout;
+  int         value = 0x7f;    /* Maximum delay with slowest rate */
 
   static int valid_rates[] = { 300, 267, 240, 218, 200, 185, 171, 160, 150,
@@ -181,8 +248,12 @@
 			       60, 55, 50, 46, 43, 40, 37, 33, 30, 27,
 			       25, 23, 21, 20 };
-#define RATE_COUNT (sizeof( valid_rates ) / sizeof( int ))
+# define RATE_COUNT (sizeof( valid_rates ) / sizeof( int ))
 
   static int valid_delays[] = { 250, 500, 750, 1000 };
-#define DELAY_COUNT (sizeof( valid_delays ) / sizeof( int ))
+# define DELAY_COUNT (sizeof( valid_delays ) / sizeof( int ))
+
+# endif
+
+#endif
 
   if (pKbd->rate >= 0) 
@@ -191,5 +262,5 @@
     delay = pKbd->delay;
 
-  if(KDKBDREP_ioctl_ok(rate, delay)) 	/* m68k? */
+  if(KDKBDREP_ioctl_ok(pInfo->fd, rate, delay)) 	/* m68k? */
     return;
 
@@ -197,9 +268,9 @@
     return;
 
+#if KBD_DIRECTHW
+
   if (xf86IsPc98())
     return;
 
-#if defined(__alpha__) || defined (__i386__) || defined(__ia64__)
-
   /* The ioport way */
 
@@ -232,5 +303,5 @@
   outb(0x60, value);
 
-#endif /* __alpha__ || __i386__ || __ia64__ */
+#endif /* KBD_DIRECTHW */
 }
 
@@ -437,5 +508,5 @@
     KbdDevPtr pKbd = (KbdDevPtr) pInfo->private;
     int i;
-    KbdProtocolId prot = PROT_UNKNOWN;
+    KbdProtocolId prot = PROT_UNKNOWN_KBD;
     char *s;
 
diff -r -U2 xc/programs/Xserver/hw/xfree86/os-support/xf86OSKbd.h xc/programs/Xserver/hw/xfree86/os-support/xf86OSKbd.h
--- xc/programs/Xserver/hw/xfree86/os-support/xf86OSKbd.h	2003-02-17 08:11:55.000000000 -0700
+++ xc/programs/Xserver/hw/xfree86/os-support/xf86OSKbd.h	2003-11-02 22:11:51.000000000 -0700
@@ -1,6 +1,29 @@
-/* $XFree86: xc/programs/Xserver/hw/xfree86/os-support/xf86OSKbd.h,v 1.3 2003/02/17 15:11:55 dawes Exp $ */
-
+/* $XFree86: xc/programs/Xserver/hw/xfree86/os-support/xf86OSKbd.h,v 1.6 2003/11/03 05:11:51 tsi Exp $ */
 /*
- * Copyright (c) 2002 by The XFree86 Project, Inc.
+ * Copyright (c) 2002-2003 by The XFree86 Project, Inc.
+ *
+ * Permission is hereby granted, free of charge, to any person obtaining a
+ * copy of this software and associated documentation files (the "Software"),
+ * to deal in the Software without restriction, including without limitation
+ * the rights to use, copy, modify, merge, publish, distribute, sublicense,
+ * and/or sell copies of the Software, and to permit persons to whom the
+ * Software is furnished to do so, subject to the following conditions:
+ *
+ * The above copyright notice and this permission notice shall be included in
+ * all copies or substantial portions of the Software.
+ *
+ * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
+ * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.  IN NO EVENT SHALL
+ * THE COPYRIGHT HOLDER(S) OR AUTHOR(S) BE LIABLE FOR ANY CLAIM, DAMAGES OR
+ * OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE,
+ * ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
+ * OTHER DEALINGS IN THE SOFTWARE.
+ *
+ * Except as contained in this notice, the name of the copyright holder(s)
+ * and author(s) shall not be used in advertising or otherwise to promote
+ * the sale, use or other dealings in this Software without prior written
+ * authorization from the copyright holder(s) and author(s).
+ *
  * Author: Ivan Pascal.
  */
@@ -82,5 +105,5 @@
     PROT_WSCONS,
     PROT_USB,
-    PROT_UNKNOWN
+    PROT_UNKNOWN_KBD
 } KbdProtocolId;
 
@@ -91,2 +114,20 @@
 
 Bool xf86OSKbdPreInit(InputInfoPtr pInfo);
+
+/* Adjust this when the kbd interface changes. */
+
+/*
+ * History:
+ *
+ *  1.0.0 - Initial version.
+ */
+
+#define OS_KBD_VERSION_MAJOR 1
+#define OS_KBD_VERSION_MINOR 0
+#define OS_KBD_VERSION_PATCH 0
+
+#define OS_KBD_VERSION_CURRENT						\
+	BUILTIN_INTERFACE_VERSION_NUMERIC(OS_KBD_VERSION_MAJOR,		\
+					  OS_KBD_VERSION_MINOR,		\
+					  OS_KBD_VERSION_PATCH)
+
