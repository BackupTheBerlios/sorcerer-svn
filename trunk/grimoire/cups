   VERSION=( "1.1.23" "1.1.23rc1" "1.1.22" "1.1.21" )
      SAFE=( "1.1.23" )
  CATEGORY="printer"
 ATTRIBUTE="console"
#   SOURCE=( "cups/test/cups-$VERSION-source.tar.bz2"
    SOURCE=( "cups/$VERSION/cups-$VERSION-source.tar.bz2"
             "cups/cups-drivers-all-0.3.6.tar.gz" )
  HOMEPAGE="http://www.cups.org"
       URL=( "ftp://ftp.easysw.com/pub
              ftp://ftp.funet.fi/pub/mirrors/ftp.easysw.com/pub
              ftp://ftp.mpg.goe.ni.schule.de/pub/internet/printing
              ftp://ftp.ntua.gr/pub/gnu"
             "$SOURCEFORGE_URL" )
# espgs is needed but can't be placed as a requirement or
# it causes a circuliar requirement loop
       REQ=( "jpeg libpng tiff"
             "openssl:::for secure socket connections"
             "Linux-PAM:::for pluggable authentication support" 
	     ":--disable-serial-backend::to avoid system freeze on some HW" )
      OPTS="--without-rcdir"
   EXCLUDE="/etc/cups/certs"
   PROTECT="/etc/printcap"
  ESTIMATE="400"
      DESC="cups provides a portable printing layer."
   
build() {
  check_for_smb_backend() {
    if    spell_installed  samba;  then  
      echo "Setting smb backend for cups"
      if   !  [ -e                   /usr/lib/cups/backend/smb ];
      then   ln -s /usr/bin/smbspool /usr/lib/cups/backend/smb
      fi
    fi
  }

  disable_serial_backend() {
  # Added by Jan Merka
  # Some computers with kernels >2.6.8.1 freeze when the serial backend
  # is used. Thus, we remove the executable flag:
    if  [ -n "$DISABLE_SERIAL" ];  then
      chmod  a-x  /usr/lib/cups/backend/serial
    fi
  }

  if ( echo $OPTS  |  grep -q "\-\-disable-serial-backend" ) ; then
    OPTS=${OPTS/--disable-serial-backend/}
    DISABLE_SERIAL=1
  fi

  if  spell_installed  Linux-PAM;  then  OPTS="$OPTS  --enable-pam";  fi
  if  spell_installed  openssl;    then  OPTS="$OPTS  --enable-ssl";  fi

  default_build             &&
  cd      drivers           &&
  cp     -R  usr/*  /usr    &&
  cp     -R  var/*  /var    &&
  cd         var/cups/conf  &&
  mkdir  -p  /etc/cups      &&
  cp     *   /etc/cups      &&
  check_for_smb_backend     &&
  disable_serial_backend
}

pre_build() {
  default_pre_build
  unpack  ${SOURCE[0]}  &&
  cd      $BUILD_DIR    &&
  mkdir   drivers       &&
  cd      drivers       &&
  unpack  ${SOURCE[1]}
}
