# espgs is needed but can't be placed as a requirement or
# it causes a circuliar requirement loop
#            'openssl:--enable-ssl:--disable-ssl:for secure socket connections' )

# I wonder why cups 1.3.9 gained a requirement on popt
# since popt is such an old library?

# 1.5.1 breaks compilation of gkt+ and gtk+-3.0
# 1.5.2 fixes the break
# 1.6.1 seems to be newer than some
# gnome-settings-daemon version 3.4.2 and
# gnome-control-center version 3.4.2 can use.

with version   stable 1.5.4 1.5.3 1.6.1
with version unstable 1.6.1
with base    acl libpng mxml openslp popt tiff
#with base    acl libcap libpng openslp popt tiff
with elect   PAM       --enable-pam     --disable-pam     for pluggable authentication
with elect   dbus      --enable-dbus    --disable-dbus    for dbus
#with elect   gnutls    --enable-gnutls  --disable-gnutls  for SSL/TLS by gnutls
with elect   heimdal   ''               ''                for kerberos 5
with elect   openldap  --enable-ldap    --disable-ldap    for LDAP
#with elect   openssl   --enable-openssl --disable-openssl for SSL/TLS by openssl
# Evert reports that firefox crashes during printing if
# openssl is providing SSL/TLS for cups

# cups verson 1.4.7 not compatible with gnutls version 2.12.7
#with base    gnutls
#      with also --disable-openssl --enable-gnutls --without-rcdir

with base    openssl
with also    --enable-openssl --disable-gnutls --without-rcdir

with role    printer
with trait   console library makej multilib-dual
with source  stable \
           http://ftp.easysw.com/pub/ \
            ftp://ftp.funet.fi/pub/mirrors/ftp.easysw.com/pub/ \
            ftp://ftp.mpg.goe.ni.schule.de/pub/internet/printing/ \
            ftp://ftp.ntua.gr/pub/gnu/ \
            cups/${VERSION/*svn*/snapshots}/cups-$VERSION-source.tar.bz2
with source  unstable \
           http://ftp.easysw.com/pub/ \
            ftp://ftp.funet.fi/pub/mirrors/ftp.easysw.com/pub/ \
            ftp://ftp.mpg.goe.ni.schule.de/pub/internet/printing/ \
            ftp://ftp.ntua.gr/pub/gnu/ \
            cups/${VERSION/*svn*/snapshots}/cups-$VERSION-source.tar.bz2
with source  $SOURCEFORGE_URL cups/cups-drivers/0.3.6/cups-drivers-all-0.3.6.tar.gz
with info    last 20120727
with info    home http://www.cups.org/
with info    docs http://www.cups.org/documentation.php
with info    vurl http://www.cups.org/software.php
with omit    /etc/cups/certs
with protect /etc/printcap
with hold    lpr
with info    cite 'portable printing layer'
   
build(){

 check_for_smb_backend(){
  if spell_installed samba; then  
   echo "Setting smb backend for cups"
   mkdir -pvm 755           $DESTDIR/usr/lib/cups/backend/
   ln  -s /usr/bin/smbspool $DESTDIR/usr/lib/cups/backend/smb
  fi
 }

# if spell_installed Linux-PAM; then OPTS+=' --enable-pam'; fi
# if spell_installed openssl;   then OPTS+=' --enable-ssl'; fi

 if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
 then sed -i 's:/lib/security/pam:/lib64/security/pam:' configure
with also    --libdir=/usr/lib64
 else with also --libdir=/usr/lib
 fi

 ./configure              \
  --sysconfdir=/etc        \
  --localstatedir=/var     \
  --prefix=${PREFIX:-/usr} \
 $OPTS &&
 make  &&
 make install "BUILDROOT=$DESTDIR"
 cp     -vR     usr/* $DESTDIR/usr &&
 cp     -vR     var/* $DESTDIR/var &&
 cd             var/cups/conf      &&
 mkdir -pvm 755       $DESTDIR/etc/cups &&
 cp     -v          * $DESTDIR/etc/cups &&
 check_for_smb_backend
}
