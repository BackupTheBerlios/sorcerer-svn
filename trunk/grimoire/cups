# espgs is needed but can't be placed as a requirement or
# it causes a circuliar requirement loop
#            'openssl:--enable-ssl:--disable-ssl:for secure socket connections' )

# I wonder why cups 1.3.9 gained a requirement on popt
# since popt is such an old library?

# 1.5.1 breaks compilation of gkt+ and gtk+-v3
# 1.5.2 fixes the break

   version stable 1.5.2 1.5.1 1.5.0 1.4.7 1.4.6 1.4.5
   version secure 1.4.5
#   version beta   1.5b2 1.5b1
#   version rc     1.5rc1
   require acl libpng mxml openslp popt tiff
#  require acl libcap libpng openslp popt tiff
  optional Linux-PAM --enable-pam     --disable-pam     for pluggable authentication
  optional dbus      --enable-dbus    --disable-dbus    for dbus
# optional gnutls    --enable-gnutls  --disable-gnutls  for SSL/TLS by gnutls
  optional heimdal   ''               ''                for kerberos 5
  optional openldap  --enable-ldap    --disable-ldap    for LDAP
# optional openssl   --enable-openssl --disable-openssl for SSL/TLS by openssl
# Evert reports that firefox crashes during printing if
# openssl is providing SSL/TLS for cups

# cups verson 1.4.7 not compatible with gnutls version 2.12.7
#   require gnutls
#      opts --disable-openssl --enable-gnutls --without-rcdir

   require openssl
      opts --enable-openssl --disable-gnutls --without-rcdir

  category printer
 attribute console library makej multilib-dual
    source http://ftp.easysw.com/pub/ \
            ftp://ftp.funet.fi/pub/mirrors/ftp.easysw.com/pub/ \
            ftp://ftp.mpg.goe.ni.schule.de/pub/internet/printing/ \
            ftp://ftp.ntua.gr/pub/gnu/ \
            cups/${VERSION/*svn*/snapshots}/cups-$VERSION-source.tar.bz2
    source $SOURCEFORGE_URL cups/cups-drivers/0.3.6/cups-drivers-all-0.3.6.tar.gz
      info last 20120103
      info home http://www.cups.org/
      info docs http://www.cups.org/documentation.php
      vurl http://www.cups.org/software.php
   exclude /etc/cups/certs
   protect /etc/printcap
  eprovide lpr
      desc 'portable printing layer'
   
build(){

 check_for_smb_backend(){
  if spell_installed samba; then  
   echo "Setting smb backend for cups"
   mkdir -p                 $DESTDIR/usr/lib/cups/backend/
   ln  -s /usr/bin/smbspool $DESTDIR/usr/lib/cups/backend/smb
  fi
 }

# if spell_installed Linux-PAM; then OPTS+=' --enable-pam'; fi
# if spell_installed openssl;   then OPTS+=' --enable-ssl'; fi

 if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
 then sed -i 's:/lib/security/pam:/lib64/security/pam:' configure
      opts --libdir=/usr/lib64
 else opts --libdir=/usr/lib
 fi

 ./configure              \
  --sysconfdir=/etc        \
  --localstatedir=/var     \
  --prefix=${PREFIX:-/usr} \
 $OPTS &&
 make  &&
 make install "BUILDROOT=$DESTDIR"
 cp     -vR     usr/* $DESTDIR/usr &&
 cp     -vR     var/* $DESTDIR/var &&
 cd             var/cups/conf      &&
 mkdir -pvm 755       $DESTDIR/etc/cups  &&
 cp     -v          * $DESTDIR/etc/cups  &&
 check_for_smb_backend
}
