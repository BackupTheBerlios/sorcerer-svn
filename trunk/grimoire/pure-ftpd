   VERSION=( "1.0.20" "1.0.19" "1.0.18" )
      SAFE=( "1.0.20" "1.0.19" )
    IGNORE="^1\.1\."
  CATEGORY="ftp"
 ATTRIBUTE="server console"
    SOURCE="pure-ftpd-$VERSION.tar.bz2"
       URL="ftp://ftp.pureftpd.org/pub/pure-ftpd/releases"
  HOMEPAGE="http://www.pureftpd.org"
  EPROVIDE="ftpd"
       REQ=( ""
             "Linux-PAM:::"
             "xinetd:::for running server"
             "mysql:--with-mysql:--without-mysql:for MySQL user authnetication"
             "openldap:::for light weight directory access protocol support"
             "postgresql:--with-pgsql:--without-pgsql:for postgres user authentication"
             "openssl:--with-tls:--without-tls:enable FTP through SSL" )
   PROTECT="/etc/pureftpd.passwd
            /etc/pureftpd.pdb"
  ESTIMATE="128"
      DESC="pure-ftpd is an efficient, lightweight, and secure FTP server.

pure-ftpd is a fast, production quality, 
standards-conformant FTP server based on Troll-FTPd.
It has no known buffer overflows, is trivial to set up, 
and is especially designed for modern kernels.
Features include PAM support, IPv6, chroot()ed home directories, 
virtual domains, built-in 'ls', FXP protocol, anti-warez system,
bandwidth throttling, bounded ports for passive downloads, 
an LDAP backend, XML output, and more.

The openssl --with-tls option requires the
/etc/ssl/private/pure-ftpd.pem
certificate to be installed."

configure() {
	if  !  grep  -q  "FTPD_BOOT="  $SPELL_CONFIG  &&
		!  grep  -q  "xinetd"      $SPELL_CONFIG
	then

		if    query  "Invoke pureftpd during boot? "  n
		then  echo   "FTPD_BOOT=true"   >>  $SPELL_CONFIG
		else  echo   "FTPD_BOOT=false"  >>  $SPELL_CONFIG
		fi

	fi
}

build() {
	install_conf()  {

		install  -m 0644  -o root  -g root  pam/ftpusers              /etc
		install  -m 0755  -o root  -g root  $SCRIPT_DIR/pure-ftpd.sh  /etc/init.d

		if  $FTPD_BOOT;  then
			ln  -sf  ../init.d/pure-ftpd.sh  /etc/rc0.d/K10pure-ftpd
			ln  -sf  ../init.d/pure-ftpd.sh  /etc/rc1.d/K10pure-ftpd
			ln  -sf  ../init.d/pure-ftpd.sh  /etc/rc2.d/K10pure-ftpd
			ln  -sf  ../init.d/pure-ftpd.sh  /etc/rc6.d/K10pure-ftpd

			ln  -sf  ../init.d/pure-ftpd.sh  /etc/rc3.d/S90pure-ftpd
			ln  -sf  ../init.d/pure-ftpd.sh  /etc/rc4.d/S90pure-ftpd
			ln  -sf  ../init.d/pure-ftpd.sh  /etc/rc5.d/S90pure-ftpd
		fi

	}


	install_contrib()  {

		cp  -rv  contrib  /usr/share/pure-ftpd

	}


	if  spell_installed  Linux-PAM  ||
		spell_held       Linux-PAM
	then  WITH_PAM="--with-pam"
	fi


	./configure  --sysconfdir=/etc     \
	             --prefix=/usr         \
							 --with-largefile      \
							 --with-everything     \
							 --without-banner      \
							 --with-virtualchroot  \
							 $WITH_PAM             \
							 $OPTS                 &&
	make                               &&
	prepare_install                    &&
	make    install                    &&
	install_conf               &&
	install_contrib
}

post_install() {
	default_post_install
	if    !  [  -f  /etc/xinetd.d/pure-ftpd   ]  &&
		[  -x  /etc/init.d/pure-ftpd.sh  ]
	then            /etc/init.d/pure-ftpd.sh  start
	fi
	true
}

pre_remove() {
	default_pre_remove
	if    [  -x  /etc/init.d/pure-ftpd.sh  ]
	then         /etc/init.d/pure-ftpd.sh  stop
	fi
	true
}

