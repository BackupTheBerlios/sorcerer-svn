    stable event-20110106-0 event-20101230-0 event-20101228-0
   require grimoire
  category utility
 attribute archive_off solo sorcery
  homepage http://sorcerer.silverice.org/
    source http://sorcerer.silverice.org/download/sorcery/sorcery-$VERSION.tar.xz

# Should /var/cache and /var/spool be excluded?
# They used to be but that caused missing directories for cups and hal

   exclude /dev
   exclude /etc/sorcery/local.config
   exclude /home
   exclude /proc
   exclude /root
   exclude /tmp
   exclude /usr/src/sorcery
   exclude /var/lock
   exclude /var/log/sorcery/snap
   exclude /var/run
   exclude /var/state
   exclude /var/tmp
   exclude $VOG_DIR
  volatile /etc/sorcery/config
   protect /etc/sorcery/config
   protect /etc/sorcery/dialogrc
   protect /usr/libexec/sorcery/augur
   protect /usr/libexec/sorcery/cast
   protect /usr/libexec/sorcery/dispel
   protect /usr/libexec/sorcery/leech
   protect /usr/libexec/sorcery/share
   protect /usr/libexec/sorcery/sorcery
   protect /usr/sbin/augur
   protect /usr/sbin/cast
   protect /usr/sbin/dispel
   protect /usr/sbin/leech
   protect /usr/sbin/sorcery
   protect /var/cache
   protect /var/spool
      desc 'sorcery contains source management tools.
augur   - provides detailed information about the box
cast    - installs spells
dispel  - removes installed spells
leech   - downloads sources for spells
sorcery - menu driven source manager'

build(){
 if [ -z   "$DESTDIR" ] ||
    [      "$DESTDIR" == "$META_DIR/$SPELL.install" ]
 then prepare_install; export DESTDIR=/
 fi

 DESTDIR=$DESTDIR ./install $VERSION
}


post_install(){

 fix_gconf(){
  if   [ -f                $PROVIDE_LOGS/GConf ] &&
       grep -qx GConf-dbus $PROVIDE_LOGS/GConf
  then rm   -f             $PROVIDE_LOGS/GConf
  fi
 }

 discard_old_index(){
  merge_grimoires
  generate_index   
 }

 discard_obsolete_event_logs(){
  case $VERSION in
   event*) find ${EVENT_LOGS:-/var/log/sorcery/event} -mindepth 1 -type d |
           escape_qs | xargs -r --max-lines=16 rm -r ;;
  esac
 }

 add_config_site(){
  if   ! spell_installed config.site
  then echo config.site | pipe_queue $CAST_QUEUE com
  fi
 }

 . /etc/sorcery/config

 fix_gconf
 add_config_site
 discard_old_index
 discard_obsolete_event_logs
 default_post_install
}
