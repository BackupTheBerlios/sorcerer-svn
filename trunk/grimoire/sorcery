   VERSION=( implosion-20080209-1 implosion-20080208-4 implosion-20080207-0 implosion-20080206-0 implosion-20080205-6 implosion-20080204-0 implosion-20080203-0 implosion-20080202-1 implosion-20080201-1 implosion-20080131-0 implosion-20080130-0 implosion-20080128-0 implosion-20080127-5 implosion-20080125-0 implosion-20080124-1 implosion-20080124-0 implosion-20080122-2 implosion-20080121-1 implosion-20080119-0 implosion-20080117-0 implosion-20080114-1 implosion-20080112-0 implosion-20080109-1 )
  CATEGORY='utility'
 ATTRIBUTE='archive_off solo sorcery'
    SOURCE="sorcery-$VERSION.tar.bz2"
  HOMEPAGE='http://sorcerer.silverice.org/'
       URL='http://sorcerer.silverice.org/download/sorcery/'
       REQ=( 'bash bzip2 ccache curl dialog diffutils file findutils gcc grep grimoire gzip init-scripts less make mktemp p7zip patch procps rpmunpack sorcery-sentinel tar which'
             'sdelta3:::for downloading tiny source tarball patches'
             'sorcery-alien:::for monthly tracking of installed alien files'
             'sorcery-backup:::for monthly filesystem backup'
             'sorcery-bgz:::for background compression of tarballs'
             'sorcery-bootblaze:::for faster booting and login'
             'sorcery-defrag:::for monthly file defragment'
             'sorcery-immune:::for an immune system'
             'sorcery-md5sum:::for weekly md5sum check of installed files' )
   EXCLUDE='/etc/sorcery/local.config
            /home
            /proc
            /root
            /tmp
            /usr/src/sorcery
            /var/cache
            /var/lock
            /var/run
            /var/spool
            /var/state
            /var/tmp'
   PROTECT='/dev
            /etc/sorcery/config
            /etc/sorcery/dialogrc
            /etc/sorcery/log/history
            /etc/sorcery/log/snap
            /usr/libexec/sorcery/augur
            /usr/libexec/sorcery/cast
            /usr/libexec/sorcery/dispel
            /usr/libexec/sorcery/leech
            /usr/libexec/sorcery/share
            /usr/libexec/sorcery/sorcery
            /usr/sbin/augur
            /usr/sbin/cast
            /usr/sbin/dispel
            /usr/sbin/leech
            /usr/sbin/sorcery'
  ESTIMATE='20'
      DESC='sorcery contains source management tools.
augur   - provides detailed information about the box
cast    - installs spells
dispel  - removes installed spells
leech   - downloads sources for spells
sorcery - menu driven source manager'

build(){
 [  -x   install ] &&
 prepare_install   &&
 ./install $VERSION
}


post_install(){

 linux_headers_check(){
  if    ! [ -f /usr/include/asm-generic/errno.h  ]; then
   echo      'Attempting to install some missing linux headers'
   leech -w  glibc
   cd        $( untar $SOURCE_CACHE/glibc/*/linux-*.tar* )/linux* &&
   make      include/linux/version.h &&
   make      include/asm &&
   cp    -rL include/{asm,asm-generic,linux}  /usr/include
  fi
 }

 fix_provide_logs(){
  ( find $PROVIDE_LOGS -maxdepth 1 -mindepth 1 -type f -empty
    find $PROVIDE_LOGS -maxdepth 1 -mindepth 1 -type f -size 1c
    find $PROVIDE_LOGS -maxdepth 1 -mindepth 1 -type f | grep ','
  ) | xargs --max-lines=64 rm -f
 }

 fix_fstab(){
  if grep  -q "/root/.sorcery.*size=32m"         /etc/fstab; then
   sed -ir "s:(/root/.sorcery.*size=)32m:\164m:" /etc/fstab
   mount -o remount /root/.sorcery
   true
  fi
 }

 missing_init-script(){
  find  $VERSION_LOGS -type f -printf '%f\n' |
  while read
  do    [ -d $GRIMOIRE/$REPLY.d/init.d.on ] &&
        find $GRIMOIRE/$REPLY.d/init.d.on -type f -printf '%f\n'
  done  |
  while read
  do    [ -f /etc/init.d/$REPLY ] || echo "$REPLY"
  done  |
  while read
  do    find $GRIMOIRE/*.d/init.d.on/$REPLY -type f
  done  |
  sed   "s:$GRIMOIRE/::;s:\.d/.*::" |
  pipe_queue $CAST_QUEUE com
 }

 fix_pam_d(){
  if   [ -d       /etc/pam.d ]
  then chmod 0644 /etc/pam.d/*
  fi
 }

 fix_ld_so_conf(){
  if   grep -q    /opt/gcc/    /etc/ld.so.conf
  then sed  -i '\,/opt/gcc/,d' /etc/ld.so.conf
  fi
 }

 rm -fr /etc/sorcery/log/stat $INDEX_DIR/spell $SOURCE_CACHE/ALL
 rm -f  $PROVIDE_LOGS/poppler
 chmod 0700 ${LOG_DIR:-/etc/sorcery/log} /etc/init.d
 fix_pam_d
 fix_provide_logs
 linux_headers_check
 fix_fstab
 fix_ld_so_conf
 missing_init-script
 default_post_install
}
