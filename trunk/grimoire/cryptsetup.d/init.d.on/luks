#!/bin/bash

### BEGIN INIT INFO
# Provides: luks
# Required-Start: dmsetup
# Should-Start: udev vgchange
# Required-Stop: halt reboot
# Default-Start: S
# Default-Stop: 0 6
# Short-Description: luks finds luks encrypted devices and maps them to /dev/mapper/
### END INIT INFO

. /lib/lsb/init-functions

NAME=luks

start(){
     swap(){ [ "$1" == swap ]; }
 not_swap(){ ! swap "$@"; }

 map(){
  while read DEV MNT TYP JNK; do
   if [ "${DEV:0:12}" == /dev/mapper/ ] && $1 $TYP
   then echo "${DEV##*/}"
   fi
  done
 }

 password(){
  dialog \
   --backtitle luks --stdout --no-cancel --timeout 60 \
   --title "Device Password Menu" \
   --passwordbox "Password for $1?" 0 0
 }

 run(){
  local 
  for DEV in $( sed '/noauto/d' /etc/fstab | map not_swap ); do
   cryptsetup isLuks   /dev/$DEV && password |
   cryptsetup luksOpen /dev/$DEV $DEV
  done
  for DEV in $( sed '/noauto/d' /etc/fstab | map swap ); do
   if cryptsetup isLuks /dev/$DEV; then
    KEY="$RANDOM$RANDOM$RANDOM$RANDOM$RANDOM$RANDOM$RANDOM$RANDOM$RANDOM$RANDOM$RANDOM"
    echo "$KEY" | cryptsetup luksFormat /dev/$DEV
    echo "$KEY" | cryptsetup luksOpen   /dev/$DEV $DEV
    mkswap /dev/mapper/$DEV
   fi &>/dev/null
  done
 }

 log_warning_msg "$NAME checking for luks devices"; run # <> /dev/console
 log_success_msg "$NAME luks mappings created"
}


stop(){
 log_warning_msg "$NAME closing luks devices"
 find /dev/mapper -type b |
 while read
 do cryptsetup luksClose ${REPLY##*/}
 done
 log_success_msg "$NAME luks devices closed."
}

try_restart(){ :; }

parse "$@"
