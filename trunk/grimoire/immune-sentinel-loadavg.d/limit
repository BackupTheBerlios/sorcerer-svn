#!/bin/bash
# Copyright 2012 by Kyle Sallee, All rights reserved.
# For use with Sorcerer
# limit is able to delay the start of gcc during high loads.

PROG="${0##*/}"

[ -f /etc/init.d/conf.d/sentinel-loadavg ] &&
   . /etc/init.d/conf.d/sentinel-loadavg
LIMIT="${LIMIT:-4}"
export PATH="${PATH/\/usr\/libexec\/sentinel-loadavg:/}"

read < /proc/loadavg
LOAD="${REPLY%%\.*}"

if (( LIMIT >= LOAD )); then exec $PROG "$@"; fi

enable -f /usr/libexec/bash/sleep sleep
sleep 0.025

while (( 300 > SECONDS )); do
 read < /proc/loadavg
 LOAD="${REPLY%%\.*}"
 if   (( LIMIT >= LOAD ))
 then exec  $PROG "$@"
 else sleep 0.025
 fi
done

exec $PROG "$@"
