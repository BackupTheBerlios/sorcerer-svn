   VERSION=( "1.7.12" "1.7.11" "1.7.10" "1.7.8" "1.7.7" )
      SAFE=( "1.7.12" )
  CATEGORY="web encryption"
 ATTRIBUTE="client solo x11"
    SOURCE="mozilla-$VERSION-source.tar.bz2"
  HOMEPAGE="http://www.mozilla.org"
       URL="ftp://ftp.mozilla.org/pub/mozilla.org/mozilla/releases/mozilla${VERSION}/source"
       REQ="gss gtk+ heimdal jpeg libIDL libpng libmng perl zip zlib"
  ESTIMATE="21378"
      DESC="mozilla is a popular graphical World Wide Web browser."

case  $VERSION  in
  1.7.12)  REQ="gcc-v3.4 gss gtk+ heimdal jpeg libIDL libpng libmng perl zip zlib"  ;;
esac


configure() {
if  !  grep  -q  "FULL_INSTALL"  $SPELL_CONFIG
then

  if    query  "Install complete mozilla? " y
  then  echo   "FULL_INSTALL=true"   >>  $SPELL_CONFIG
  else  echo   "FULL_INSTALL=false"  >>  $SPELL_CONFIG 
    
    if    query  "Install mail/news?" y
      then  echo   "MAIL_NEWS=true"   >>  $SPELL_CONFIG
      else  echo   "MAIL_NEWS=false"  >>  $SPELL_CONFIG
    fi
    
    if    query  "Install composer?" y
      then  echo   "COMPOSER=true"   >>  $SPELL_CONFIG
      else  echo   "COMPOSER=false"  >>  $SPELL_CONFIG
    fi
    
    if    query  "Install chatzilla (irc client)?" y
      then  echo   "CHATZILLA=true"   >>  $SPELL_CONFIG
      else  echo   "CHATZILLA=false"  >>  $SPELL_CONFIG
    fi
  fi

fi
}

build() {

case  $VERSION  in
  1.7.12)  GCC3_VER=$( installed_version gcc-v3.4 )
           export  PATH="${PATH/gcc\/current/gcc/$GCC3_VER}"
           export  CCACHE_PATH="/opt/gcc/$GCC3_VER/bin"  ;;
esac


check_space()  {
 KILOBYTES=$(
 df    -Pkm  $SOURCE_DIR  |
 tr    -s ' '             |
 tail  -n 1               |
 cut   -d ' '  -f4
 )
 if    ((  KILOBYTES < 1152  ));  then
  echo  "Insufficient disk space available for compiling mozilla."
  false
 fi
}

install_symlinks()  {

 rm  -rf                                   /usr/include/mozilla
 ln  -sf    /usr/include/mozilla-$VERSION  /usr/include/mozilla

 rm  -rf                                   /usr/lib/mozilla
 ln  -sf        /usr/lib/mozilla-$VERSION  /usr/lib/mozilla

 rm  -rf                                   /usr/share/idl/mozilla
 ln  -sf  /usr/share/idl/mozilla-$VERSION  /usr/share/idl/mozilla

}


fix_config()  {
 sed  -i  "s:/usr/lib/mozilla-[^ ]*:/usr/lib/mozilla:g"  /usr/bin/mozilla-config
}

# mozilla doesn't install nss headers by default
# so we do it manually :^)
install_security()  {
 NSS_DIR=/usr/include/mozilla-$VERSION/nss 
 mkdir  -p  $NSS_DIR
 for  dir  in  private  public;  do
  cp  -f  $BUILD_DIR/dist/${dir}/nss/*.h \
  $NSS_DIR
 done
}


  IVERSION=$(  installed_version  $BSPELL  )

  # already-running patch for running multiple
  # instances of mozilla without -remote option.
  bzip2  -cd  $SCRIPT_DIR/already-running.patch.bz2  |  patch -p1

  export    CFLAGS="${CFLAGS/-ffast-math/}"
  export  CXXFLAGS="${CXXFLAGS/-ffast-math/}"
  export    CFLAGS="${CFLAGS/-fomit-frame-pointer/}"
  export  CXXFLAGS="${CXXFLAGS/-fomit-frame-pointer/}"

  export  MOZILLA_OFFICIAL=1
  export  BUILD_OFFICIAL=1

  # The following 2 lines stopped working with mozilla 1.4.1
  # the source came without the internal libart library.
  # export  MOZ_INTERNAL_LIBART_LGPL=1
  # ac_add_options --enable-svg

cat  <<  EOF  >  .mozconfig
ac_add_options --prefix=/usr
ac_add_options --enable-shared
ac_add_options --disable-static
ac_add_options --with-system-jpeg
ac_add_options --with-system-zlib
ac_add_options --with-system-png
ac_add_options --with-system-mng
ac_add_options --enable-crypto
ac_add_options --enable-xinerama
ac_add_options --disable-tests
ac_add_options --disable-debug
ac_add_options --enable-optimize="$CFLAGS"
ac_add_options --enable-reorder
ac_add_options --enable-strip
ac_add_options --enable-elf-dynstr-gc
ac_add_options --enable-cpp-rtti
ac_add_options --enable-xterm-updates
ac_add_options --enable-toolkit-gtk2
ac_add_options --enable-default-toolkit=gtk2
ac_add_options --enable-old-abi-compat-wrappers
ac_add_options --enable-xft
ac_add_options --disable-freetype2
ac_add_options --disable-gnomevfs
EOF

  # mail/news support
  if  ! $MAIL_NEWS;  then
    echo "ac_add_options --disable-mailnews" >> .mozconfig
  fi   

  # composer support
  if  ! $COMPOSER;  then
    echo "ac_add_options --disable-composer" >> .mozconfig
  fi

  # chatzilla support
  if  ! $CHATZILLA;  then
    echo 'ac_add_options --enable-extensions="default,-irc"' >> .mozconfig
  fi  

  export  LDFLAGS="-Wl,-rpath,/usr/lib/mozilla-$VERSION  $LDFLAGS"
  grep   -rl             "\-Wl,-soname" * |
  xargs  -l64  sed  -i  "s:-Wl,-soname:-Wl,-rpath,/usr/lib/mozilla-$VERSION -Wl,-soname:"

  check_space         &&
  ./configure  $OPTS  &&
  make                &&
  prepare_install     &&
  make    install     &&
  install_security    &&
  install_symlinks    &&
  fix_config
}


post_install() {

  recast()  {
    if       spell_installed  $1  &&
          !  spell_held       $1
    then     cast  -c         $1
    fi
  }

  default_post_install

  if  !  [  "$IVERSION"  ==  "$VERSION"  ];  then
    unlock_cast
    recast  acroread
    recast  j2sdk
    recast  mozplugger
    recast  flashplugin
  fi
}
