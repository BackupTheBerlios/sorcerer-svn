# With version 4.4.3 copyright transferred to Nokia Corporation.
# qt on phones?  Hmm, I wonder...

# qt-x11-opensource 4.4.2 is available.
# From freshmeat release announcement:
# "The KDE Phonon multimedia framework is now used."
# That may be a problem if it qt-x11-opensource
# can not be compiled without phonon support
# since kde* version 4.* spells provide phonon support.
# Also phonon upport for qt-x11-opensource creates some annoying
# recursive requirements.

# akonadi requires qt-x11-opensource with mysql server support

    stable 4.5.2 4.5.0 4.4.3 4.4.1 4.4.0 4.3.5 4.3.4
    secure       4.4.0
   require dbus glib fontconfig kde-symlinks-v4 libXcursor libXinerama libXrandr libmng libpng mysql sqlite tiff
  optional cups        -cups -no-cups                for common unix printing support
  optional postgresql  ''    -no-sql-psql            for postgresql support
  optional sqlite-v2.8 ''    -no-sql-sqlite2         for old sqlite support
  optional unixODBC    ''    -no-sql-odbc            for connecting to windows database
  category graphic/library
 attribute library kde4 solo
    source ftp://ftp.trolltech.com/qt/source/qt-x11-opensource-src-$VERSION.tar.bz2
  homepage http://www.trolltech.com/developer/downloads/qt/x11
      opts -fontconfig -no-phonon -plugin-sql-mysql -xmlpatterns -exceptions
#     opts -fontconfig -phonon
  eprovide qt-x11-opensource-desktop
 freshmeat qt
  estimate 8000
      desc 'qt-x11-opensource simplifies the task of writing and maintaining GUI applications.'

build(){

 add_rpath_to_la(){
  sed -i  's:-L/opt/kde4/lib:-L/opt/kde4/lib -R/opt/kde4/lib:
           s:-L/opt/kde4/lib64:-L/opt/kde4/lib64 -R/opt/kde4/lib64:' \
      $( find /opt/kde4/ -name libQt\*.la )
 }

 rm -rf demos examples

 export   CFLAGS+=' -fPIC'
 export CXXFLAGS+=' -fPIC'

 flags(){
  while [[ -n $1 ]]; do
   sed -n '/^flags/p' /proc/cpuinfo | grep -qw "$1" || OPTS+=" -no-$1"
   shift
  done
 }

 if   [[ i586 == $HOSTTYPE ]] && [[ -d /boot/isolinux ]]
 then OPTS+=' -no-mmx -no-3dnow -no-sse -no-sse2'
 else
  case $HOSTTYPE in
   i?86) flags mmx 3dnow sse sse2 ;;
  esac
 fi

 PREFIX=/opt/kde4

# case  $HOSTTYPE  in
#  x86_64) LIBS=lib64 ;;
#       *) LIBS=lib   ;;
# esac
#-headerdir /usr/include/qt4 \
#-bindir /usr/bin \
#-libdir /usr/$LIBS \

 mkdir lib
 echo -e "o\nyes" |
 ./configure      \
 -v               \
 -fast            \
 -release         \
 -shared          \
 -optimized-qmake \
 -system-libmng   \
 -system-libjpeg  \
 -system-libpng   \
 -system-libtiff  \
 -system-sqlite   \
 -system-zlib     \
 -qt3support      \
 -qt-gif          \
 -xinerama        \
 -no-exceptions   \
 -nomake demos    \
 -nomake examples \
 -prefix $PREFIX  \
 -reduce-relocations \
 -no-separate-debug-info \
 $OPTS &&
 make  &&
 prepare_install &&
 make    install &&
 add_rpath_to_la

# &&
# ln -s ../../include/qt4 ${QT4_PREFIX}/include &&
# ln -s ../../bin         ${QT4_PREFIX}/bin &&
# ln -s ../../$LIBS       ${QT4_PREFIX}/lib
}

post_install(){
 default_post_install
 if   [[ -s                         $VERSION_LOGS/avahi ]] &&
      [[ -s                         $OPT_OFF_LOGS/avahi ]] &&
      grep -qx qt-x11-opensource    $OPT_OFF_LOGS/avahi
 then sed  -i /qt-x11-opensource/d  $OPT_OFF_LOGS/avahi
      echo     qt-x11-opensource >>  $OPT_ON_LOGS/avahi
      echo avahi | pipe_queue $CAST_QUEUE com
 fi
}
