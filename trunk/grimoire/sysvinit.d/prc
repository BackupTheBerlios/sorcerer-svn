#!/bin/bash
trap : INT QUIT TSTP
export PATH=/sbin:/bin:/usr/sbin:/usr/bin
umask 022

parallel() {
 for ((SEQ=0;SEQ<10;SEQ++)); do
  for SCRIPT in /etc/rc.d/rc${RL}.d/$1${SEQ}*; do
   if   [ -f "$SCRIPT" ] && 
        [ -x "$SCRIPT" ]
   then       $SCRIPT $2 &
   fi
  done
  wait
 done
}

linear() {
 for SCRIPT in /etc/rc.d/rc${RL}.d/${1}*; do
  if   [ -f "$SCRIPT" ] && 
       [ -x "$SCRIPT" ]
  then       $SCRIPT $2
  fi
 done
}

ssp() { parallel K stop; parallel S start; }
ssl() { linear   K stop; linear   S start; }
log() { $1; echo End runlevel $RL; }

 RL=$1
RLL=/etc/init.d/log/runlevel.$RL.log
RLC=/etc/init.d/dev/rl

case $RL in
   6|0) ssl ;;
 3|5|1) log ssl 2>&1 | tee $RLL > $RLC & ;;
   2|4) log ssp 2>&1 | tee $RLL > $RLC & ;;
esac
