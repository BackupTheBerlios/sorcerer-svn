#!/bin/bash

### BEGIN INIT INFO
# Provides: find_ir
# Required-Start:
# Should-Start: udev loadkeys
# Required-Stop:
# Default-Start: S
# Default-Stop:
# Short-Description: find_ir locates and makes the Sorcerer IR / in /etc/fstab
### END INIT INFO

. /lib/lsb/init-functions

start(){
 block(){ while read; do if [ -b "$REPLY" ]; then echo "$REPLY"; fi; done; }
   try(){ while read  &&  mtest  "$REPLY"; do :; done; }

 try_mount(){
  local CX=12
  while (( CX > 0 )); do
   (( CX-- ))
   if   mount -nr "$1" /media/root
   then return
   else umount -n /media/root; sleep 5; false
   fi
  done
 }

 mtest(){
  if    try_mount "$1"; then
   if   ! [    -d /media/root/boot/isolinux ]
   then umount -n /media/root; return 1
   else umount -n /media/root; echo  "$1"
   fi
  else return 1
  fi
 }

 search(){
  mkdir -p   /media/root
  grep  -l 1 /sys/block/*/removable    |
  sed        's:/sys/block/:/dev/:
                       s:/removable::' |
  block                                |
  try
 }

 manual(){
  echo "Install/Rescue Image not found."
  echo "Discover the block device for"
  echo "the Install/Rescue Image and"
  echo "make that the root device"
  echo "by editing /etc/fstab"
  echo "Sorry for the inconvenience."
  echo "Press enter when prompted for password."
  echo "When complete type exit to resume"
  sulogin -t 300 /dev/console  &>/dev/console  0</dev/console
 }

 set_root(){
  sed  -i 's:\t: :g; \, / ,d'            /etc/fstab
  echo    "$1 / auto defaults,ro 0 0" >> /etc/fstab
 }

 on_ir(){ grep -q boot=IR /proc/cmdline; }

 if ! on_ir; then return; fi

 log_warning_msg "Sorcerer Install/Rescue Image finding"

 if              IRDEV=$( search )
 then set_root "$IRDEV";     log_success_msg "Install/Rescue CD found"
 else manual &>/dev/console; log_failure_msg "Install/Rescue CD not found"
 fi
}


help(){ echo "Usage: $0 {start}" 1>&2; }

case $1 in
 start) start ;;
 try-restart) ;;
 *) help ;;
esac
