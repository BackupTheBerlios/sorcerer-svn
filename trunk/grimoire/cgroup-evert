# Copyright Kyle Sallee 2011 through 2012
# All rights reserved.
# For use with the distribution sorcerer only!
# Additional notes are at the bottom of the spell.

   version stable 20120808
   require init-functions-evert
  category administration/boot
 attribute archive_off console solo
 attribute broke
      info last 20120808
      info home http://sorcerer.silverice.org
  eprovide cgroup
      desc 'cgroup setup utility
cgroup provides init-script /etc/init.d/cgroup
that mounts a cgroup file system on /sys/fs/cgroup
It also creates the top level cgroup directories.
And it sets values within those cgroups which
may be default or SA defined.

This implementation differs from the Sorcerer default.
This implementation was implemented by Kyle.
This implementation was designed by Evert
for use only on his dual core laptop.
It may be unsuitable or allow problems to occur
when used on other boxes.

All user owned processes run in
/sys/fs/cgroup/tasks
The "nice" program is used to schedule
disproportional allocation of processing power.

Processes started by init-scripts
each receive their own control group
/sys/fs/cgroup/$SERVICE

To prevent starvation of X started by kdm, for example,
the SA must issue the command
# echo $LARGE_VALUE > /sys/fs/cgroup/kdm/cpu.shares
where $LARGE_VALUE is a sufficiently large value.
A similar variation is required if X is started by gdm or xdm.
If X is started by the user then the SA
could attempt to use the "nice" command
instead of creating a control group
and moving the pid of X into the new control group
and adjusting the cpu.shares of the new control group.
Evert recommended 2048 shares
which is automatically implemented as a default for
/sys/fs/cgroup/kdm/cpu.shares

This implementation can not enforce
fair processing power usage among users.
Any user can starve the X server
by concurrently running hungry processes.'

build(){
 mkdir -pvm 700 $DESTDIR/etc/cgroup
 find      $SCRIPT_DIR/etc -mindepth 1 -printf "%P\n" |
 tar  -C   $SCRIPT_DIR/etc --exclude-vcs --no-recursion -cPT - |
 tar  -C   $DESTDIR/etc -pxf -
 find      $DESTDIR/etc -type f | xargs -r --max-lines=64 chmod 644
 find      $DESTDIR/etc -type d | xargs -r --max-lines=64 chmod 755
 chmod 700 $DESTDIR/etc/cgroup

 mkdir -pvm 755             $DESTDIR/sbin
 for REPLY in            $SCRIPT_DIR/sbin/*
 do  install -vm 755 $REPLY $DESTDIR/sbin/
 done

 mkdir -pvm 755             $DESTDIR/usr/bin
 for REPLY in                $SCRIPT_DIR/bin/*
 do  install -vm 755 $REPLY $DESTDIR/usr/bin/
 done

 mkdir -pvm 755             $DESTDIR/lib/cgroup
 for REPLY in            $SCRIPT_DIR/lib/cgroup/*
 do  install -vm 755 $REPLY $DESTDIR/lib/cgroup/
 done
}
