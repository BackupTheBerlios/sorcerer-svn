   inherit linux
   require initramfs module-init-tools
  estimate 14000
      desc 'linux-modular provides a modular plug and pray linux kernel.
cast linux instead to create an efficient custom configured performance kernel.
Expect linux-modular to require 600M in /usr/src/linux for ia32 architecture'

unset -f configure current

configure() { :; }

build(){
 backup_modules(){
  if [ -d  /lib/modules/$VERSION ]; then
  rm   -rf /lib/modules/$VERSION.old
  cp   -a  /lib/modules/$VERSION \
           /lib/modules/$VERSION.old
  fi
 }

 install_kernel(){
  SM="System.map"
  BV="${VERSION}"
  BZ=$( find . -type f -name bzImage )

  rm    -rf               /boot/$BV
  mkdir -p                /boot/$BV
  cp       $BZ            /boot/$BV/linux
  chmod 600               /boot/$BV/linux
  cp           System.map /boot/$BV
  rm    -f                /boot/System.map
  ln    -s $BV/System.map /boot/System.map
 }

 install_header(){
  mkdir   -vm 755 -p                                    /usr/include/{asm,linux}
  install -vm 644 include/asm/asm-offsets.h             /usr/include/asm
  install -vm 644 include/linux/{autoconf.h,compile.h}  /usr/include/linux
  true
 }

 restore_linux_configs(){
  local NOSMP

  if   ! LC_ALL=C grep -q 'processor.*1' /proc/cpuinfo
  then NOSMP=-nosmp
  fi

  if   [ -d /boot/isolinux ]
  then local MAC="$HOSTTYPE"; NOSMP=
  else local MAC="$( uname -m )"
  fi

  if   [ "$MAC" == x86_64 ]
  then NOSMP=
  fi

  if   [ -f            $SCRIPT_DIR/$MAC-$VERSION$NOSMP ]
  then install -vm 600 $SCRIPT_DIR/$MAC-$VERSION$NOSMP .config
  else install -vm 600 $SCRIPT_DIR/i586-$VERSION-nosmp .config
  fi
 }

 gzip_modules(){
  local KO="/lib/modules/$VERSION/kernel/"
  find $KO -type f -size +4096c | xargs -r --max-lines=64 gzip -v1
  find $KO -type f              | sed   -n '/\.gz$/p' |
  while read; do mv -v "$REPLY" "${REPLY%\.gz}"; done
 }

 strip_modules(){
  find /lib/modules/$VERSION/kernel -type f -name \*.ko |
  xargs --max-lines=256 strip --strip-unneeded
 }

 compile_and_install(){
  # apply_linux_patch
  restore_linux_configs
  yes "" | make oldconfig
  make modules          &&
  make bzImage          &&
  prepare_install       &&
  make modules_install  && strip_modules &&
  make firmware_install &&
  install_kernel        &&
  install_header
 }

 rm -fr        /usr/src/linux &&
 mv $BUILD_DIR /usr/src/linux &&
 cd            /usr/src/linux &&
 compile_and_install
}


current(){
 if   ! [  -f      /usr/include/linux/autoconf.h ]
 then cp /usr/src/linux/include/linux/autoconf.h \
                   /usr/include/linux/autoconf.h
      true
 fi
}
