   VERSION=( "3.6.2" "3.6.1" )
  CATEGORY="administration/monitoring network/web"
 ATTRIBUTE="x11 new"
    SOURCE="pub/rt/release/rt-$VERSION.tar.gz"
       URL="http://download.bestpractical.com/"
  HOMEPAGE="http://www.bestpractical.com/rt"
       REQ=( "httpd
              perl--Apache-DBI
              perl--Apache-Session
              perl--Apache-Test
              perl--DBIx-SearchBuilder
              perl--Calendar-Simple
              perl--GD
              perl--GDGraph
              perl--HTML-Format
              perl--HTML-Mason
              perl--HTML-Scrubber
              perl--HTTP-Server-Simple-Mason
              perl--Locale-Maketext-Fuzzy
              perl--Locale-Maketext-Lexicon
              perl--Log-Dispatch
              perl--MIME-tools
              perl--MLDBM
              perl--Module-Refresh
              perl--Module-Versions-Report
              perl--Net-SNMP
              perl--Regexp-Common
              perl--Test-Expect
              perl--Test-Inline
              perl--Text-Template
              perl--Text-Wrapper
              perl--TermReadKey
              perl--Text-Quoted
              perl--Time-modules
              perl--Tree-Simple
              perl--Test-WWW-Mechanize
              perl--Text-WikiFormat
              perl--UNIVERSAL-require
              perl--XML-RSS
              perl--XML-Simple
              perl--libwww"
             "perl--DBD-mysql:--with-db-type=mysql::for mysql support (choose one database)"
             "perl--DBD-Pg:--with-db-type=Pg::for PostgreSQL support (choose onedatabase)" )
   EXCLUDE="/opt/rt3.sav"
  ESTIMATE="229"
      DESC="rt is an enterprise-grade ticketing system.
It enables a group of people to intelligently and efficiently
manage tasks, issues, and requests submitted by a community of users.
The RT platform is used by systems administrators,
customer support staffs, IT managers,
developers and marketing departments
at thousands of sites around the world.
RT manages key tasks such as the identification,
prioritization, assignment, resolution and notification
required by enterprise-critical applications
including project management, help desk, NOC ticketing,
CRM and software development."

build() {

echo_instructions() {
  echo "or by running"
  echo "  /opt/rt3/sbin/rt-setup-database --action init \\"
  echo "                    --dba \$DB_DBA --prompt-for-dba-password"
  echo "where DB_DBA is the name of a database user with permission to "
  echo "create a new database. For mysql you probably want 'root', for "
  echo "PostgreSQL you probably want 'postgres'."
  echo "This initialization is not needed if the database already exists."
}

etc_link() {
  RTPATH=/opt/rt3/etc

  install -v -d /etc/rt
  [ -h    $RTPATH/RT_SiteConfig.pm ]  ||  
    mv    $RTPATH/RT_SiteConfig.pm  /etc/rt
  ln  -sf /etc/rt/RT_SiteConfig.pm  $RTPATH   
}


rt_dir_save() {
  # OK, this is nasty but RT installation process somehow claims everything
  # within /opt/rt3 to be installed by RT. This is bad because some other
  # spells like AssetTracker also install into this directory. So the following
  # kludge tries to separate files installed by RT and other spells and make them
  # log appropriately.
  if    [ -d /opt/rt3 ]
  then  mv   /opt/rt3  /opt/rt3.sav
  fi
}

  groupadd  -K GID_MIN=256 -K GID_MAX=512  rt                        2>/dev/null
  useradd   -K UID_MIN=256 -K UID_MAX=512  rt  -d /var/empty  -g rt  2>/dev/null

  ./configure  $OPTS	&&
  make  testdeps	&& 
  make 			&&
  prepare_install	&&
  rt_dir_save		&&
  make  install		&&
  etc_link		&&
  echo_instructions
}

post_install() {

rt_dir_restore() {
  echo -en '\e[1m''\e[36m'
  echo -en "Restoring pre-existing files in /opt/rt3\n"
  echo -en '\e[0m'
  find  /opt/rt3.sav/* 2>/dev/null |
  while read 
  do  DEST=$( echo $REPLY | sed "s:/rt3.sav/:/rt3/:" )
      [ -d $DEST ]  ||  cp -av  $REPLY $DEST
  done
  rm -rf /opt/rt3.sav
}

  rt_dir_restore
                RT_PLUGIN="$( show_installed rt-plugin )"
  if   [  -n  "$RT_PLUGIN"  ];  then  #  unlock cast
    echo      "$RT_PLUGIN"  |  pipe_queue  "$CAST_QUEUE"  "com"
    true
  fi
}	
