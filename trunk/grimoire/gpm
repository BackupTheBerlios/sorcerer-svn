# Note the gpm daemon never disconnects from stdout.
# This keeps the runlevel init log from completing.
# If not fixed in gpm 1.20.1
# then modify gpm startup script to start gpm &>/dev/null
# gpm still not disconnecting from stdout and stderr in version 1.99.2.1

   version stable 1.20.6 1.20.5
   version unstable 1.99.7
   require init-functions ncurses
      opts --enable-static=no
  category utility
 attribute console
    source http://www.nico.schottelius.org/software/gpm/archives/gpm-$VERSION.tar.bz2
      info home  http://www.nico.schottelius.org/software/gpm/
 conflicts imwheel
      desc 'mouse server for the console'

configure(){
 mouse_menu(){
  BACKTITLE='gpm Configuration Menu'
      TITLE='Mouse Selection'
       HELP='Please select the mouse protocol'

  dialog \
  --backtitle "$BACKTITLE"  \
  --title     "$TITLE"      \
  --stdout                  \
  --timeout "$PROMPT_DELAY" \
  --no-cancel               \
  --menu "$HELP"            \
  0 0 0 $(< $SCRIPT_DIR/mice )
 }

 dev_menu(){
  BACKTITLE=$"gpm Configuration Menu"
      TITLE=$"Device node Selection"
       HELP=$"Please select the mouse device node"

  dialog \
  --backtitle "$BACKTITLE"  \
  --title     "$TITLE"      \
  --stdout                  \
  --timeout "$PROMPT_DELAY" \
  --no-cancel               \
  --default-item            \
  /dev/input/mice           \
  --menu "$HELP"            \
  0 0 0 $( find /dev -type c | sed "adev" )
 }

 if   ! grep -qs MOUSE= $SPELL_CONFIG ||
      ! grep -qs DEV=   $SPELL_CONFIG
 then
  ( export IFS=$'	\n'
    MOUSE="$( mouse_menu )"
      DEV="$( dev_menu   )"
  )
  if   [ -n "$MOUSE" ] &&
       [ -n "$DEV"   ]
  then echo "MOUSE=$MOUSE" >> $SPELL_CONFIG
       echo "DEV=$DEV"     >> $SPELL_CONFIG
  fi
 fi
}

build(){
 if   [ -n "$MOUSE" ] &&
      [ -n "$DEV"   ]; then
  sed -i  "s:MOUSE=.*:MOUSE=$MOUSE:
           s:DEV=.*:DEV=$DEV:" $SCRIPT_DIR/init.d/gpm
 fi

# sed -i "s:doc contrib:contrib:"     Makefile.in
# sed -i "40iLIBS  = -lm"         src/Makefile.in

 if ! [ -f configure ]
 then autoheader && autoconf
 fi
# The following case probably only required for
# versions 1.99.2.2 1.99.2.1
 case $HOSTTYPE in
  x86_64)
    echo "#ifndef OPEN_MAX
 #define OPEN_MAX 20
 #endif" >> src/headers/gpm.h ;;
 esac
 default_build
}
