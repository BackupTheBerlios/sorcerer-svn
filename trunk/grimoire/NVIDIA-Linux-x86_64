   VERSION=( 100.14.19 100.14.11 )
    IGNORE='unified'
  CATEGORY='kernel'
 ATTRIBUTE='linux-26-module x11 x86_64 new'
    SOURCE="$VERSION/NVIDIA-Linux-x86_64-${VERSION}-pkg2.run"
      VURL='http://www.nvidia.com/object/unix.html'
       URL='http://download.nvidia.com/XFree86/Linux-x86_64/'
  HOMEPAGE='http://www.nvidia.com'
       REQ='MesaLib gtk+ mktemp'
 FRESHMEAT='nvidiaxfree86_40drivers'
  ESTIMATE='220'
      DESC='NVIDIA-Linux-x86 contains drivers provided by NVIDIA for NVIDIA GPUs
NVIDIA-Linux-x86 contains the nvidia provided binary 
XFree86 drivers for their graphics cards.  
It is also provides the kernel modules.'

pre_build() {
  default_pre_build
  cd  ..
  rmdir  $BUILD_DIR
  sh $SOURCE_CACHE/$SPELL/$VERSION/${SOURCE##*/} -x --target $BUILD_DIR
  chown  -R  root:root  $BUILD_DIR
}

build() {
  cd  $BUILD_DIR

  make_install()  {
    cd  $BUILD_DIR/usr

    GB="ltmain.sh - GNU libtool 1.5 (1.1220 2003/04/05 19:32:58)"
    sed  -i  "s:__LIBGL_PATH__:/usr/lib:
         s,__GENERATED_BY__,$GB,"    lib{,32}/libGL.la

    /sbin/ldconfig  -n  lib{,32}{,/tls}  X11R6/lib{,/modules/extensions}

    ln  -s  libGL.so.1      lib/libGL.so
    ln  -s  libGLcore.so.1  lib/libGLcore.so
    ln  -s  libGL.so.1      lib/tls/libGL.so
    ln  -s  libGLcore.so.1  lib/tls/libGLcore.so

    ln  -s  libGL.so.1      lib32/libGL.so
    ln  -s  libGLcore.so.1  lib32/libGLcore.so
    ln  -s  libGL.so.1      lib32/tls/libGL.so
    ln  -s  libGLcore.so.1  lib32/tls/libGLcore.so
   
    if    /lib64/libc.so.6   |
    grep  -q  "Thread-local storage"
    then  cp    -a   lib32/tls/*  lib32
          cp    -a   lib/tls/*    lib
    fi

    # rm  -f  /usr/X11R6/lib/libGL.*
    # rm  -f  /usr/lib/libGL.*
    # rm  -f  /usr/X11R6/lib/modules/extensions/libglx.*
    # rm  -f  /usr/X11R6/lib/modules/extensions/libGLcore.*

    rm  -rf  src

    if    [  -f  share/doc/Copyrights  ]
    then  mv     share/doc NVIDIA-Linux-x86
          mkdir  share/doc
          mv               NVIDIA-Linux-x86  \
                 share/doc
    fi

    cd  $BUILD_DIR

    find   usr  -type f  |
    while  read
    do     install  -vD  $REPLY  /$REPLY
    done

    find   usr  -type l  |
    while  read
    do     mv      -v    $REPLY  /$REPLY
    done
  }


  LVER=$(  installed_version  $(  get_provider  linux-kernel  )  )

  if    [  -z  "$LVER"  ]
  then           LVER=$(  uname  -r  )
  fi

  cd  usr/src/nv

  rm  -f  makefile  Makefile

  case  $LVER  in
   2.4*)  cp  Makefile.nvidia  Makefile  ;;
      *)  cp  Makefile.kbuild  Makefile  ;;
  esac


   SM="/usr/src/linux/System.map"
  SSC="suser-sanity-check"
  RSC="rmmod-sanity-check"

  sed  -i  "s/\$(shell uname -r)/$LVER/"  Makefile
  sed  -i  "s:depmod:true:"               Makefile
  sed  -i  "s:modprobe:true:"             Makefile
  sed  -i  "s:$SSC $RSC:$SSC:"            Makefile
  sed  -i  "s:install $RSC:install:"      Makefile

  prepare_install                        &&
  make    install  IGNORE_CC_MISMATCH=1  &&
     make_install
}

post_install() {
  default_post_install
  depmod  -a
}
