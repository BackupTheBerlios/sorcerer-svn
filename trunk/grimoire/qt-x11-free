   VERSION=( "3.3.8" "3.3.7" )
      SAFE=( "3.3.8" )
    IGNORE="\.0b"
  CATEGORY="graphic/library"
 ATTRIBUTE="library kde solo bc"
# Although it is not supposed to the broken library check could
# happen while qt-x11-free is compiling if another spell finishes casting.
# The check should not happen, but apparently it sometimes does.
# That is why qt-x11-free has the attribute solo now
# It is an odd source to compile because it probably will not
# compile and install correctly if compiled while installed.
    SOURCE=( "qt-x11-free-$VERSION.tar.bz2"
             "qt-x11-immodule-unified-qt3.3.8-20070321-gentoo.diff.bz2" )
  HOMEPAGE="http://www.trolltech.com/products/qt/x11.html"
       URL=( "ftp://ftp.trolltech.com/qt/source/"
             "http://distro.ibiblio.org/pub/linux/distributions/gentoo/distfiles/" )
# is cups required or optional?
       REQ=( "MesaLib libXcursor libXft libXinerama libXrandr libmng libpng"
             "cups:-cups:-no-cups:for common unix printing support"
             "freetype:-freetype:-no-freetype:quality font engine"
             ":-qt-gif::for gif support" )
# qt-x11-free does not support nas network audio.
 FRESHMEAT="qt"
  ESTIMATE="4870"
BC_EXCLUDE="\,^/usr/share/qt/,d"
      DESC="qt-x11-free simplifies the task of writing and maintaining GUI applications."

build()  {
  fix_qmake_conf() {
   # This should be used when the qt headers are NOT instaled in 
   # /usr/include, i.e. if they are installed to /usr/include/qt, 
   # /usr/share/qt/include or whatever then this is NEEDED because the
   # qmake.conf sets the QT include directory to $(QTDIR)/include.
   # Some applications need this to be correct in order for them to compile.
   sed    -i  's:\$(QTDIR)/include$:\$(QTDIR)/include/qt:'		\
              mkspecs/${SPECS}/qmake.conf
   cp     -a  mkspecs/${SPECS}  /usr/share/qt/mkspecs/
  }

  echo  $OPTS           |
  grep  -q  "\-qt-gif"  &&
  sed   -i  "s:READER 0:READER 1:"  src/kernel/qgif.h


  export  QTDIR=$BUILD_DIR
  sed  -i  "s/sub-tutorial sub-examples//"  Makefile
  rm   -rf  examples tutorial

  unset  LD_LIBRARY_PATH

  case  $HOSTTYPE  in
    x86_64)  OPTS="$OPTS -platform linux-g++-64 -L/lib64 -L/usr/lib64"
             SPECS=linux-g++-64
             LIBS=lib64  ;;
         *)  SPECS=linux-g++
             LIBS=lib  ;;
  esac


  if    [  -n  "${SOURCE[1]}"  ]
  then  decompress  $SOURCE_CACHE/qt-x11-free/$VERSION/${SOURCE[1]} | patch -p1 
        sh  ./make-symlinks.sh
        OPTS="$OPTS -inputmethod"
  fi

  prepare_install             &&  # doesn't make right if installed.

  # -R$BUILD_DIR/lib       \  # not required if qt-x11-free is not installed
  # -L$PWD/lib       \

  #  -cups           \

# -headerdir /usr/include/qt  \

  echo  "yes"  |
  ./configure  -v  \
  -release         \
  -shared          \
  -thread          \
  -system-libmng   \
  -system-libpng   \
  -system-libjpeg  \
  -system-zlib     \
  -tablet          \
  -xinerama        \
  -xft             \
  -R$PWD/lib       \
  -no-g++-exceptions     \
  -prefix /usr/share/qt  \
  -bindir /usr/bin       \
  -libdir /usr/$LIBS     \
  $OPTS                  &&
  make                   &&
  make    install        &&
  cp     -R   doc/man  /usr   &&
  ln     -s   ../share/qt/include  /usr/include/qt    &&
  ln     -s   ../../bin            /usr/share/qt/bin  &&
  ln     -s   ../../$LIBS          /usr/share/qt/lib  &&
  fix_qmake_conf

# QTDIR=/usr/share/qt
# because some sources check for /usr/share/qt/include/qglobal.h

# Leave broken symbolic link in place.
# rm                           /usr/share/qt/mkspecs/${SPECS}/${SPECS}
}

build_old()  {
echo  $OPTS           |
grep  -q  "\-qt-gif"  &&
sed   -i  "s:READER 0:READER 1:"  src/kernel/qgif.h


export  QTDIR=$BUILD_DIR
sed  -i  "s/sub-tutorial sub-examples//"  Makefile
rm   -rf  examples tutorial

unset  LD_LIBRARY_PATH

case  $HOSTTYPE  in
  x86_64)  OPTS="$OPTS -platform linux-g++-64 -L/lib64 -L/usr/lib64"
           SPECS=linux-g++-64
           LIBS=lib64
	   ;;
       *)  SPECS=linux-g++
           LIBS=lib
           ;;
esac

prepare_install             &&  # doesn't make right if installed.

# -R$BUILD_DIR/lib       \  # not required if qt-x11-free is not installed
# -L$PWD/lib       \

#  -cups           \
echo  "yes"  |
./configure  -v  \
-release         \
-shared          \
-thread          \
-system-libmng   \
-system-libpng   \
-system-libjpeg  \
-system-zlib     \
-xinerama        \
-xft             \
-R$PWD/lib       \
-no-g++-exceptions     \
-prefix /usr/share/qt  \
-bindir /usr/bin       \
-libdir /usr/$LIBS     \
-headerdir /usr/include/qt  \
$OPTS                       &&
make                        &&
# prepare_install             &&  # might not make right if installed.
make    install             &&
cp     -R   doc/man  /usr   &&
rm                           /usr/share/qt/mkspecs/${SPECS}/${SPECS}  &&
# The next line should be only used if headerdir is /usr/include/qt because
# the default value of it is /usr/include
sed    -i  's:\$(QTDIR)/include$:\$(QTDIR)/include/qt:'		\
           mkspecs/${SPECS}/qmake.conf
cp     -a  mkspecs/${SPECS}  /usr/share/qt/mkspecs/
}

current() {
  case  $VERISON  in
    3.3.6)  grep  -qx  "patching file ChangeLog.immodule"  $COMPILE_LOGS/qt-x11-free  ;;
  esac
}
