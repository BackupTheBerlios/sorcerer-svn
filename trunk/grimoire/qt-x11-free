# The broken library check could happen while qt-x11-free is compiling
# if another spell finishes casting.
# The check should not happen, but apparently it might.
# That is why qt-x11-free has the attribute solo now
# It is an odd source to compile because it probably will not
# compile and install correctly if compiled while installed.

   version stable 3.3.8b 3.3.8 3.3.7
   version secure 3.3.8b 3.3.8
   require MesaLib kde-symlinks-v3 libXcursor libXft libXinerama libXrandr libmng libpng
  optional cups     -cups     -no-cups     for common unix printing support
  optional freetype -freetype -no-freetype for quality font engine
  category graphic/library
 attribute library multilib-fail kde3 solo
 attribute broke
    source ftp://ftp.trolltech.com/qt/source/qt-x11-free-$VERSION.tar.gz
  homepage http://www.trolltech.com/products/qt/x11.html

# daisuke no longer provides the patch?
# The old patch does not compile without slight modification.
#   source http://people.freedesktop.org/~daisuke/qt-x11-immodule-unified-qt3.3.8-20071116.diff.bz2

# gentoo might have a patch, but they probably modifiy daisuke's patch
#   source http://distro.ibiblio.org/pub/linux/distributions/gentoo/distfiles/qt-x11-immodule-unified-qt3.3.8-20070321-gentoo.diff.bz2

# is cups required or optional?
# qt-x11-free does not support nas network audio.
      opts -qt-gif -inputmethod
 conflicts qt-x11-free
 freshmeat qt
      desc 'The trolltech Q GUI tool kit'

build(){

 add_rpath_to_la(){
  sed -i 's:-L/opt/kde3/lib:-L/opt/kde3/lib -R/opt/kde3/lib:
          s:-L/opt/kde3/lib64:-L/opt/kde3/lib64 -R/opt/kde3/lib64:' \
      $( find $DESTDIR/opt/kde3/ -name libqt\*.la )
 }

 unset   LD_LIBRARY_PATH
 export  QTDIR=/opt/kde3
 sed -i  's:READER 0:READER 1:' src/kernel/qgif.h
 sed -i  's/sub-tutorial sub-examples//'  Makefile
 rm  -rf examples tutorial

 SPECS=linux-g++
  LIBS=/opt/kde3/lib

 if [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]; then
  opts -platform linux-g++-64 -L/lib64 -L/usr/lib64
  SPECS+=-64
  LIBS+=64
 fi

# if [[ -n    ${SOURCE[1]} ]]; then
# cast automatically applies the patch
# But it did not work?
#  decompress ${SOURCE[1]} | patch -p1 
  sh ./make-symlinks.sh
#  OPTS+=' -inputmethod'
# fi

 # Fix for gcc 4.2.2(4.3?)
 case $VERSION in
  3.3.8b) sed -i 's:/bin/pwd:pwd:' configure ;;
  3.3.8) sed -i '43i#include <cstdlib>' \
         plugins/src/inputmethods/imsw-none/qnoneinputcontextplugin.cpp ;;
 esac

 PREFIX=/opt/kde3
 export LD_LIBRARY_PATH=$PWD/lib

 echo yes |
 ./configure  -v  \
 -R$LIBS          \
 -L$LIBS          \
 -libdir $LIBS    \
 -release         \
 -shared          \
 -thread          \
 -system-libmng   \
 -system-libpng   \
 -system-libjpeg  \
 -system-zlib     \
 -tablet          \
 -xinerama        \
 -xft             \
 -pch             \
 -no-g++-exceptions \
 -prefix $PREFIX \
 -R      $PREFIX/lib \
 -R      $PREFIX/lib64 \
 $OPTS &&
 make  &&
 mkdir -p $DESTDIR/opt/kde3 &&
 make install      DESTDIR=$DESTDIR INSTALL_ROOT=$DESTDIR &&
 mkdir -p         $DESTDIR/usr/man &&
 cp    -R doc/man $DESTDIR/usr/man &&
 add_rpath_to_la
}

current(){
 x86_64() {
  case $HOSTTYPE in
   x86_64) [ -f /opt/kde3/lib64/libqt-mt.la ] ;;
  esac
 }

 case $VERISON in
  3.3.8b) [ -f /opt/kde3/bin/qmake ] && x86_64 ;;
 esac
}
