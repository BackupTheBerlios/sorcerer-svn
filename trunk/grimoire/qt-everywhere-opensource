# exceptions required
# QtXmlPatterns was requested, but it can't be built due to exceptions being disabled

# http://bugreports.qt.nokia.com/browse/QTBUG-5385

# might fail to compile if not installed

# http://get.qt.nokia.com/qt/source/qt-everywhere-opensource-src-4.6.3.tar.gz 
# Above is alternate download location?

# Latest release is 4.7.1 but can KDE use it?

   version stable 4.7.3 4.7.2 4.7.1 4.6.3
  eprovide qt-everywhere-opensource
   require alsa-lib dbus glib fontconfig libXcursor libXinerama libXrandr libiodbc libmng libpng sqlite tiff
  optional cups        -cups -no-cups                for common unix printing support
# optional mysql       -plugin-sql-mysql
  optional postgresql  ''    -no-sql-psql            for postgresql support
# optional sqlite-v2.8 ''    -no-sql-sqlite2         for old sqlite support
  optional unixODBC    ''    -no-sql-odbc            for connecting to windows database
      opts -no-phonon -fontconfig -xmlpatterns -exceptions
  category graphic/library
 attribute bottleneck huge kde4 library makej multilib-dual
    source ftp://ftp.trolltech.com/qt/source/qt-everywhere-opensource-src-$VERSION.tar.gz
  homepage http://www.trolltech.com/developer/downloads/qt/x11
 freshmeat qt
      desc 'GUI toolkit'

build(){
 local ARCH PREFIX

 add_rpath_to_la(){
  if  [[ $HOSTTYPE == x86_64 ]]; then
   if [[ $CFLAGS   =~ -m32   ]]; then
    sed -i 's:-L/opt/kde4/i686/lib:-L/opt/kde4/i686/lib -R/opt/kde4/i686/lib:' \
        $( find $DESTDIR/opt/kde4/i686/lib/ -name libQt\*.la )
   else
    sed -i 's:-L/opt/kde4/lib64:-L/opt/kde4/lib64 -R/opt/kde4/lib64:' \
        $( find $DESTDIR/opt/kde4/lib64/ -name libQt\*.la )
   fi
  else
   sed -i 's:-L/opt/kde4/lib:-L/opt/kde4/lib -R/opt/kde4/lib:' \
       $( find $DESTDIR/opt/kde4/lib/ -name libQt\*.la )
  fi
 }

 rm -rf demos examples

# qt-everywhere-opensource can not be told where
# the mysql.h header file is
# nor does it run mysql_config in order to find out!
# export   CFLAGS+=' -fPIC -I/usr/include/mysql'
# export CXXFLAGS+=' -fPIC -I/usr/include/mysql'
 export   CFLAGS+=' -fPIC'
 export CXXFLAGS+=' -fPIC'
 export  LDFLAGS+=" -Wl,-rpath-link,$PWD/lib"

 flags(){
  while [[ -n $1 ]]; do
   sed -n '/^flags/p' /proc/cpuinfo | grep -qw "$1" || OPTS+=" -no-$1"
   shift
  done
 }

## version 4.7.1 responds to these flags opposite of how it should
# if   [[ i586 == $HOSTTYPE ]] && [[ -d /boot/isolinux ]]
# then OPTS+=' -no-mmx -no-3dnow -no-sse -no-sse2'
# else
#  case $HOSTTYPE in
#   i?86) flags mmx 3dnow sse sse2 ;;
#  esac
# fi

 PREFIX=/opt/kde4

 if    [[ $HOSTTYPE == x86_64 ]]; then
  if   [[ $CFLAGS   =~ -m32   ]]
  then ARCH=i686;      PREFIX=/opt/kde4/i686
  else ARCH=$HOSTTYPE; opts -libdir $PREFIX/lib64
  fi
 else  ARCH=$HOSTTYPE
 fi

 unset CC CXX

 sed -i 's:/bin/pwd:pwd:g' configure

# local  RATH="/opt/libiodbc/bin:$PATH"
# local  PATH
# export PATH=$RATH

 mkdir -p lib
 echo -e "o\nyes" |
 setarch $ARCH    \
 ./configure      \
 -v               \
 -fast            \
 -release         \
 -shared          \
 -optimized-qmake \
 -system-libmng   \
 -system-libjpeg  \
 -system-libpng   \
 -system-libtiff  \
 -system-sqlite   \
 -system-zlib     \
 -qt3support      \
 -qt-gif          \
 -xinerama        \
 -nomake demos    \
 -nomake examples \
 -prefix $PREFIX  \
 -reduce-relocations \
 -no-separate-debug-info \
 $OPTS &&
 setarch $ARCH make &&
 setarch $ARCH make install DESTDIR=$DESTDIR INSTALL_ROOT=$DESTDIR &&
 add_rpath_to_la
}
