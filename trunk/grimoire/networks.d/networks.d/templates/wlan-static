# Template for wireless statically configured network connection.


INTERFACE="wlan0"		# Required, might also be wifi0, eth1, ra0, ...
KEY=				# Optional
MODE="Managed"			# Required
ESSID="any"			# Required
AP=				# Optional address of the Access Point

IP=				# Required
NETMASK=			# Optional
GATEWAY=			# Good idea
BROADCAST=			# Optional
MODULE=				# Optional

restore_resolv_conf()  {
  if    [    -f  /etc/resolv.conf.${0##*/}  ]
  then  cmp  -s  /etc/resolv.conf.${0##*/}  /etc/resolv.conf  ||
        cp       /etc/resolv.conf.${0##*/}  /etc/resolv.conf
  fi
}

test_dns() {
  local  NS=$(  grep   "nameserver"  /etc/resolv.conf  |
                sed  "s/nameserver//;s/#.*$//"  )
  if    [  -n  "$NS"      ]  &&
        [  -x  /bin/nmap  ]
  then         /bin/nmap  -n  -p 53  $NS  |  grep  -q  "open.*domain"
  fi
}

verify_connection()  {
  read < /sys/class/net/$INTERFACE/carrier 2>/dev/null        &&
  if    [  $REPLY -eq 1  ]
  then  restore_resolv_conf
        test_dns
  else  false
  fi
}

start()  {
  [  -n  "$MODULE"     ]  &&  modprobe  "$MODULE"

                              iwconfig $INTERFACE mode  "$MODE"
  [  -n  "$KEY"        ]  &&  iwconfig $INTERFACE key   "$KEY"	\
                          ||  iwconfig $INTERFACE key   off
  [  -n  "$ESSID"      ]  &&  iwconfig $INTERFACE essid "$ESSID"  \
                          ||  iwconfig $INTERFACE essid any
  [  -n  "$AP"         ]  &&  iwconfig $INTERFACE ap    "$AP"	\
                          ||  iwconfig $INTERFACE ap    off

                              ifconfig $INTERFACE $IP
  [  -n  "$BROADCAST"  ]  &&  ifconfig $INTERFACE broadcast $BROADCAST 
  [  -n  "$NETMASK"    ]  &&  ifconfig $INTERFACE netmask $NETMASK
  [  -n  "$GATEWAY"    ]  &&  route add default gateway $GATEWAY

  verify_connection
}

stop()  {  ifconfig   $INTERFACE  down;  }

$1
