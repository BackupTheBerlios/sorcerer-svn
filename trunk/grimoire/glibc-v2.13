# glibc version 2.14.1 and 2.13 have a patch that fixes a compilation bug
# that was introduced by the gcc version 4.5.x branch
# and yet not fixed by gcc authors, odd.

   version stable 2.13
  category development
 attribute library makej multilib-dual
   require perl linux-headers
      opts --without-selinux
#     opts --enable-kernel=2.6.26
      opts --enable-omitfp
      opts --enable-kernel=2.6.30
      opts --enable-oldest-abi=2.13
# --enable-oldest-abi=2.3.3 compiled without installing libraries
#     opts --enable-oldest-abi=2.3.3
# --enable-kernel=2.6.26 breaks compilation
#     opts --enable-kernel=2.6.26
# --disable-versioning breaks compilation
#     opts --disable-versioning
    source $GNU_URL glibc/glibc-$VERSION.tar.xz
      info last 20110306
      info home http://www.gnu.org/software/libc/
      info docs http://www.gnu.org/software/libc/manual/
      desc 'old glibc implementation that provides old bugs and RPC'

build(){ (
 local arch prefix setarch

 install_glibc(){
  cd    $DESTDIR
  rm -f $DESTDIR/etc/{localtime,ld.so.*}
  true
 }

 if [[ $HOSTTYPE == x86_64 ]] && [[ $CFLAGS =~ -m32 ]]; then
  export CC="gcc -m32"
  opts --host=${MACHTYPE/x86_64/i686}
  arch=i686; setarch=setarch
 fi

 unset LTDL_LIBRARY_PATH LD_LIBRARY_PATH LD_RUN_PATH

   CFLAGS="-O2 $( echo "${CFLAGS// /$LF}" | grep march )"
  LDFLAGS='-Wl,-s -Wl,-O1'
   LC_ALL=C

 export CFLAGS LDFLAGS LC_ALL
 unset  CXXFLAGS

 sed -i 's:/bin/pwd:pwd:g' configure

 prefix=/opt/glibc/2.13

 mkdir build
 cd    build
 $setarch $arch \
 ../configure       \
  --prefix=$prefix/usr \
  --disable-profile \
  --with-tls        \
  --with-elf        \
  --without-gd      \
  --without-cvs     \
  --enable-shared   \
  --enable-add-ons  \
  --with-headers=/usr/include \
  $OPTS &&
 $setarch $arch make     all &&
 $setarch $arch make install install_root=$DESTDIR &&
 install_glibc
 ) }
