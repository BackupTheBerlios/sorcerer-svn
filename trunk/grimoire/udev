# /dev/zero and /dev/mem are needed for uvesafb before udevd starts

    stable 125 124 120 119 118
    secure     120
   require sysvinit libselinux
  category utility
 attribute console
       url $KERNEL_URL
    source pub/linux/utils/kernel/hotplug/udev-$VERSION.tar.gz
      opts USE_LOG=true
  homepage http://www.kernel.org/pub/linux/utils/kernel/hotplug/udev.html
   exclude /dev
  estimate 200
      desc 'udev provides an auto-populating /dev.
udev replaces hotplug'

build(){

init_install(){
 mkdir   -vpm 755 /etc/udev/rules.d /etc/udev/examples
 cp      -va          rules/*       /etc/udev/examples
 chmod   -vR og-w                   /etc/udev/examples
}


symlink_install(){
 mkdir -vpm 755                       /lib/udev/dev/{pts,shm}
 ln    -vfns /proc/self/fd            /lib/udev/dev/fd
 ln    -vfns /proc/self/fd/0          /lib/udev/dev/stdin
 ln    -vfns /proc/self/fd/1          /lib/udev/dev/stdout
 ln    -vfns /proc/self/fd/2          /lib/udev/dev/stderr
 ln    -vfns /proc/kcore              /lib/udev/dev/core
 ln    -vfns /proc/asound/oss/sndstat /lib/udev/dev/sndstat
 rm    -f                             /lib/udev/dev/{console,mem,null,zero}
 mknod -m 600                         /lib/udev/dev/console c 5 1
 mknod -m 640                         /lib/udev/dev/mem     c 1 1
 mknod -m 666                         /lib/udev/dev/null    c 1 3
 mknod -m 444                         /lib/udev/dev/zero    c 1 5
}


install_missing(){
 # Default rules script (Gentoo) expects extra binaries in /sbin while udev
 # installation puts them only in /lib/udev - make symlinks to fix this
 for FILE in /lib/udev/*; do
  if   [[ -f   $FILE ]]
  then ln -fs "$FILE" /sbin
  fi
 done
}

adjust_rules(){
 local REPLY=/lib/udev/rules.d/50-udev-default.rules
 if   [[   -f                               $REPLY ]] &&
      grep -q   'GROUP="kmem"'              $REPLY
 then sed  -i 's:GROUP="kmem":GROUP="mem":' $REPLY
 fi
 install -vm 644 rules/gentoo/65-permissions.rules /lib/udev/rules.d/
}

 if   spell_installed libselinux
 then OPTS+=' USE_SELINUX=true'
 fi

 case $VERSION in
  *) EXTRAS="EXTRAS=extras/ata_id extras/cdrom_id extras/edd_id extras/firmware extras/floppy extras/path_id extras/rule_generator extras/scsi_id extras/usb_id extras/volume_id" ;;
 esac

 make    $OPTS   "$EXTRAS" &&
 prepare_install           &&
 make    install "$EXTRAS" &&
         install_missing   &&
    init_install           &&
 symlink_install           &&
  adjust_rules
}
