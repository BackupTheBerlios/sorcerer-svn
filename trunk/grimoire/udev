# Apparent in udev version 118 and not udev version 115
# gentoo rules switched from installing
# sound device nodes in /dev/snd to /dev
   VERSION=( 120 119 118 )
      SAFE=( 120 119 118 )
  CATEGORY='utility'
 ATTRIBUTE='console'
    SOURCE="pub/linux/utils/kernel/hotplug/udev-$VERSION.tar.gz"
#      REQ=( '' 'libselinux:USE_SELINUX::for selinux support' )
# Temporarily mandate that sysvinit casts before udev
       REQ='sysvinit libselinux'
# 'libselinux:USE_SELINUX::for selinux support' )
      OPTS='USE_LOG=true'
       URL="$KERNEL_URL"
  HOMEPAGE='http://www.kernel.org/pub/linux/utils/kernel/hotplug/udev.html'
   EXCLUDE='/dev'
  ESTIMATE='200'
      DESC='udev provides an auto-populating /dev.
udev replaces hotplug'

build(){
init_install(){
 mkdir   -p      /etc/udev/rules.d  /etc/udev/examples
 cp      -a       etc/udev/*        /etc/udev/examples
 chmod   -R og-w                    /etc/udev/examples
 cd                                 /etc/udev/rules.d/
 ln      -sf   ../examples/gentoo/* /etc/udev/rules.d/
 mkdir   -p                         /etc/udev/scripts
#install -m 0755  extras/*.sh       /etc/udev/scripts
}


symlink_install(){
 mkdir -p   -m 0755                  /lib/udev/dev/{pts,shm}
 ln    -fns /proc/self/fd            /lib/udev/dev/fd
 ln    -fns /proc/self/fd/0          /lib/udev/dev/stdin
 ln    -fns /proc/self/fd/1          /lib/udev/dev/stdout
 ln    -fns /proc/self/fd/2          /lib/udev/dev/stderr
 ln    -fns /proc/kcore              /lib/udev/dev/core
 ln    -fns /proc/asound/oss/sndstat /lib/udev/dev/sndstat
 rm    -f                            /lib/udev/dev/{console,null}
 mknod -m 600                        /lib/udev/dev/console c 5 1
 mknod -m 666                        /lib/udev/dev/null    c 1 3
}


install_missing(){
 # Default rules script (Gentoo) expects extra binaries in /sbin while udev
 # installation puts them only in /lib/udev - make symlinks to fix this
 for FILE in /lib/udev/*; do
  if   [  -f  "$FILE" ]
  then ln -fs "$FILE" /sbin
  fi
 done
}

adjust_rules(){
 local REPLY=/etc/udev/rules.d/50-udev-default.rules
 if   [    -f                               $REPLY ] &&
      grep -q   'GROUP="kmem"'              $REPLY
 then sed  -i 's:GROUP="kmem":GROUP="mem":' $REPLY
 fi
}

 if   spell_installed libselinux
 then OPTS+=' USE_SELINUX=true'
 fi

 case $VERSION in
  105) EXTRAS="extras/ata_id extras/cdrom_id extras/dasd_id extras/edd_id extras/firmware extras/floppy extras/path_id extras/rule_generator extras/run_directory extras/scsi_id extras/usb_id extras/volume_id" ;;
  075) EXTRAS="extras/ata_id extras/cdrom_id extras/dasd_id extras/eed_id extras/firmware extras/floppy extras/run_directory extras/scsi_id extras/usb_id extras/volume_id" ;;
    *) EXTRAS="extras/ata_id extras/cdrom_id extras/edd_id extras/firmware extras/floppy extras/path_id extras/rule_generator extras/scsi_id extras/usb_id extras/volume_id" ;;
 esac

 # sed -i "s:/local::
 #         s:^udevdir = .*:udevdir = /dev:
 #         s:killall:true:" Makefile
 # sed -i "s:@udevdir@:/dev:" etc/udev/udev.conf.in

 make    $OPTS   "EXTRAS=$EXTRAS" &&
 prepare_install                  &&
 make    install "EXTRAS=$EXTRAS" &&
         install_missing          &&
    init_install                  &&
 symlink_install                  &&
  adjust_rules
}

current(){
 case $VERSION in
  118) [    -f                          /etc/init.d/udevd-restart ] &&
       grep -q '# Provides: udevd udev' /etc/init.d/udevd-restart ;;
 esac
}
