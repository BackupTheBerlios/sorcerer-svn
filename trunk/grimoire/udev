# Always lag stable udev 5 versions behind currently available udev
# That may keep current hal and udev working properly together.
# When updating udev, email Jan for an early check of udev/hal

    stable 135 130 125 124 120
   require sysvinit libselinux
  category utility
 attribute console
       url $KERNEL_URL
    source pub/linux/utils/kernel/hotplug/udev-$VERSION.tar.gz
  homepage http://www.kernel.org/pub/linux/utils/kernel/hotplug/udev.html
   exclude /dev
   exclude /lib/udev/dev/core
  estimate 200
      desc 'udev provides an auto-populating /dev.
udev replaces hotplug'

build(){

# /dev/zero and /dev/mem are needed for uvesafb before udevd starts

nod_sym_install(){
 mkdir -vpm 755                       /lib/udev/dev/{pts,shm}
 ln    -vfns /proc/self/fd            /lib/udev/dev/fd
 ln    -vfns /proc/self/fd/0          /lib/udev/dev/stdin
 ln    -vfns /proc/self/fd/1          /lib/udev/dev/stdout
 ln    -vfns /proc/self/fd/2          /lib/udev/dev/stderr
 ln    -vfns /proc/kcore              /lib/udev/dev/core
 ln    -vfns /proc/asound/oss/sndstat /lib/udev/dev/sndstat
 rm    -f                             /lib/udev/dev/{console,mem,null,zero}
 mknod -m 600                         /lib/udev/dev/console c 5 1
 mknod -m 640                         /lib/udev/dev/mem     c 1 1
 mknod -m 666                         /lib/udev/dev/null    c 1 3
 mknod -m 444                         /lib/udev/dev/zero    c 1 5
}

# The extra rules are needed to create frequently needed nodes 
# and symlinks. Also needed to set privileges to nodes like
# /dev/dsp, etc.

 rules_install(){ install -vm 644 $SCRIPT_DIR/rules.d/* /lib/udev/rules.d; }

 if   spell_installed libselinux
 then OPTS+=' --with-selinux'
 fi

 case $HOSTTYPE in
  x86_64) OPTS+=' --with-libdir-name=lib64' ;;
 esac

 unset LD_PRELOAD
 ./configure        \
  --build=$BUILD    \
  --sysconfdir=/etc \
  --prefix=/usr     \
  --exec-prefix=/   \
 $OPTS           &&
 make            &&
 prepare_install &&
 make    install &&
 rules_install   &&
 nod_sym_install
}


post_install(){
if   LC_ALL=C grep -q '^mem:x:'  /etc/groups
then sed -i 's/^mem:x:/kmem:x:/' /etc/groups
fi
}

current(){
case $VERSION in
130) [ -f /lib/udev/rules.d/sound.rules ] ;;
esac
}
