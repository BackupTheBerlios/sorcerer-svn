#!/bin/bash
# Copyright 2007, 2008, 2011 by Kyle Sallee,
# All rights reserved.
# For use with the distribution Sorcerer only.
# boot-blaze accelerates booting

file(){ while read r; do [ -f "$r" ] && echo "$r"; done; }

load(){
 if [ -d $LOG ]; then
  find $LOG -type f -mtime -182 -printf "/%P\n" |
  file |
  /bin/tar --atime-preserve=system --no-recursion -chPT - |
  /bin/cat &>/dev/null
 fi
}

mkdr(){ [ -d "${1%/*}" ] || mkdir -p "${1%/*}"; }
mkdt(){ while read R; do mkdr "$R"; echo -n > "$R"; done; }
save(){ sed "s:^:$LOG:" | mkdt; }
used(){ find $DIR -anewer $TMP -type f -size -32M; }
omit(){ LC_ALL=C grep -v "^/var/cache/\|^/var/log/\|^/var/tmp/"; }

look(){
 rm    -rf  $TMP
 echo  -n > $TMP

 mkdir -pm 700 $LOG
 chmod     700 $LOG

 sleep 900

 [ -f $TMP ] || return

 used | omit | save
}

main(){
 look &>/dev/null & disown
 load &>/dev/null & disown
}

trap : SIGHUP SIGINT SIGQUIT SIGILL SIGABRT SIGSTOP
umask 077
TMP=/tmp/boot-blaze
LOG=/var/tmp/boot-blaze

export LC_ALL=C

if   [[     -x /usr/libexec/bash/sleep ]]
then enable -f /usr/libexec/bash/sleep sleep
fi

DIR="/bin /etc /home /lib /opt /sbin /usr /var"
if [ -d /lib64 ]; then DIR+=' /lib64'; fi

main &>/dev/null
