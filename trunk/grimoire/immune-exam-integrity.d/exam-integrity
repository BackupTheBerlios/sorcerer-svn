#!/bin/bash
# Copyright 2000 through 2013 by Kyle Sallee,
# All rights reserved.
# For use with the distribution Sorcerer only.
# md5sum checks md5sums of files installed by spells.

. /etc/sorcery/config
. /lib/cgroup/functions

export LC_ALL=C
# trap : SIGHUP SIGINT SIGQUIT SIGILL SIGABRT SIGSTOP SIGTERM

renice 19      -p $$ &>/dev/null
ionice -c2 -n7 -p $$ &>/dev/null

WHAT='Unexpected md5sum'
 LOG='Cast MD5'

find "$POST_LOGS" -type f -printf "%P\n" |
while read; do
 MD5_OLD="$( xz -cd "$POST_LOGS/$REPLY" | sed -n 3p )"
 MD5_NEW="$(
  cut -b 35- < "$MD5_INDEX/$REPLY" | sed p       |
  cat -    "$INSTALL_INDEX/$REPLY" | sort        | uniq -u   |
  sed '\,/aux/,d' | files          | filter vary | escape_qs |
  xargs -r --max-lines=256 cat     | md5sum      | sed 's:  -::'
 )"
 if ! [ "$MD5_NEW" == "$MD5_OLD" ]; then
  event "$REPLY" "$( installed_version "$REPLY" )" "$LOG"
  echo  "$REPLY" | pipe_queue "$LOAD_QUEUE"
  echo  "$REPLY" | pipe_queue "$MOIL_QUEUE"
 fi
done
