#!/bin/bash
# Copyright 2000 through 2012 by Kyle Sallee,
# All rights reserved.
# For use with the distribution Sorcerer only.
# md5sum checks md5sums of files installed by spells.

. /etc/sorcery/config
. /lib/cgroup/functions

export LC_ALL=C
# trap : SIGHUP SIGINT SIGQUIT SIGILL SIGABRT SIGSTOP SIGTERM

renice 19      -p $$ &>/dev/null
ionice -c2 -n7 -p $$ &>/dev/null
# cgroup_join idle
# If it joins the idle cgroup then # augur abort exam-integrity
# will be unable to kill exam-integrity.

WHAT='Unexpected md5sum'
 LOG='Cast MD5'
 EXT=$RANDOM$RANDOM$RANDOM
 OLD=/tmp/md5sums.old.$EXT
 MIS=/tmp/md5sums.mis.$EXT
 CHK=/tmp/md5sums.chk.$EXT

tsum(){ find $MD5SUM_LOGS -type f; }
sums(){ tsum | xargs -r --max-lines=64 cat; }
 use(){ filter conf; }
 old(){ sums | use | limit_io 1 >  $OLD; }
name(){ cut -b 35-; }
slow(){ escape_qs | xargs -r --max-lines=64 tar --no-recursion -cP | limit_io | tar -itf -; }
 now(){ cat $OLD | name | slow | escape_qs | xargs -r --max-lines=64 md5sum; }
from(){ while read; do grep -rx "$REPLY" $INSTALL_LOGS; done | sed "s:$INSTALL_LOGS/::"; }
peal(){ sed  "s,:,\t,;s,^,$WHAT\t," | tee /dev/stderr | cut -f2 | sort -u; }
this(){ pipe_queue "$MOIL_QUEUE"; }
miss(){ sed 's/^md5sum: //;s/: No such file or directory$//p;d' $MIS; }
prepare(){ echo -en "\r0%"; }
percent(){ SOLD=$( finfo -s $OLD ); SCHK=$( finfo -s $CHK );
           (( PER = SCHK * 100 / $SOLD )); echo -en "\r$PER%"; }

why(){
 echo 1>&2; while read R; do
  event "$R" "$( installed_version "$R" )" "$LOG"
  echo  "$R"
 done
 }

check(){
 old > $OLD
 now > $CHK 2>$MIS

 sort -u $CHK     | cat - $OLD $OLD |
 sort | uniq -u   |
 name | pipe miss | sort -u |
 from | peal      | why     | this
 rm -f $OLD $MIS $CHK
}

guess(){
 while [[ -f $OLD ]] && ! [[ -s $CHK ]]; do prepare; sleep 1;  done
 while [[ -f $OLD ]];                    do percent; sleep 10; done
 echo
}

touch     $OLD $MIS $CHK
chmod 600 $OLD $MIS $CHK

check
# check &
# guess 2>/dev/null
