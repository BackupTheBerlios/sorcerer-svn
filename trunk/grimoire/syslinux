# 5.00-pre1 failed compilation
# 5.00-pre2 failed compilation

# syslinux version 4.05 compiled with gcc version 4.6.3 works
# however compiled with gcc version 4.7.1 makes extlinux fail at runtime
# 5.00 compiled with gcc version 4.7.2 fails to boot
# 5.00 not tested with gcc version 4.5 but itm ight work

with info    last 20121207
with version   stable 4.06
with version unstable 5.01
case $VERSION in
 5.00)
   use_gcc gcc-v4.5 ;;
esac
with base    nasm md5crypt perl--Digest-SHA1
with elect   mtools '' '' for creating msdos filesystems
with role    administration/bootloader
with trait   console makej
# lto makes syslinux slightly larger
with source  stable $KERNEL_URL pub/linux/utils/boot/syslinux/syslinux-$VERSION.tar.xz
with source  pre    $KERNEL_URL pub/linux/utils/boot/syslinux/Testing/${VERSION:0:4}/syslinux-$VERSION.tar.xz
with info    home http://syslinux.zytor.com/wiki/index.php/The_Syslinux_Project
with protect /etc/extlinux/
with vary    /boot/extlinux/extlinux.conf
with info    cite 'bootloader for Linux and other operating systems
syslinux works on FAT
isolinux, also provided by isolinux, works on ISO9660 file systems.
extlinux, works on ext2, ext3, and ext4 file systems.

If booting using extlinux
then please use ms-sys
to install a bootable MBR.'

build(){
 install_doc(){
  find doc -type d | xargs -r --max-lines=64 chmod 755
  find doc -type f | xargs -r --max-lines=64 chmod 644
  mkdir -pvm 700 "$DESTDIR"/usr/doc/
  mv         doc "$DESTDIR"/usr/doc/syslinux
 }

 install_menu(){
  mkdir -pvm 700 "$DESTDIR"/boot/extlinux
  cp     -av     "$DESTDIR"/{usr/share/syslinux/*menu.c32,boot/extlinux/}
  cp     -av     "$DESTDIR"/{usr/share/syslinux/mboot.c32,boot/extlinux/}
 }

 install_configs(){
  mkdir   -pvm 700 "$DESTDIR"/{boot,etc/extlinux,usr/sbin}
  install  -vm 600 "$SCRIPT_DIR"/head     "$DESTDIR"/etc/extlinux/
  install  -vm 600 "$SCRIPT_DIR"/tail     "$DESTDIR"/etc/extlinux/
  install  -vm 700 "$SCRIPT_DIR"/extlinux "$DESTDIR"/usr/sbin/
 }

 case $VERSION in
  5.*) unset LDFLAGS ;;
  4.*) unset LDFLAGS ;;
 esac

 sed -i '/INSTALL_AUX_OPT/d
         s:win32/syslinux.exe::' Makefile

 rm -f diag/geodsp/mk-lba-img
 make &&
 rm -f extlinux/extlinux &&
 make install INSTALLROOT="$DESTDIR" DESTDIR="$DESTDIR" &&
 install_doc  &&
 install_menu &&
 install_configs
}

current(){
 case $VERSION in
  4.06) [ -f /boot/extlinux/mboot.c32 ] ;;
 esac
}
