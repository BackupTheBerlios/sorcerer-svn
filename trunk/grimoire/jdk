# This may require manual download because
# oracle may forbid download without explicit consent to their EULA.
# report download problems with jdk directly to oracle.

# However, a mirror download is provided at the sources.silverice.org/
# Because of the effort expect newer jdk no more often than every other year.
# Complain to oracle that tacit agreement
# to their Oracle binary Code License Agreement
# is insufficient for downloading.

with info    good 20131104
with info    last 20131008
with version stable 7u45
with base    alsa-lib libXi libXp libXrender libXtst libiodbc
#with base    alsa-lib libXi libXp libXrender libXtst unixODBC

case $HOSTTYPE in
  x86_64) RPATH="/opt/jdk/jre/lib/amd64${LF}/opt/jdk/jre/lib/amd64/jli${LF}/opt/jdk/jre/lib/amd64/client${LF}/opt/jdk/jre/lib/amd64/server${LF}/opt/jdk/jre/lib/amd64/headless${LF}/opt/jdk/jre/lib/amd64/motif21${LF}/opt/jdk/jre/lib/amd64/xawt"
with source  http://sources.silverice.org/jdk/$VERSION/jdk-${VERSION:0:4}-linux-x64.tar.xz ;;
#   source http://download.oracle.com/otn-pub/java/jdk/$VERSION/jdk-${VERSION:0:3}-linux-x64.tar.gz ;;
       *) RPATH="/opt/jdk/jre/lib/i386${LF}/opt/jdk/jre/lib/i386/jli${LF}/opt/jdk/jre/lib/i386/client${LF}/opt/jdk/jre/lib/i386/server${LF}/opt/jdk/jre/lib/i386/headless${LF}/opt/jdk/jre/lib/i386/motif21${LF}/opt/jdk/jre/lib/i386/xawt"
with source  http://sources.silverice.org/jdk/$VERSION/jdk-${VERSION:0:4}-linux-i586.tar.xz ;;
#   source http://download.oracle.com/otn-pub/java/jdk/$VERSION/jdk-${VERSION:0:3}-linux-i586.tar.gz ;;
esac
CURL_PARAM=-k
with role    development/interpreter
with trait   mozilla-plugin x11 x86
with info    home http://openjdk.java.net
with info    vurl http://www.oracle.com/technetwork/java/javase/downloads/index.html
with hold    java
with info    cite 'open-source JDK (Java Platform SE)'

build(){

install_jdk(){
 case $HOSTTYPE in
    x86_64) ADIR=amd64 ;;
         *) ADIR=i386  ;;
 esac  
 case $VERSION in
  7*) DIR='jdk1.7.0' ;;
 esac

 set -x
 install -vm 755 -d "$DESTDIR"/{opt/$DIR,usr/bin}
 # Copy the untarred package to the destination
 cp -ax *           "$DESTDIR"/opt/$DIR/
 chown -R root.root "$DESTDIR"/opt/$DIR
 # /opt/jdk should be a symbolic link to the current version and NOT a directory
 ln -fs $DIR         "$DESTDIR"/opt/jdk	
 # Make links to the binaries
 for        FILE in  "$DESTDIR"/opt/jdk/bin/*
 do  ln -fs           ../../opt/jdk/bin/${FILE##*/} \
                     "$DESTDIR"/usr/bin/${FILE##*/}
 done

 if   [  -x  "$DESTDIR"/opt/jdk/jre/bin/java_vm ]
 then ln -fs      ../../opt/jdk/jre/bin/java_vm \
                     "$DESTDIR"/usr/bin/java_vm
 fi 

 local PD
 # Some pages say that only libnpjp2.so plugin is needed for Firefox
 if   [ -d     /usr/lib64/mozilla/plugins ]; then
  PD="$DESTDIR"/usr/lib64/mozilla/plugins
  install -vm 755 -d "$PD"
  ln -fs ../../../../opt/jdk/jre/lib/amd64/libnpjp2.so "$PD"/
 elif [ -d     /usr/lib/mozilla/plugins ]; then
  PD="$DESTDIR"/usr/lib/mozilla/plugins
  install -vm 755 -d "$PD"
  ln -fs ../../../../opt/jdk/jre/lib/i386/libnpjp2.so  "$PD"/
 fi

 set +x

 #mkdir -p  $DESTDIR/etc/.java/.systemPrefs
 #touch     $DESTDIR/etc/.java/.systemPrefs/.system.lock
 #touch     $DESTDIR/etc/.java/.systemPrefs/.systemRootModFile
 #chmod 644 $DESTDIR/etc/.java/.systemPrefs/.system*
}

 # Make sure the source downloaded is really a shell script
 # test broke with file version 5.05
 #file $SOURCE | grep -q 'shell script' && 

 # Test that the package was really JDK, not only some HTTP response:
 [[ -f COPYRIGHT ]] &&
 install_jdk
}
