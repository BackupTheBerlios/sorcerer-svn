# Copyright Kyle Sallee 2011 2012
# All rights reserved.
# For use with the distribution sorcerer only!

with version stable 20130101
with role    immune-system
with trait   archive_off daemon
with info    last 20130101
with info    home http://sorcerer.silverice.org/
with info    cite "/lib64 /lib protection

immune-sentinel-elf is part of the Sorcerer immune system.
It runs on the Sorcerer's keep.
It periodically checks the viability
of essential libraries that
are located in the real root file system.
If a problem is detected
then a previously created backup
of the library directory is restored.
This restores a computer to functioning condition
even after something wrecks glibc, ncurses, readline,
or other sufficiently important libraries.

immune-sentinel-elf refuses to run
on boxes that boot without using an initramfs.
Booting without an initramfs
is not tested and not recommended."

build(){
 libs(){
  if   [[ $HOSTTYPE == x86_64 ]]
  then echo '-Os -Wl,-O1 -L/lib64 -lacl -lmount -lreadline -ludev'
  else echo '-Os -Wl,-O1 -L/lib   -lacl -lmount -lreadline -ludev'
  fi
 }
 
 mkdir -pv $BUILD_DIR
 cd        $BUILD_DIR
 cp $SCRIPT_DIR/elfchain.c .
 echo gcc $LDFLAGS -o elfchain{,.c} $( libs )
      gcc $LDFLAGS -o elfchain{,.c} $( libs )

 mkdir  -pvm 755                          $DESTDIR/sbin
 install -vm 700 $SCRIPT_DIR/sentinel-elf $DESTDIR/sbin
 mkdir  -pvm 755                          $DESTDIR/usr/sbin
 install -vm 700 elfchain                 $DESTDIR/usr/sbin
}
