    stable 4.71 4.70 4.69 4.68 4.67 4.66 4.65 4.64 4.63 4.62 4.61 4.60
   require db gawk init-functions pcre
  optional mysql        '' '' for mysql authentication
  optional tcp_wrappers '' '' for controlling remote access
  optional Linux-PAM    '' '' for pluggable authentication
  category network/email
 attribute console server
       url $EXIM_URL
    source exim4/exim-$VERSION.tar.bz2
  homepage http://www.exim.org
      vurl http://ftp.exim.llorien.org/exim/exim4/
  eprovide mail-transport-agent
  estimate 250
      desc 'an Email server
exim is a message transfer agent (MTA) developed at the University
of Cambridge for use on Unix systems connected to the Internet.'


build(){

 install_symlinks(){
  ln -sf ../sbin/exim /usr/lib/sendmail
  ln -sf exim         /usr/sbin/sendmail
  ln -sf exim         /usr/sbin/mailq
  ln -sf exim         /usr/sbin/rsmtp
  ln -sf exim         /usr/sbin/rmail
  ln -sf exim         /usr/sbin/runq
  ln -sf exim         /usr/sbin/newaliases
 }

 install_conf(){
  echo -n > /etc/aliases
  sed  -i 's:var/mail:var/spool/mail:
           s:\# group = mail:  group = mail:
           s:\# mode = 0660:  mode = 0660:' /etc/exim.conf
  install -m 0644 doc/exim.8 /usr/man/man8
 }

 if ! [ -d /var/spool/mail ]; then
  mkdir    -p -m 1775 /var/spool/mail
  groupadd -K GID_MIN=256 -K GID_MAX=511    mail                         2>/dev/null
  useradd  -K UID_MIN=256 -K UID_MAX=511 -g mail -d /var/spool/mail mail 2>/dev/null
  chown    mail:mail  /var/spool/mail

  for        ITEM in /var/spool/mail/{db,input,log,msglog}
  do   [ -e $ITEM ] && chown -R mail:mail $ITEM
  done
 fi

 mkdir -p Local

 if   spell_installed  xorg; then
  cp  src/EDITME           Local/Makefile
  cp  exim_monitor/EDITME  Local/eximon.conf
 else
  grep -v 'EXIM_MONITOR=' src/EDITME > Local/Makefile
 fi

 if spell_installed tcp_wrappers; then
  echo 'USE_TCP_WRAPPERS = yes' >> Local/Makefile
  echo 'EXTRALIBS = -lwrap'     >> Local/Makefile
 fi

 if spell_installed Linux-PAM; then
  echo 'SUPPORT_PAM = yes'       >> Local/Makefile
  echo 'EXTRALIBS += -lpam -ldl' >> Local/Makefile  
 fi

 if spell_installed mysql; then
  echo 'LOOKUP_MYSQL=yes'                     >> Local/Makefile
  echo 'LOOKUP_INCLUDE=-I /usr/include/mysql' >> Local/Makefile
  echo 'LOOKUP_LIBS=-lmysqlclient'            >> Local/Makefile
 fi

 echo "BIN_DIRECTORY=/usr/sbin"         >>  Local/Makefile
 echo "CONFIGURE_FILE=/etc/exim.conf"   >>  Local/Makefile
 echo "SPOOL_DIRECTORY=/var/spool/mail" >>  Local/Makefile
 echo "CFLAGS=$CFLAGS"                  >>  Local/Makefile
 echo "EXIM_UID=`id -u mail`"           >>  Local/Makefile
 echo "EXIM_GID=`id -g mail`"           >>  Local/Makefile
 echo "EXIM_USER=mail"                  >>  Local/Makefile
 echo "EXIM_GROUP=mail"                 >>  Local/Makefile

 sed -i 's:tail -1:tail -n 1:' scripts/Configure-config.h

 make            &&
 prepare_install &&
 make    install &&
         install_symlinks &&
         install_conf
}
