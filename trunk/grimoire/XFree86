   VERSION=( "4.5.0" "4.4.0" "4.3.0.1" )
      SAFE=( "4.5.0" )
    IGNORE="\-[1-7]"
  CATEGORY="xserver"
 ATTRIBUTE="solo x11"
    SOURCE=( "$VERSION/source/XFree86-$VERSION-src-1.tgz"
             "$VERSION/source/XFree86-$VERSION-src-2.tgz"
             "$VERSION/source/XFree86-$VERSION-src-3.tgz" )
       URL="$XFREE86_URL"
#      REQ=( "freetype libpng ncurses"
       REQ=( "Xfenc Xfnts bison ed expat flex freetype libpng ncurses perl"
             "Linux-PAM:::for pluggable authentication"
             "Xf100:::for 100dpi fonts"
             "Xfcyr:::for Cryillic fonts"
             "Xfscl:::for Scalable Fonts (Speedo, Type1, and TrueType)" )
  HOMEPAGE="http://www.xfree86.org"
  EPROVIDE="x11"
   #   REQ="Xfenc Xfnts bison expat flex freetype libpng ncurses perl"
   # AVOID="OpenSP db gdbm linuxdoc-tools teTeX"
   PROTECT="/etc/X11/XF86Config
            /etc/X11/XftConfig.gdkxftsaved
            /usr/X11R6/lib/X11/app-defaults"
   EXCLUDE="/etc/X11/xdm/Xsession
            fonts.cache-1
            fonts.dir"
     WMBIN="/usr/X11R6/bin/twm"
 FRESHMEAT="xfree86"
  ESTIMATE="69086"
      DESC="XFree86 is a free implementation of the X Window System.    
XFree86 is a freely redistributable open-source
implementation of the X Window System that runs on UNIX(R).
XFree86 is the underlying software that is between the hardware
and graphical user interface (aka gui) that people see and use.
If you are using KDE, GNOME, Enlightenment, Blackbox, AfterStep,
twm or fvwm then you are already using and running XFree86 as
these run as our clients."

configure()  {

build_checklist()  {

  STATUS=$1
  LABEL=$2
  shift  2

  for  ITEM  in  $@;  do
    echo  $ITEM  $LABEL  $STATUS
  done

}

select_card_drivers()  {

  TITLE="Graphics Card Driver Selection Menu"
  HELP="Key:  [X] = on, [ ] = off"

  CHECKLIST="`build_checklist ON   Graphics   $ON_CARD_DRIVERS`
             `build_checklist OFF  Grahpics  $OFF_CARD_DRIVERS`"

  if  XF86CardDrivers=`dialog  --backtitle  "$BACKTITLE"  \
                               --title      "$TITLE"      \
                               --stdout                   \
                               --separate-output          \
                               --checklist  "$HELP"       \
                               18 55 10                   \
                               $CHECKLIST`
  then
     ON_CARD_DRIVERS=$XF86CardDrivers
    OFF_CARD_DRIVERS=$CARD_DRIVERS

    for  ITEM  in  $ON_CARD_DRIVERS;  do
      OFF_CARD_DRIVERS=`echo  $OFF_CARD_DRIVERS  |  sed  s/$ITEM//`
    done
  fi

}


select_dridrivers()  {

  TITLE="DRI Driver Selection Menu"
  HELP="Not all XFree86 supported graphics cards have DRI.
Key:  [X] = on, [ ] = off"

    CHECKLIST="`build_checklist  ON   DRI   $ON_DRI`
               `build_checklist  OFF  DRI  $OFF_DRI`"

  if  DriDrivers=`dialog  --backtitle  "$BACKTITLE"  \
                          --title      "$TITLE"      \
                          --stdout                   \
                          --separate-output          \
                          --checklist  "$HELP"       \
                          18 55 10                   \
                          $CHECKLIST`
  then
     ON_DRI=$DriDrivers
    OFF_DRI=$DRI

    for  ITEM  in  $ON_DRI;  do
      OFF_DRI=`echo  $OFF_DRI  |  sed  s/$ITEM//`
    done
  fi

}


select_input_drivers()  {

  TITLE="Input Driver Selection Menu"
  HELP="Key:  [X] = on, [ ] = off"

  CHECKLIST="`build_checklist  ON   Input   $ON_INPUT_DRIVERS`
             `build_checklist  OFF  Input  $OFF_INPUT_DRIVERS`"

  if  XInputDrivers=`dialog  --backtitle  "$BACKTITLE"  \
                             --title      "$TITLE"      \
                             --stdout                   \
                             --separate-output          \
                             --checklist  "$HELP"       \
                             18 55 10                   \
                             $CHECKLIST`
  then
     ON_INPUT_DRIVERS=$XInputDrivers
    OFF_INPUT_DRIVERS=$INPUT_DRIVERS

    for  ITEM  in  $ON_INPUT_DRIVERS;  do
      OFF_INPUT_DRIVERS=`echo  $OFF_INPUT_DRIVERS  |  sed  s/$ITEM//`
    done
  fi

}


initialize()  {

  BACKTITLE="Sorcery XFree86 host.def Configuration Menu"

   ON_CARD_DRIVERS="vga vesa v4l"
  OFF_CARD_DRIVERS="mga glint nv tga s3 s3virge sis rendition 
                    neomagic i740 tdfx savage 
                    cirrus vmware tseng trident chips apm
                    GlideDriver i128 NscDriver
                    ati i810 ark 
                    cyrix siliconmotion via 
                    fbdev dummy imstt newport"
      CARD_DRIVERS="$ON_CARD_DRIVERS  $OFF_CARD_DRIVERS"


   ON_DRI=""
  OFF_DRI="gamma i810 i830 mga r128 radeon r200 sis tdfx ffb"
      DRI="$ON_DRI  $OFF_DRI"


   ON_INPUT_DRIVERS="mouse keyboard"
  OFF_INPUT_DRIVERS="acecad calcomp citron 
                     digitaledge dmc dynapro elographics tek4957 
                     microtouch mutouch penmount spaceorb summa 
                     wacom void magellan hyperpen 
                     jamstudio fpit palmax"
      INPUT_DRIVERS="$ON_INPUT_DRIVERS  $OFF_INPUT_DRIVERS"


  YES_MISC_OPTIONS="BuildXF86DRI BuildGLULibrary BuildGLXLibrary BuildGlxExt BuildLBX BuildXCSecurity ForceNormalLib HasAgpGart HasCplusplus HasShm XnestServer XprtServer"
   NO_MISC_OPTIONS="BuildFontServer   InstallFSConfig
                    BuildServersOnly  BuildPexExt  BuildXF86DRM
                    BuildXF86RushExt  LinuxFBDevSupport 
                    XVirtualFramebufferServer"
      MISC_OPTIONS="$YES_MISC_OPTIONS  $NO_MISC_OPTIONS"
# BuildXAudio BuildXAServer 

  TARGET_CONFIG="$CONFIG_LOGS/$SPELL/host.def"

}


generate_host_def()  {

  if  [  -z  "$XF86CardDrivers"  ];  then
  XF86CardDrivers="$ON_CARD_DRIVERS"
  fi

  echo  "#define XF86CardDrivers $XF86CardDrivers"  |  tr  '\n' ' '
  echo

  if  [  -z  "$DriDrivers"  ]
  then  echo  "#define DriDrivers /**/"
  else  echo  "#define DriDrivers $DriDrivers"  |  tr  '\n' ' '
        echo
  fi

  if  [  -z  "$XInputDrivers"  ]
  then  echo  "#define XInputDrivers mouse"
  else  echo  "#define XInputDrivers $XInputDrivers"  |  tr  '\n' ' '
        echo
  fi

  for  ITEM  in  $YES_MISC_OPTIONS;  do  echo  "#define $ITEM YES";  done
  for  ITEM  in   $NO_MISC_OPTIONS;  do  echo  "#define $ITEM  NO";  done

}


save_host_def()  {


  dialog  --backtitle  "$BACKTITLE"  \
          --msgbox     "Saving Configuration to $TARGET_CONFIG"  \
          8 60

  generate_host_def  >  $TARGET_CONFIG

}


select_misc_options() {

  TITLE="Select Misc Options"
  CHECKLIST="`build_checklist  ON   Option  $YES_MISC_OPTIONS`
             `build_checklist  OFF  Option   $NO_MISC_OPTIONS`"
  HELP="Key:  [X] = on, [ ] = off"

  if  ON_MISC_OPTIONS=`dialog  --backtitle  "$BACKTITLE"  \
                               --title      "$TITLE"      \
                               --stdout                   \
                               --separate-output          \
                               --checklist  "$HELP"       \
                               18 55 10                   \
                               $CHECKLIST`
  then
    YES_MISC_OPTIONS=$ON_MISC_OPTIONS
     NO_MISC_OPTIONS=$MISC_OPTIONS

    for  ITEM  in  $YES_MISC_OPTIONS;  do
      NO_MISC_OPTIONS=`echo  $NO_MISC_OPTIONS  |  sed  s/$ITEM//`
    done
  fi

}


configure_host_def()  {

  initialize

  while  

    COMMAND=`dialog  --backtitle  "$BACKTITLE"                        \
                     --stdout                                         \
                     --title  "Main Menu"                             \
                     --default-item  $COMMAND                         \
                     --nocancel                                       \
                     --menu                                           \
                     ""                                               \
                     18 55 10                                         \
                     "XF86CardDrivers"  "Select Video Card Drivers"   \
                     "DriDrivers"       "Select Direct DRI Drivers"   \
                     "XInputDrivers"    "Select Input Drivers"        \
                     "Misc"             "Set other Options"           \
                     "Save"             "Save current configuration"  \
                     "Edit"             "Edit host.def"               \
                     "Exit"             "Done here.  Start building"`
  do

    case  $COMMAND  in
                 Exit)  break  ;;
                 Save)  save_host_def  ;;
                 Edit)  [  -n   "$EDITOR"  ]                   &&
                        $EDITOR  $CONFIG_LOGS/$SPELL/host.def  ||
                        nano     $CONFIG_LOGS/$SPELL/host.def  ;;
      XF86CardDrivers)  select_card_drivers   ;;
           DriDrivers)  select_dridrivers     ;;
        XInputDrivers)  select_input_drivers  ;;
                 Misc)  select_misc_options   ;;
    esac
  done

}

 if    !  [  -f  $CONFIG_LOGS/$SPELL/host.def  ]
 then  configure_host_def
 fi
}


build()  {

symlink_install()  {

  rm     -f  /usr/X11R6/include/zlib.h
  rm     -f  /usr/X11R6/lib/libz.a
  mkdir  -p  /usr/X11R6/include/GL

  if  [  !  -e                /etc/skel/.xsession  ];  then
    cp  $SCRIPT_DIR/xsession  /etc/skel/.xsession
    ln  -sf        .xsession  /etc/skel/.xinitrc
  fi

  if    [  !  -e                    /usr/bin/X11  ]
  then  ln    -sf   /usr/X11R6/bin  /usr/bin/X11
  fi

  if    [  !  -e          /usr/X11  ]
  then  ln    -sf  X11R6  /usr/X11
  fi

  if    [  !  -e                         /usr/include/X11  ]
  then  ln    -sf  ../X11R6/include/X11  /usr/include/X11
  fi

  if    [  !  -e                     /usr/lib/X11  ]
  then  ln    -sf  ../X11R6/lib/X11  /usr/lib/X11
  fi

}


pkgconf_install()  {
              ULP="/usr/lib/pkgconfig"
  mkdir  -p  $ULP
  cp     -a  /usr/X11R6/lib/pkgconfig/*  $ULP
}


 if    [  -f  $CONFIG_LOGS/$BSPELL/host.def  ];  then
  cat        $CONFIG_LOGS/$BSPELL/host.def    |
  sed  "s:BuildXF86DRM YES:BuildXF86DRM NO:"  >  \
  config/cf/host.def

  (
  echo  "#define DefaultCCOptions       $CFLAGS"
  echo  "#define DefaultGcc2i386Opt     $CFLAGS"
  echo  "#define LibraryCDebugFlags     $CFLAGS"
  echo  "#define DefaultCDebugFlags     $CFLAGS"
  echo  "#define OptimizedCDebugFlags   $CFLAGS"
  echo  "#define LOCAL_LDFLAGS          ${LDFLAGS:--Wl,-s}"
  echo  "#define HasZlib                YES"
  echo  "#define InstallXdmConfig       YES"
  echo  "#define InstallXinitConfig     YES"

  # The following group of lines is to enable building of
  # /usr/X11R6/lib/modules/fonts/libfreetype.a
  #   echo  "#define BuildFreeType          NO"
  echo  "#define HasFreetype            YES"
  echo  "#define BuildFreetypeLibrary   NO"
  echo  "#define UseFreetype            YES"
  echo  "#define FreetypeLibDir         /usr/lib"

  echo  "#define HasFreetype2           YES"
  echo  "#define BuildFreetype2Library  NO"
  echo  "#define UseFreetype2           YES"
  echo  "#define Freetype2LibDir        /usr/lib"

  #    echo  "#define HasFontconfig          YES"
  #    echo  "#define UseFontconfig          YES"
  #    echo  "#define BuildFontconfigLibrary NO"
  #    echo  "#define FontconfigLibDir       /usr/lib"

  #    echo  "#define BuildXftLibrary        NO"
  #    echo  "#define BuildXft1Library       NO"

  echo  "#define BuildFonts             NO"

  echo  "#define HasExpat               YES"

  echo  "#define BuildXinerama          YES"
  echo  "#define BuildXineramaLibrary   YES"
  echo  "#define NormalLibXinerama      YES"
  echo  "#define SharedLibXinerama      YES"

  )  >> config/cf/host.def

 fi

 if    spell_installed  "$( get_provider  Linux-PAM  )"
 then  echo  "#define  HasPam  YES"  >>  config/cf/site.def
 fi

 sed  -i  "s:/usr/bin/cpp:cpp:"  config/cf/linux.cf

 make    World        &&
 prepare_install      &&
 make    install      &&
 make    install.man  &&
 symlink_install      &&
 pkgconf_install
}

post_install() {
  default_post_install
  unlock_cast

  if    spell_installed  NVIDIA_GLX  ||
        spell_installed  NVIDIA-Linux-x86
  then  cast             NVIDIA-Linux-x86
  fi

  if    spell_installed  ati_firegl
  then  cast             ati_firegl
  fi

  if    spell_installed  Xprint
  then  cast             Xprint
  fi

  if    spell_installed  xft
  then  cast             xft
  fi

  cast  xft  libXft  fontconfig

  fc-cache
  true
}
