#!/bin/bash
# Copyright 2011 by Kyle Sallee,
# All rights reserved.
# For use with the Sorcerer distribution only.

# sentinel-sync periodically synchronizes installed software

neglected(){
 [ -n "$( find /etc/sorcery/log/version/ -name grimoire\* -mtime +$DAYS )" ]
}

scan(){ if neglected; then augur sync < /dev/null; fi; }

main(){
 if   [ -f /var/log/sorcery/resume/sorcerer-sentient ]
 then sleep  60; augur sync < /dev/null
 else sleep 900; scan
 fi
 while sleep 21600; do scan; done
}

DAYS="${1:-7}"
if (( DAYS > 2 )); then (( DAYS-- )); fi

if   [[     -x /usr/libexec/bash/sleep ]]
then enable -f /usr/libexec/bash/sleep sleep
fi

main &>/dev/null &
exit 0
