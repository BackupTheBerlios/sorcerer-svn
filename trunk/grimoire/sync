# Copyright 2012 by Kyle Sallee, All Rights Reserved.
# For use exclusively with Sorcerer distributed by Kyle Sallee.

# spell not yet tested.
# spell will replace code in cast and augur for synchronization.

   version stable stable
  category utility
 attribute archive_off solo sorcery
      info last 20120411
      info home http://sorcerer.silverice.org/
      desc 'sync is a utility spell for synchronizing installed software
sync downloads a new grimoire if necessary,
downloads a newer sorcery if necessary
and updates installed software according to the
grimoire and SA's specifications.

This spell will re-queue itself in order to cast all spells.
'

build(){ :; }

post_install(){

 req_event(){
  local REPLY
  while read; do
   event "$REPLY" "$( available_version "$REPLY" )" "Cast Req"
   echo  "$REPLY"
  done | pipe_queue "$CAST_QUEUE"
 }

 showcc(){ 
  [ -d "$CAST_QUEUE" ] &&
  find "$CAST_QUEUE/"    -maxdepth 1 -mindepth 1 -type f -empty -printf "%f\n"
  [ -d "$CAST_QUEUE/new" ] &&
  find "$CAST_QUEUE/new" -maxdepth 1 -mindepth 1 -type f -empty -printf "%f\n"
 }

 not_active(){
  while read; do
   [ -f "$CAST_QUEUE/active/$REPLY" ] ||
   echo "$REPLY"
  done
 }

 fill_cast_queue(){ showcc | arofni | not_active | req_event; }

 no_recent_fails(){
  if [ -d "$CAST_QUEUE/failed" ]; then
   find   "$CAST_QUEUE/failed" -type f -mmin -60 -printf "%f\n" |
   while read; do rm -f "$CAST_QUEUE/new/$REPLY"; done
  fi
 }

 up_catalog(){
  get_provider grimoire | augur newer
  ( show_att grimoire; show_installed ) | sort | uniq -d | augur newer
  fill_cast_queue
  no_recent_fails
  queued check "$CAST_QUEUE/new"
 }

 up_sorcery(){
  get_provider grimoire | augur sorcery
  fill_cast_queue
  no_recent_fails
  queued check "$CAST_QUEUE/new"
 }

 up_all(){
  augur newer
  fill_cast_queue
  no_recent_fails
 }

 if   up_catalog; then touch "$CAST_QUEUE/sync"
 elif up_sorcery; then touch "$CAST_QUEUE/sync"
 else up_all
 fi

 default_post_install
}
