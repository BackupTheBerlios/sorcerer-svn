# akonadi requires qt-everywhere-opensource with mysql server support.
# mysql server must be running for akonadi to use.

# some unspecified compile error during version 5.5.17
# now version 5.5.16 also is not compiling

   version stable 5.5.23 5.5.22 5.5.21 5.5.20 5.5.19 5.5.18
   version legacy 5.1.59 5.1.56 5.1.55
   version unstable 6.0.11
   require db cmake gcc-g++ init-functions libaio ncurses openssl readline zlib
      opts -DCMAKE_BUILD_TYPE:STRING=Release
      opts -DCMAKE_INSTALL_PREFIX:PATH=/usr
#     opts -DMYSQL_DATADIR:PATH=/usr/share
      opts -DMYSQL_DATADIR:PATH=/var/lib/mysql
      opts -DWITH_PIC:BOOL=TRUE
      opts -DWITH_SSL:STRING=system
      opts -DWITH_EMBEDDED_SERVER:BOOL=ON
#     opts -DWITH_EMBEDDED_SERVER:BOOL=TRUE
# The following did not fix the header file installation location
#     opts INSTALL_INCLUDEDIR:STRING=include/mysql
  sys_user mysql mysql /var/lib/mysql
  category db
 attribute console library lto_off makej
case $PROGRESS in
 legacy)
 attribute multilib-dual ;;
      *)
 attribute multilib-concurrent ;;
esac
    source $MYSQL_URL MySQL-${VERSION:0:3}/mysql-$VERSION.tar.gz
      info vurl http://dev.mysql.com/downloads/mysql/${VERSION:0:3}.html
      info last 20120416
      info home http://www.mysql.com
   exclude /var/lib/mysql
      desc 'SQL database server.

mysql is a widely used and fast SQL database server.
It is a client/server implementation that consists
of a server daemon (mysqld) and client programs/libraries.'

build(){
 sed -i 's:"data":"/var/lib/mysql":' cmake/install_layout.cmake

 if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
 then OPTS+=" -DINSTALL_LIBDIR:STRING=lib64"
 fi

 default_build &&
 if   [ -f      $DESTDIR/usr/include/mysql.h ]; then
  mv            $DESTDIR/usr/include $DESTDIR/usr/mysql
  mkdir -pm 755 $DESTDIR/usr/include
  mv            $DESTDIR/usr/mysql   $DESTDIR/usr/include/
 fi
}

build_legacy(){
 # It will not compile with --disable-static

 local LIBDIR=/usr/lib

 if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
 then LIBDIR+=64
 fi

 OPTS="--without-readline --with-pthread --with-embedded-server"

 # Added -fno-exceptions -felide-constructors -fno-rtti
 # From http://dev.mysql.com/doc/refman/5.1-maria/en/installing-source.html

 export   CFLAGS+=' -fPIC -fno-exceptions'
 export CXXFLAGS+=' -fPIC -fno-exceptions -felide-constructors -fno-rtti'

 ./configure                     \
  --prefix=/usr                  \
  --with-pic                     \
  --enable-assembler             \
  --enable-thread-safe-client    \
  --localstatedir=/var/lib/mysql \
  --enable-shared                \
  --with-mysqld-user=mysql       \
  --with-extra-charsets=complex  \
  --exec-prefix=/usr             \
  --libexecdir=/usr/sbin         \
  --sysconfdir=/etc              \
  --datadir=/usr/share           \
  --infodir=/usr/info            \
  --includedir=/usr/include      \
  --mandir=/usr/man              \
  --with-server-suffix='-Max'    \
  --with-plugins=all             \
  --with-comment="MySQL-MAX-$VERSION " \
  --with-unix-socket-path=/var/lib/mysql/mysql.sock \
  $OPTS &&
  make pkglibdir=$LIBDIR &&
  make pkglibdir=$LIBDIR install DESTDIR=$DESTDIR &&
  mkdir  -pvm 755 $DESTDIR/etc &&
  install -vm 700 support-files/my-medium.cnf $DESTDIR/etc/my.cnf
}

post_install(){
 /usr/scripts/mysql_install_db --user mysql
 chown -R mysql:mysql /var/lib/mysql
 default_post_install
 mysql_upgrade --user mysql
 echo "Please run mysql_secure_installation if it has not been run yet."
}

current(){
 case $VERSION in
  5.5.8) [ -f /usr/lib/libmysqld.a ] || [ -f /usr/lib64/libmysqld.a ] ;;
 esac
}
