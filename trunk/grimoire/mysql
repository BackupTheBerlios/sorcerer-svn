# akonadi requires qt-x11-opensource with mysql server support.
# mysql server must be running for akonadi to use.

# Added -fPIC to CFLAGS and CXXFLAGS therefore ./configure --with-pic not required.
# It will not compile with --disable-static

    stable 5.1.41 5.1.40 5.1.39 5.1.38 5.1.37 5.1.36
  unstable 6.0.11 6.0.10 6.0.8
    secure 5.0.51b
   require db init-functions ncurses openssl readline zlib
      opts --without-readline --with-pthread --with-embedded-server
  category db
 attribute console
       url $MYSQL_URL
    source MySQL-${VERSION:0:3}/mysql-$VERSION.tar.gz
      vurl http://dev.mysql.com/downloads/mysql/${VERSION:0:3}.html
  homepage http://www.mysql.com
   exclude /var/lib/mysql
  estimate 9000
      desc 'SQL database server.

mysql is a widely used and fast SQL database server.
It is a client/server implementation that consists
of a server daemon (mysqld) and client programs/libraries.'

build() {
mkdir    -p -m 755 /var/lib/mysql
groupadd -K GID_MIN=256 -K GID_MAX=511    mysql                         2>/dev/null
useradd  -K UID_MIN=256 -K UID_MAX=511 -g mysql -d /var/lib/mysql mysql 2>/dev/null
chown    -R mysql:mysql /var/lib/mysql

# Added -fno-exceptions -felide-constructors -fno-rtti
# From http://dev.mysql.com/doc/refman/5.1-maria/en/installing-source.html

export   CFLAGS+=' -fPIC -fno-exceptions'
export CXXFLAGS+=' -fPIC -fno-exceptions -felide-constructors -fno-rtti'

./configure                    \
--prefix=/usr                  \
--enable-assembler             \
--enable-thread-safe-client    \
--localstatedir=/var/lib/mysql \
--enable-shared                \
--with-mysqld-user=mysql       \
--with-extra-charsets=complex  \
--exec-prefix=/usr             \
--libexecdir=/usr/sbin         \
--sysconfdir=/etc              \
--datadir=/usr/share           \
--infodir=/usr/info            \
--includedir=/usr/include      \
--mandir=/usr/man              \
--with-server-suffix='-Max'    \
--with-plugins=all             \
--with-comment="MySQL-MAX-$VERSION " \
--with-unix-socket-path=/var/lib/mysql/mysql.sock \
$OPTS                              &&
make            pkglibdir=/usr/lib &&
prepare_install                    &&
make    install pkglibdir=/usr/lib &&
install -m 700 support-files/my-medium.cnf /etc/my.cnf

## Use grimoire provided init-script instead
#install -m 700 support-files/mysql.server  /etc/init.d/mysql && 
}

post_install(){
 mysql_install_db --user mysql
 chown -R mysql:mysql /var/lib/mysql
 default_post_install
 mysql_upgrade --user mysql
 echo "Please run mysql_secure_installation if it has not been run yet."
}
