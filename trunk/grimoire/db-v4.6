# undefined reference to `db_strerror'
# db 4.7.25 has an API change that is incompatible with
# reland and some other programs.

# remeber check /usr/lib/libdb-4.6.so or whatever library it installs
# to make sure it linked with libpthread.

    stable 4.6.21
    ignore '\.NC\|cd'
  category db
 attribute library
    source db-$VERSION.tar.gz
#            "patch.$VERSION.1" )
#      url ftp://sleepycat1.inetu.net/releases/
       url http://download.oracle.com/berkeley-db/
       url http://www.oracle.com/technology/products/berkeley-db/xml/update/$VERSION/

#            "http://www.oracle.com/technology/products/berkeley-db/db/update/$VERSION/" )
#            "http://www.sleepycat.com/update/$VERSION/" )
#            "http://www.sleepycat.com/update/snapshot"
# j2sdk is not gcc 3.4.1 compatibile.
# and so we must get rid of it for db to link
      opts --enable-static=no
 conflicts j2sdk
#  Removing j2sdk as an optional requirement helps
#  avoid a recrusive requirement loop
#   'j2sdk:--enable-java::for java support'
# homepage http://www.sleepycat.com
  homepage http://www.oracle.com/technology/software/products/berkeley-db/db/index.html
      vurl http://www.oracle.com/technology/software/products/berkeley-db/db/index.html
 freshmeat berkeleydb
  estimate 900
      desc 'db also called Berkeley DB provides database support.
db also called Berkeley DB is a programmatic toolkit that provides 
fast, reliable, scalable, and mission-critical database support in 
software ranging from applications running on hand-held appliances 
to enterprise-scale servers.'

build(){
case $VERSION in
 4.6.21) patch -p0 < $SCRIPT_DIR/patch.4.6.21.1 ;;
esac

PCX=1
while [ -n "${SOURCE[$PCX]}" ]; do
 patch -p0 < $SOURCE_CACHE/$SPELL/$VERSION/${SOURCE[$PCX]}
 (( PCX++ ))
done

if   spell_installed $( get_provider j2sdk )
then opts ${OPTS} --enable-java
fi

cd build_unix &&
../dist/configure  \
--prefix=/opt/db/4.6 \
--build=$BUILD     \
--enable-dynamic   \
--enable-compat185 \
--enable-cxx       \
$OPTS              &&
make               &&
prepare_install    &&
make    install    &&
rm -rf /usr/docs
}


post_install(){
 default_post_install
           get_provider openldap |
 pipe      show_installed        |
 LC_ALL=C  sort                  |
           uniq -d               |
           pipe_queue $CAST_QUEUE com
}


current(){
case $VERSION in
 4.6.21) grep -qx 'patching file mp/mp_sync.c' $COMPILE_LOGS/db ;;
esac
}
