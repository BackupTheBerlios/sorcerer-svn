   VERSION=( 4.1.0 4.0.18.2 4.0.17 4.0.18.1 4.0.18 )
# 4.1.0 refuses root login if /etc/securetty exists
# and correctly allows root login on tty1 through tty12
# a shadow bug maybe?
# Sat Jun 23 05:03:40 UTC 2007
# Where has shadow source gone?
# 4.0.18.1 has broken useradd
# what version of shadow has a working useradd?
    IGNORE='^4\.0\.[8-9]\|^4\.0\.10'
  CATEGORY='security/authentication'
 ATTRIBUTE='console'
    SOURCE=( "shadow_$VERSION.orig.tar.gz" )
case  $VERSION  in
  4.0.18.2)  SOURCE[1]="shadow_4.0.18.2-1.diff.gz"  ;;
esac

       URL='http://ftp.us.debian.org/debian/pool/main/s/shadow/'
#       URL='ftp://ftp.pld.org.pl/software/shadow/
#            ftp://ftp.pld.org.pl/software/shadow/old/'
#  HOMEPAGE='http://shadow.pld.org.pl/'
# Shadow no longer has a homepage?
# Switching to debian maintained shadow
       REQ=( ''
             'Linux-PAM:--with-libpam:--without-libpam:for pluggable authnetication'
             'libselinux:--with-selinux:--without-selinux:for selinux support' )
      OPTS='--enable-shared'
   EXCLUDE='/etc/group
            /etc/group-
            /etc/passwd
            /etc/passwd-
            /etc/shadow
            /etc/shadow-'
   PROTECT='/var/log/lastlog'
#           /etc/securetty'
  ESTIMATE='1400'
      DESC='shadow contains the shadow password file utilities.
shadow contains password file utilities necessary to convert
traditional V7 UNIX password files to the SVR4 shadow password format,
and additional tools to maintain password and group files
(that work with both shadow and non-shadow passwords).'

build() {

  move_ar_libs()  {
    for              file  in  /lib{,64}/libshadow.{a,la};  do
      if    [   -f  $file  ]
      then  mv  -v  $file  /usr/$file
      fi
    done
  }

  link_so_libs()  {
    for              file  in  /lib{,64}/libshadow.so*;  do
      if    [   -f  $file  ]
      then  ln  -sv $file  /usr/$file
      fi
    done
  }


with_pam_fix()  {

echo  'FAILLOG_ENAB
LASTLOG_ENAB
MAIL_CHECK_ENAB
OBSCURE_CHECKS_ENAB
PORTTIME_CHECKS_ENAB
QUOTAS_ENAB
MOTD_FILE
FTMP_FILE
NOLOGINS_FILE
ENV_HZ
ENV_SUPATH
ENV_PATH
PASS_MIN_LEN
SU_WHEEL_ONLY
CRACKLIB_DICTPATH
PASS_CHANGE_TRIES
PASS_ALWAYS_WARN
CHFN_AUTH
ENVIRON_FILE'  |
while  read
do     sed  -i  "s:^$REPLY:#$REPLY:"  login.defs
done

}

install_conf()  {
cd       etc
echo  "$OPTS"            |
grep  -q  'with-libpam'  &&
with_pam_fix

                         MCE='MD5_CRYPT_ENAB'
sed      -i 's:#$MCE no:$MCE yes:'  login.defs
install  -m 0644  -o root  -g root  login.defs    /etc/login.defs
install  -m 0644  -o root  -g root  login.access  /etc 
install  -m 0644  -o root  -g root  limits        /etc
#mkdir    -p                                       /etc/defaults

install  -m 0755  -o root  -g root  $SCRIPT_DIR/adduser   /usr/sbin
install  -m 0755  -o root  -g root  $SCRIPT_DIR/deluser   /usr/sbin
#install  -m 0600  -o root  -g root  $SCRIPT_DIR/securetty /etc
echo '* U1024'  >> /etc/limits
echo 'root -'   >> /etc/limits
}

# note due to bug in sed -ir does not work but -ri does work.
sed  -ri  's:(GID_MIN.*) 100$:\11024:
           s:(UID_MIN.*)1000$:\11024:
           s:FAIL_DELAY:# FAIL_DELAY:'  etc/login.defs
sed  -i  '/GROUP=/d;s:/users::'         etc/useradd

if    [  -n  "${SOURCE[1]}"  ]
then  decompress  "$SOURCE_CACHE/shadow/$VERSION/${SOURCE[1]}"  |
      patch  -p1
fi

if    [  -d      debian/patches  ];  then  
  for  file  in  debian/patches/[0-9]*
  do   # grep  -q  "src/grpck.c"  $file  ||
       patch  -p1  <  $file
  done
fi

      
default_build  &&
move_ar_libs   &&
link_so_libs   &&
install_conf
}


current()  {
  case  $VERSION  in
    4.0.18.2)  ! grep  -q  "^FAIL_DELAY"  /etc/login.defs  ;;
    4.0.17)  [  -f  /usr/lib/libshadow.la    ]  ||
             [  -f  /usr/lib64/libshadow.la  ]  ;;
  esac
#   4.0.18.2)  grep  -q  "patching file debian/patches/"  $COMPILE_LOGS/shadow  ;;
}
