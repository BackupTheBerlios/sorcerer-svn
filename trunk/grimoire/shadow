# 4.1.1 quit building and installing libshadow.so*
# I wonder if that causes a problem?

# 4.1.0 refuses root login if /etc/securetty exists
# and correctly allows root login on tty1 through tty12
# a shadow bug maybe?

# stable 4.1.1 4.1.0
    stable 4.1.0
   require Linux-PAM libselinux
  category security/authentication
 attribute console
    source http://ftp.us.debian.org/debian/pool/main/s/shadow/shadow_$VERSION.orig.tar.gz

#            'Linux-PAM:--with-libpam:--without-libpam:for pluggable authnetication' )
#            'libselinux:--with-selinux:--without-selinux:for selinux support' )
      opts --enable-shared --enable-static=no
   exclude /etc/group
   exclude /etc/group-
   exclude /etc/passwd
   exclude /etc/passwd-
   exclude /etc/shadow
   exclude /etc/shadow-
   protect /var/log/lastlog
#  protect /etc/securetty
  estimate 1400
      desc 'shadow contains the shadow password file utilities.
shadow contains password file utilities necessary to convert
traditional V7 UNIX password files to the SVR4 shadow password format,
and additional tools to maintain password and group files
(that work with both shadow and non-shadow passwords).'

build(){
 move_ar_libs(){
  for          file in /lib{,64}/libshadow.{a,la}; do
   if   [  -f $file ]
   then mv -v $file /usr/$file
   fi
  done
}

 link_so_libs(){
  for           file in /lib{,64}/libshadow.so*; do
   if   [  -f  $file ]
   then ln -sv $file /usr/$file
   fi
  done
 }


 with_pam_fix(){

echo  'FAILLOG_ENAB
LASTLOG_ENAB
MAIL_CHECK_ENAB
OBSCURE_CHECKS_ENAB
PORTTIME_CHECKS_ENAB
QUOTAS_ENAB
MOTD_FILE
FTMP_FILE
NOLOGINS_FILE
ENV_HZ
ENV_SUPATH
ENV_PATH
PASS_MIN_LEN
SU_WHEEL_ONLY
CRACKLIB_DICTPATH
PASS_CHANGE_TRIES
PASS_ALWAYS_WARN
CHFN_AUTH
ENVIRON_FILE'  |
  while  read
  do     sed -i "s:^$REPLY:#$REPLY:" login.defs
  done
 }

 install_conf(){
  cd   etc
  echo "$OPTS" | grep -q with-libpam && with_pam_fix

                           MCE='MD5_CRYPT_ENAB'
  sed      -i 's:#$MCE no:$MCE yes:'  login.defs
  install  -m 0644  -o root  -g root  login.defs    /etc/login.defs
  install  -m 0644  -o root  -g root  login.access  /etc 
  install  -m 0644  -o root  -g root  limits        /etc
 #mkdir    -p                                       /etc/defaults

  install  -m 0755  -o root  -g root  $SCRIPT_DIR/adduser   /usr/sbin
  install  -m 0755  -o root  -g root  $SCRIPT_DIR/deluser   /usr/sbin
 #install  -m 0600  -o root  -g root  $SCRIPT_DIR/securetty /etc
  echo '* U1024' >> /etc/limits
  echo 'root -'  >> /etc/limits

  chown root:auth /etc/shadow
  chmod 0640      /etc/shadow
 }

 # note due to bug in sed -ir does not work but -ri does work.
 sed -ri 's:(GID_MIN.*) 100$:\11024:
          s:(UID_MIN.*)1000$:\11024:
          s:FAIL_DELAY:# FAIL_DELAY:' etc/login.defs
 sed -i '/GROUP=/d;s:/users::'        etc/useradd

 if   [ -n "${SOURCE[1]}" ]
 then decompress "$SOURCE_CACHE/shadow/$VERSION/${SOURCE[1]}" | patch -p1
 fi

 if    [ -d   debian/patches ]; then  
  for file in debian/patches/[0-9]*
  do  patch -p1 < $file
  done
 fi

 mkdir    -pm 755 /var/empty
 groupadd -K GID_MIN=256 -K GID_MAX=511    auth                    2>/dev/null
 useradd  -K UID_MIN=256 -K UID_MAX=511 -g auth -d /var/empty auth 2>/dev/null

 if   spell_installed libselinux
 then OPTS+=' --with-selinux'; export LDFLAGS+=' -lselinux'
 else OPTS+=' --without-selinux'
 fi

 if   spell_installed Linux-PAM
 then OPTS+=' --with-libpam'
 else OPTS+=' --without-libpam'
 fi

 default_build &&
 move_ar_libs  &&
 link_so_libs  &&
 install_conf
}
