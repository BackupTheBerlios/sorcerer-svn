# to overcome the error:
# /usr/include/libavutil/common.h:154: error: 'UINT64_C' was not declared in this scope
# add a custom build to that spell such as:
#
# build(){
# # for ffmpeg version 0.6
#    CFLAGS+=' -D__STDC_CONSTANT_MACROS'
#  CXXFLAGS+=' -D__STDC_CONSTANT_MACROS'
#  export CFLAGS CXXFLAGS
#  default_build
# }


# opal version 3.6.4 requires ffmpeg 0.5
# Update and test linphone after updating ffmpeg, please.

    stable 0.6.1 0.6
   require bzip2 zlib
      opts --enable-swscale --enable-postproc --enable-gpl --enable-shared --enable-pthreads --disable-debug
    CFLAGS='-O3 -ffast-math'
   LDFLAGS='-Wl,-O1'
case $VERSION in
0.6.1) opts --enable-nonfree --disable-static ;;
  0.6) opts --enable-nonfree --disable-static ;;
0.5.2) opts --enable-nonfree ;;
0.5.1) opts --enable-nonfree ;;
esac

  optional x264      --enable-libx264    ''              for x264 support
  optional SDL       ''               --disable-ffplay   to build ffplay media player
  optional XviD      --enable-libxvid   ''               for XviD MPEG-4 codec support
  optional a52dec
  optional faac      --enable-libfaac    ''              for mpeg-2 and NBC/MPEG-4 decoding
  optional faad2     '--enable-gpl --enable-libfaad --enable-libfaadbin' '' for freeware advanced audio decoder support
# gsm source missing
# optional gsm       --enable-libgsm     ''              for gsm audio codec support
# --disable-vhook no longer supported
#  optional imlib2    ''                  --disable-vhook for video hooking support
  optional jackit
  optional lame      --enable-libmp3lame ''              to enable mp3 encoding via lame
  optional libtheora --enable-libtheora  ''              for theora video codec support
  optional libvorbis --enable-libvorbis  ''              to decode ogg/vorbis streams
  optional nasm      ''                  --disable-mmx   for MMX support
  category video
 attribute library
#attribute multilib-fail
    source http://www.ffmpeg.org/releases/ffmpeg-$VERSION.tar.bz2
  homepage http://ffmpeg.mplayerhq.hu/
  estimate 1600
      desc 'complete video and audio broadcasting solution
ffmpeg is a complete and free Internet live audio
and video broadcasting solution for Linux/Unix.
It also includes a digital VCR.
It can encode in real time in many formats including
MPEG1 audio and video, MPEG4, h263, ac3, asf, avi, real, mjpeg, and flash.'


build(){

 export   CFLAGS="${CFLAGS//-funroll-loops/}"
 export CXXFLAGS="${CXXFLAGS//-funroll-loops/}"
 export   CFLAGS="${CFLAGS//pentium-m /i686 }"
 export CXXFLAGS="${CXXFLAGS//pentium-m /i686 }"

 export  LDFLAGS+=' -ldl'

 if   ! grep flags < /proc/cpuinfo | grep -q mmx
 then OPTS+=' --disable-mmx'
 fi

# ffmpeg completely messes up on the installation of libraries
# when given --libdir
 if   [[ $HOSTTYPE == x86_64 ]] && [[ $CFLAGS =~ -m32 ]]
 then opts --disable-asm
# then opts --libdir=/usr/lib64 --disable-asm
# else opts --libdir=/usr/lib
 fi

 ./configure   \
 --prefix=/usr \
 $OPTS &&  sed -i 's:LDFLAGS=:LDFLAGS+=:' config.mak &&
 make  &&
 make install "DESTDIR=$DESTDIR" &&
 mkdir -p "$DESTDIR/etc" &&
 install -m 644 doc/ffserver.conf "$DESTDIR/etc" &&
 sed -i 's:-L${libdir}::' $DESTDIR/usr/lib/pkgconfig/*.pc &&
 if    [[ $HOSTTYPE == x86_64 ]]; then
  if   [[ $CFLAGS   =~ -m32   ]]; then mv $DESTDIR/usr/lib{,32}
  elif [[ -f /lib/libc.so.6   ]]; then mv $DESTDIR/usr/lib{,64}
                                       mv $DESTDIR/usr/lib{32,}
  fi
 fi
}
