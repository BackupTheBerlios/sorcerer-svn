# to overcome the error:
# /usr/include/libavutil/common.h:154: error: 'UINT64_C' was not declared in this scope
# add a custom build to that spell such as:
#
# build(){
# # for ffmpeg version 0.6
#    CFLAGS+=' -D__STDC_CONSTANT_MACROS'
#  CXXFLAGS+=' -D__STDC_CONSTANT_MACROS'
#  export CFLAGS CXXFLAGS
#  default_build
# }


# opal version 3.6.4 requires ffmpeg 0.5
# Update and test linphone after updating ffmpeg, please.

   version stable 0.6.3 0.6.2 0.6.1 0.6
   version unstable 0.7-rc1
   require bzip2 zlib
      opts --enable-swscale --enable-postproc --enable-gpl --enable-shared --enable-pthreads --disable-debug
    CFLAGS='-O3 -ffast-math'
   LDFLAGS='-Wl,-O1'
case $VERSION in
 0.6.3) opts --enable-nonfree --disable-static ;;
 0.6.2) opts --enable-nonfree --disable-static ;;
 0.6.1) opts --enable-nonfree --disable-static ;;
   0.6) opts --enable-nonfree --disable-static ;;
 0.5.2) opts --enable-nonfree ;;
 0.5.1) opts --enable-nonfree ;;
esac

  optional x264      --enable-libx264    ''              for x264 support
  optional SDL       ''               --disable-ffplay   to build ffplay media player
  optional XviD      --enable-libxvid   ''               for XviD MPEG-4 codec support
  optional a52dec
  optional faac      --enable-libfaac    ''              for mpeg-2 and NBC/MPEG-4 decoding
  optional faad2     '--enable-gpl --enable-libfaad --enable-libfaadbin' '' for freeware advanced audio decoder support
  optional gsm       --enable-libgsm     ''              for gsm audio codec support
# --disable-vhook no longer supported
#  optional imlib2    ''                  --disable-vhook for video hooking support
  optional jackit
  optional lame      --enable-libmp3lame ''              to enable mp3 encoding via lame
  optional libtheora --enable-libtheora  ''              for theora video codec support
  optional libvorbis --enable-libvorbis  ''              to decode ogg/vorbis streams
  optional libvpx    --enable-libvpx     ''              for WebM support
  optional nasm      ''                  --disable-mmx   for MMX support
  category video
 attribute library makej
    source http://www.ffmpeg.org/releases/ffmpeg-$VERSION.tar.bz2
      info last  20110501
      info home  http://ffmpeg.mplayerhq.hu/
      info docs  http://ffmpeg.org/documentation.html
  estimate 1600
      desc 'complete video and audio broadcasting solution
ffmpeg is a complete and free Internet live audio
and video broadcasting solution for Linux/Unix.
It also includes a digital VCR.
It can encode in real time in many formats including
MPEG1 audio and video, MPEG4, h263, ac3, asf, avi, real, mjpeg, and flash.'


build(){
 local ARCH

 export   CFLAGS="${CFLAGS//-funroll-loops/}"
 export CXXFLAGS="${CXXFLAGS//-funroll-loops/}"
 export   CFLAGS="${CFLAGS//pentium-m /i686 }"
 export CXXFLAGS="${CXXFLAGS//pentium-m /i686 }"

 export  LDFLAGS+=' -ldl'

 if   ! grep flags < /proc/cpuinfo | grep -q mmx
 then OPTS+=' --disable-mmx'
 fi

 if   [[ $HOSTTYPE == x86_64 ]] && [[ $CFLAGS =~ -m32 ]]
 then ARCH=i686
 else ARCH=$HOSTTYPE
 fi

 setarch $ARCH \
 ./configure   \
 --prefix=/usr \
 $OPTS &&  sed -i 's:LDFLAGS=:LDFLAGS+=:' config.mak &&
 setarch $ARCH  make  &&
 setarch $ARCH  make install "DESTDIR=$DESTDIR"     &&
 mkdir -pvm 755 "$DESTDIR/etc" &&
 install -m 644 doc/ffserver.conf "$DESTDIR/etc" &&
 sed -i 's:-L${libdir}::' $DESTDIR/usr/lib/pkgconfig/*.pc &&
 if    [[ $HOSTTYPE == x86_64   ]]; then
  if   [[ $CFLAGS   =~ -m32     ]]; then mv $DESTDIR/usr/lib{,32}
                                    else mv $DESTDIR/usr/lib{,64}
    if [[ -d $DESTDIR/usr/lib32 ]]; then mv $DESTDIR/usr/lib{32,}; fi
  fi
 fi
}
