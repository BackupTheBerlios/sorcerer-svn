# 9.04_src_all segmentation faults when run.

    stable 9.04 4.65 4.61 4.58 4.57 4.55
  category archive
 attribute console
       url $SOURCEFORGE_URL
    source p7zip/p7zip/$VERSION/p7zip_${VERSION}_src_all.tar.bz2
  homepage http://p7zip.sourceforge.net
     CFLAGS='-O3'
   CXXFLAGS='-O3'
    LDFLAGS='-Wl,-s -Wl,-O1'
#   LDFLAGS='-Wl,-s -Wl,-O1 -static'
   protect /bin/7za
  estimate 320
      desc 'command line high compression ratio archiver
p7zip provides aproximately 15% better compression than bzip2.
Compression speed is about 400% slower than bzip2.
Decompression speed is about the same as gzip.'

# When compiling -O3 using uClibc 7za segfaults when run.
# uncertain if LDFLAGS are being used.

#if [ -f $INSTALL_LOGS/gcc-uClibc ]; then
# use_gcc gcc-uClibc
#   CFLAGS='-Os'
# CXXFLAGS='-Os'
#  LDFLAGS='-Wl,-O1'
#fi

build(){
build_old(){
  # export LDFLAGS+=' -static -lstdc++ -dynamic'
  # no easy way to only statically link libstdc++ ?

 make OPTFLAGS="$CXXFLAGS" all &&
 prepare_install &&
       ./install.sh /bin /usr/lib/p7zip /usr/man /usr/share/p7zip &&

 if   [ -f /usr/lib/p7zip/7za ]
 then mv   /usr/lib/p7zip/7za       /bin
      mv   /usr/lib/p7zip/7zCon.sfx /bin
 fi
}

sed -i 's:/usr/local:/usr:' makefile
make all 7z OPTFLAGS="$CXXFLAGS" &&
rm -f bin/7za   &&
make all OPTFLAGS="$CXXFLAGS -static" &&
prepare_install &&
make    install &&
rm -f /usr/bin/7za &&
mv    /usr/lib/p7zip/7za /bin/
}
