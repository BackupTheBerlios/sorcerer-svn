# During 2.12.1 compilation:

# if test -r /usr/src/sorcery/.destdir/glibc/usr/include/gnu/stubs-32.h && cmp -s /usr/src/sorcery/glibc/glibc-2.12.1/build/stubs.h /usr/src/sorcery/.destdir/glibc/usr/include/gnu/stubs-32.h; \
#        then echo 'stubs.h unchanged'; \
#        else /usr/bin/install -c -m 644 /usr/src/sorcery/glibc/glibc-2.12.1/build/stubs.h /usr/src/sorcery/.destdir/glibc/usr/include/gnu/stubs-32.h; fi
# rm -f /usr/src/sorcery/glibc/glibc-2.12.1/build/stubs.h
# /usr/src/sorcery/glibc/glibc-2.12.1/build/elf/sln /usr/src/sorcery/glibc/glibc-2.12.1/build/elf/symlink.list
# make[1]: *** [install-symbolic-link] Segmentation fault

# the new sln statically linked ln executable segfaulted during install?
# glibc-2.12.1/build/elf/sln /tmp/1 /tmp/2
# unexpected reloc type in static binarySegmentation fault
# yup, strange.

# Update glibc-locales and when updating glibc
# has rpath of $ORIGIN encoded in it, very strange, what does it do?

# 2.12.1 fails compilation
# make[2]: Entering directory `/usr/src/sorcery/glibc/glibc-2.12.1/manual'
# Makefile:235: *** mixed implicit and normal rules.  Stop.
# make[2]: Leaving directory `/usr/src/sorcery/glibc/glibc-2.12.1/manual'

    stable 2.11.2 2.11.1 2.11 2.10.1
# unstable 2.12.1
  category development
 attribute library solo
   require perl linux-headers
      opts --without-selinux
  optional prelink '' '' for faster loading ELFs
    source $GNU_URL glibc/glibc-$VERSION.tar.xz
  homepage http://www.gnu.org/software/libc
   exclude /etc/ld.so.cache
   exclude /etc/ld.so.conf
   exclude /etc/localtime
   protect /etc/hostname
   protect /etc/hosts
   protect /etc/host.conf
   protect /etc/hosts
   protect /etc/hosts.allow
   protect /etc/hosts.deny
   protect /etc/hosts.equiv
   protect /etc/hosts.lpd
   protect /etc/networks
   protect /etc/nsswitch.conf
   protect /etc/resolv.conf
   protect /lib/ld-linux.so.2
   protect /lib64/ld-linux-x86-64.so.2
   protect /sbin/ldconfig
case $HOSTTYPE in
 x86_64) RPATH='/usr/lib64/gconv' ;;
      *) RPATH='/usr/lib/gconv'   ;;
esac
  estimate 19000
      desc 'GNU implementation of a C library'

build(){ (

 install_glibc(){
  install -vm 600 ../nscd/nscd.conf $DESTDIR/etc/
  mkdir   -vp                       $DESTDIR/var/db
  mkdir   -vm 700                   $DESTDIR/var/db/nscd

  cd    $DESTDIR
  rm -f $DESTDIR/etc/{localtime,ld.so.*}
 }


 quick_test(){
  echo "Performing a quick test to see if the new glibc works."
  if   LD_LIBRARY_PATH="$LLP" $LD_SO /bin/true
  then echo "glibc is ready to install."
  else echo "glibc is not working as expected."
       echo "Compilation aborted before installing new glibc."
       false
  fi
 }


 supported_locales(){
  mkdir -p                      $DESTDIR/usr/share/i18n
  cp    ../localedata/SUPPORTED $DESTDIR/usr/share/i18n
 }


 unset  LTDL_LIBRARY_PATH LD_LIBRARY_PATH LD_RUN_PATH

 export   CFLAGS="-O2 $( echo "${CFLAGS// /$LF}" | grep march )"
 export CXXFLAGS="$CFLAGS"
 export LDFLAGS='-Wl,-s -Wl,-O1'
 export LC_ALL=C

 mkdir -p $DESTDIR/etc
 touch    $DESTDIR/etc/ld.so.conf

 if   [ $HOSTTYPE == x86_64 ]
 then LD_SO="$DESTDIR/lib64/ld-linux-x86-64.so.2"; LLP="$DESTDIR/lib64:$DESTDIR/usr/lib64"
 else LD_SO="$DESTDIR/lib/ld-linux.so.2"         ; LLP="$DESTDIR/lib:$DESTDIR/usr/lib"
 fi

 mkdir -p $DESTDIR/usr/include/sys

#export PATH="/opt/binutils/2.18/bin:$PATH"
#patch -p1 < $SCRIPT_DIR/glibc-2.7.patch
#patch -p1 < $SCRIPT_DIR/glibc-2.7-i586-memcpy_chk.patch
 mv glibc-libidn-* libidn
 KVER=$( uname -r | cut -d '.' -f-3 | tr -d '.' )
   if (( KVER >= 2630 )); then opts --enable-kernel=2.6.30
 elif (( KVER >= 2624 )); then opts --enable-kernel=2.6.24
   fi

 LC_ALL=C grep -q /bin/pwd configure && sed -i 's:/bin/pwd:pwd:g' configure

 mkdir build
 cd    build
 ../configure      \
 --prefix=/usr     \
 --disable-profile \
 --with-tls        \
 --with-elf        \
 --without-gd      \
 --without-cvs     \
 --enable-shared   \
 --enable-add-ons  \
 --with-headers=/usr/include \
 $OPTS             &&
 make all install install_root=$DESTDIR &&
 supported_locales &&
 quick_test        &&
 install_glibc
 ) }


post_install(){
 ldconfig; rm -fr "${OLD_CACHE:-/var/cache/old}"
 ldconfig
 default_post_install
          get_provider  nss_ldap |
 pipe     show_installed         |
 LC_ALL=C sort                   |
          uniq -d                |
          pipe_queue $CAST_QUEUE com
 /sbin/init u
 true
}

current(){
case $VERSION in
 2.11.1) [    -f  /usr/bin/getconf ] &&
         grep -qx /usr/bin/getconf $INSTALL_LOGS/glibc ;;
esac
}
