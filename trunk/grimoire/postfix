   version stable 2.8.6 2.8.5 2.8.4 2.8.3 2.8.3
   require db pcre
  optional openldap  '' '' for ldap support
  optional Linux-PAM '' '' for pluggable authentication
  optional mysql     '' '' for MySQL support
  optional openssl   '' '' for postfix with TLS support
  sys_user mail mail /var/spool/mail
  category network/email
 attribute console makej server
    source $POSTFIX_URL official/postfix-$VERSION.tar.gz
      info last 20111026
      info home http://www.postfix.org/
      info docs http://www.postfix.org/documentation.html
   protect /etc/aliases
  eprovide mail-transport-agent
      desc 'mail transport agent'
   
pre_build(){
 chmod 1775 /var/spool/mail
 groupadd -K GID_MIN=256 -K GID_MAX=511    postdrop 2>/dev/null
 useradd  -K UID_MIN=256 -K UID_MAX=511 -g postdrop -d /var/spool/mail postdrop 2>/dev/null
 groupadd -K GID_MIN=256 -K GID_MAX=511    postfix 2>/dev/null
 useradd  -K UID_MIN=256 -K UID_MAX=511 -g postfix -d /var/spool/mail postfix 2>/dev/null
 default_pre_build
}

build(){
                VSM='mail_spool_directory = /var/spool/mail'
  sed  -i  "s:#$VSM:$VSM:"  conf/main.cf

 if   grep  -qx       openldap $OPT_ON_LOGS/postfix &&
      spell_installed openldap
 then AUXLIBS="-lldap -llber"
      CCARGS="-DHAS_LDAP"
 fi

 if   grep  -qx       Linux-PAM $OPT_ON_LOGS/postfix &&
      spell_installed Linux-PAM
 then AUXLIBS+=' -lpam -lpam_misc'
      CCARGS+=' -DHAS_PAM'
 fi

 if   grep  -qx       mysql $OPT_ON_LOGS/postfix &&
      spell_installed mysql
 then AUXLIBS+=' -L/usr/lib -lmysqlclient -lz -lm'
      CCARGS+=' -DHAS_MYSQL -I/usr/include/mysql'
 fi

 if   grep  -qx       openssl $OPT_ON_LOGS/postfix &&
      spell_installed openssl
 then AUXLIBS+=' -lssl -lcrypto'
      CCARGS+=' -DUSE_TLS'
 fi

 # fix for get man pages to install in /usr/man

 sed  -i  "s:/usr/local:/usr:" src/global/mail_params.h
 grep -lr "tail +" * | xargs --max-lines=32 sed -i "s:tail +:tail -n +:g"

 sed -i 's:DB_VERSION_MAJOR == 4 && DB_VERSION_MINOR > 0:DB_VERSION_MAJOR >= 4 \&\& DB_VERSION_MINOR >= 0:
         s:db, 0, db_path:db, (DB_TXN *) 0, db_path:' src/util/dict_db.c
 make  -f Makefile.init makefiles \
 "CC=gcc"                         \
 "AUXLIBS=$AUXLIBS"               \
 "CCARGS=$CCARGS"                 \
 "OPT=$CFLAGS"                    &&
 make                             &&
 mkdir -p $DESTDIR/{etc,usr/lib}  &&
 sh ./postfix-install    -non-interactive install_root=$DESTDIR &&
 ln -fs ../sbin/sendmail $DESTDIR/usr/lib/sendmail &&
 ln -fs postfix/aliases  $DESTDIR/etc/aliases
}

post_install(){
 # Set queue permissions properly to avoid errors like:
 # postsuper: fatal: scan_dir_push: open directory defer: Permission denied
 postfix set-permissions
}
