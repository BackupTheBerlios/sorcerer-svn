# Copyright Kyle Sallee 2012
# All rights reserved.
# For use with the distribution sorcerer only!

with version stable 20121015
with role    immune-system
with trait   archive_off solo stale
with info    last 20121015
with info    home http://sorcerer.silverice.org/
with clash   kipi-plugins libkdcraw libkexiv2 libkipi libksane # 20120904
with clash   eject # 20120905
with clash   immune-sentinel-space # 20121014
with info    cite 'applies adjustments as a box transitions through time

Please also install spell immune-exam-dispel for automatic
dispelling of installed spells that
are lacking a definition in the software catalog.

Originally, the post_install of the sorcery spell
checked for and applied necessary fixes to transition
to new and improved file formats as Sorcerer boxes seamlessly
transitioned through time without re-installation.
However, checking for the conditions of the fixes and applying
the fixes is a waste of CPU cycles and disk throughput
when performed on every cast of the sorcery spell
instead of after a new transition method becomes available.
Therefore, this spell now applies necessary adjustments
in order for Sorcerer boxes to transition.
Transitional code is guaranteed to exist for no longer than 6 months.
Boxes neglected for more than 6 months
might encounter problems during and after updating.'

build(){ :; }

post_install(){

 mod_mode(){
  inits(){ find /etc/init.d -mindepth 1 -maxdepth 1 -type f "$@"; }
  if   [ -z "$( inits -perm 510 )" ]; then
   inits -perm 700 | xargs -r --max-lines=256 chmod 510
   inits -perm 740 | xargs -r --max-lines=256 chmod 500
   inits -perm 600 | xargs -r --max-lines=256 chmod 400
  fi
 }

 pkgconfig_fixes(){
  grep -lr "^/lib/pkgconfig\|^/lib64/pkgconfig" $INSTALL_LOGS | basenames | pipe_queue "$LOAD_QUEUE"
  grep -lr "^/lib/pkgconfig\|^/lib64/pkgconfig" $INSTALL_LOGS | basenames | pipe_queue "$MOIL_QUEUE"
 }

 fix_inittab(){
  if   grep -q   /dev/tty       /etc/inittab
  then sed -i 's:/dev/tty:tty:' /etc/inittab
  fi
 }

 ati_to_amd_fix(){
  if spell_installed ati-driver-installer; then
   echo amd-driver-installer | pipe_queue "$LOAD_QUEUE"
   echo amd-driver-installer | pipe_queue "$MOIL_QUEUE"
  fi
 }

 # libgweather's libtool la will specify a requirement on libORBit2
 # however none of libgweather's ELFs will link with it
 # therefore requing is mandatory.
 # bad programmers!

 libgweather(){
  if   spell_installed libgweather &&
       spell_installed evolution-data-server
       grep -q libORBit-2 $ELF_LOGS/evolution-data-server
  then echo libgweather | pipe_queue "$MOIL_QUEUE"
       echo libgweather | pipe_queue "$LOAD_QUEUE"
  fi
 }

 aux_dirs(){
  local vco=/var/cache/old
  local vct=/var/cache/tmp

  if  ! [ -d /aux           ]; then mkdir -pm 755 /aux;                  fi
  if  ! [ -d /aux/fit       ]; then mkdir -pm 700 /aux/fit;              fi
  if  ! [ -d /aux/new       ]; then mkdir -pm 700 /aux/new;              fi
  if  ! [ -d /aux/new/etc   ]; then mkdir -pm 700 /aux/new/etc;          fi
  if  ! [ -d /aux/old       ]; then mkdir -pm 755 /aux/old;              fi
  if  ! [ -d /aux/use       ]; then mkdir -pm 700 /aux/use;              fi
  if  ! [ -d /aux/use/etc   ]; then mkdir -pm 700 /aux/use/etc;          fi

  if    [ -d /lib64.sav     ]; then
   if ! [ -d /aux/fit/lib64 ]; then mv        /lib64.sav /aux/fit/lib64;
                               else rm    -fr /lib64.sav;            fi; fi
  if    [ -d /lib.sav       ]; then
   if ! [ -d /aux/fit/lib   ]; then mv        /lib.sav   /aux/fit/lib;
                               else rm    -fr /lib.sav;              fi; fi

  if    [ -d /lib64.bad     ]; then rm    -fr /lib64.bad;                fi
  if    [ -d /lib.bad       ]; then rm    -fr /lib.bad;                  fi

  if    [ -d /etc.sav       ]; then cp    -a  /etc.sav/* /aux/use/etc/;
                                    rm    -fr /etc.sav;                  fi

  if    [ -d /etc.ori       ]; then cp    -a  /etc.ori/* /aux/new/etc/;
                                    rm    -fr /etc.ori;                  fi

  if    [ -d $vct           ]; then rm    -fr $vct;                      fi
  if    [ -d $vco           ]; then mv        $vco/*     /aux/old/;
                                    rm    -fr $vco;
                                    /sbin/ldconfig;                      fi
 }

 remove_shared(){
  if   [  -f /usr/libexec/sorcery/shared ]
  then rm -f /usr/libexec/sorcery/shared
  fi
 }

 relocation(){

  different_filesystems(){
   stat -f -c "%i" /var/cache/{ccache,sources} \
                   /aux/can | sort | uniq -u | grep -q .
  }

  required_space(){
   du -cms /var/cache/{archive,ccache,sources} | sed 's:\ttotal::p;d'
  }

  available_space(){ stat -f -c '%a*%s/1048576' | bc; }

  local  LC_ALL
  export LC_ALL=C

  local   A=/aux
  local  AL=/aux/log
  local ALE=/aux/log/event
  local  OE=/var/log/sorcery/event
  local  OL=/etc/sorcery/log
# local OAC=/var/cache/archive
  local OCC=/var/cache/ccache
  local OSC=/var/cache/sources
  local OGC=/var/cache/git
  local   C=/aux/can
# local  AC=/aux/can/archive
  local  CC=/aux/can/ccache
  local  SC=/aux/can/source
  local  GC=/aux/can/git

  mkdir  -pv        $ALE $AC $CC $SC

  if   [ -d     $OL ]; then
   cp    -av    $OL $A
   grep  -lr    $OL $AL | xargs -r --max-lines=64 \
   sed   -i  "s:$OL:$AL:"
   rm    -frv   $OL
  fi

## does not work because of tabs in file names.
## SA can move them manually if desired.
#  if   [ -d     $OE ]; then
#   mv               $ALE/* $OE/
#   rm   -fr         $ALE
#   mv   -av     $OE $AL
#  fi

  rm -frv /var/cache/sorcery /usr/src/sorcery /var/cache/download

  if   different_filesystems &&
       (( $( required_space ) > $( available_space ) ))
  then return
  # SA must manually move
  # /var/cache/{archive,ccache,git,sources} to
  #   /aux/can/{archive,ccache,git,source}  respectively
  fi

## previous archives are now useless generate new ones.

#  if   [ -d    $OAC ] && ! [ -h $OAC ] && ! [ -h $AC ]; then
#   find        $OAC -mindepth 1 -maxdepth 1 -type d -printf '%f\n' |
#   while read D; do
#    mkdir -pv  "$AC/$D"
#    find      "$OAC/$D" -mindepth 1 -maxdepth 1 | xargs -r --max-lines=64 \
#    mv   -vt   "$AC/$D/"
#   done
#   rm    -frv  "$OAC"
#  fi

  if   [ -d    $OSC ] && ! [ -h $OSC ] && ! [ -h $SC ]; then
   find        $OSC -mindepth 1 -maxdpeth 1 | xargs -r --max-lines=64 \
   mv    -vt    $SC/
   rm    -frv  $OSC
  fi

  if   [ -d    $OCC ] && ! [ -h $OCC ] && ! [ -h $CC ]; then
   find        $OCC -mindepth 1 -maxdpeth 1 | xargs -r --max-lines=64 \
   mv    -vt    $CC/
   rm    -frv  $OCC
  fi

  if   [  -d   $OGC ] && ! [ -h $GC ]
  then mv -v   $OGC $C
  fi
 }

 # Temporary fixes to provide for 6 months.

 mod_mode			#	20110706
 pkgconfig_fixes		#	20110911
 fix_inittab			#	20110912
 ati_to_amd_fix			#	20120412
 libgweather			#	20120528
 aux_dirs			#	20120823
 remove_shared			#	20121007
 relocation			#	20121015
 default_post_install
}
