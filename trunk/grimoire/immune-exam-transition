# Copyright Kyle Sallee 2012 2013
# All rights reserved.
# For use with the POSIX Sorcerer Modern Magic only!

with version stable 20131115
with info    last   20131115
with base    sorcery
with role    immune-system
with trait   solo stale
with info    home http://sorcerer.silverice.org/
with clash   module-init-tools
with info    cite 'applies adjustments as a box transitions through time

Please also install spell immune-exam-dispel for automatic
dispelling of installed spells that
are lacking a definition in the software catalog.

Originally, the post_install of the sorcery spell
checked for and applied necessary fixes to transition
to new and improved file formats as Sorcerer boxes seamlessly
transitioned through time without re-installation.
However, checking for the conditions of the fixes and applying
the fixes is a waste of CPU cycles and disk throughput
when performed on every cast of the sorcery spell
instead of after a new transition method becomes available.
Therefore, this spell now applies necessary adjustments
in order for Sorcerer boxes to transition.
Transitional code is guaranteed to exist for no longer than 6 months.
Boxes neglected for more than 6 months
might encounter problems during and after updating.'

build(){ :; }

post_install(){

 event_log_transition(){
  local d e="$EVENT_LOGS"
  mkdir -pm 700 "$e/"{fore,yore}/
  find "$e/" -mindepth 1 -maxdepth 1 -type f -printf '%#m\t%P\n' |
  while read MODE SPELL REST; do
   case $MODE in
    0644) d=fore ;;
    0604) d=yore ;;
       *) continue ;;
   esac
   mkdir -pm 700              "$e/$d/$SPELL/"
   mv    "$e/$SPELL$TAB$REST" "$e/$d/$SPELL/$REST"
  done
 }

 move_local_config(){
  if   grep -q "declare -A" /etc/sorcery/config
  then rm -f /etc/sorcery/config
  fi
  if   [ -f /etc/sorcery/local.config ]
  then mv   /etc/sorcery/local.config /etc/sorcery/config
  fi
  if   [ -f /etc/sorcery/local.excluded ]
  then mv   /etc/sorcery/local.excluded /etc/sorcery/exclude
  fi
 }

 init_log_change(){
  [ -d /var/log/init/ ] &&
  find /var/log/init/ -mindepth 2 -type d |
  xargs -r -L256 rm -fr
  mkdir -pm 700 /var/log/init/{failed,passed,ran}/
 }

 # Temporary fixes to provide for 6 months.
 event_log_transition			# 20130828
 move_local_config			# 20131110
 init_log_change			# 20131115
 default_post_install
}
