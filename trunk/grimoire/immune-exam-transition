# Copyright Kyle Sallee 2012
# All rights reserved.
# For use with the distribution sorcerer only!

   version stable 20120904
  category immune-system
 attribute archive_off solo stale
      info last 20120904
      info home http://sorcerer.silverice.org/
#conflicts lilo bison-v2.3 ORBit2 libbonobo at-spi gnome-mag eggdbus evas_generic_loaders ffmpeg-v0.6 gimageview gnome-vfs hal immune-sentinel-loadavg libgnome libgnomemm libgnomeui libgnomeuimm libgnomeui libmng
 conflicts kipi-plugins libkdcraw libkexiv2 libkipi libksane
      desc 'applies adjustments as a box transitions through time

Please also install spell immune-exam-dispel for automatic
dispelling of installed spells that
are lacking a definition in the software catalog.

Originally, the post_install of the sorcery spell
checked for and applied necessary fixes to transition
to new and improved file formats as Sorcerer boxes seamlessly
transitioned through time without re-installation.
However, checking for the conditions of the fixes and applying
the fixes is a waste of CPU cycles and disk throughput
when performed on every cast of the sorcery spell
instead of after a new transition method becomes available.
Therefore, this spell now applies necessary adjustments
in order for Sorcerer boxes to transition.
Transitional code is guaranteed to exist for no longer than 6 months.
Boxes neglected for more than 6 months
might encounter problems during and after updating.'

build(){ :; }

post_install(){

 discard_old_index(){
  merge_grimoires
  generate_index   
  . /etc/sorcery/config
  run_details
 }

 mod_mode(){
  inits(){ find /etc/init.d -mindepth 1 -maxdepth 1 -type f "$@"; }
  if   [ -z "$( inits -perm 510 )" ]; then
   inits -perm 700 | xargs -r --max-lines=256 chmod 510
   inits -perm 740 | xargs -r --max-lines=256 chmod 500
   inits -perm 600 | xargs -r --max-lines=256 chmod 400
  fi
 }

 pkgconfig_fixes(){
  grep -lr "^/lib/pkgconfig\|^/lib64/pkgconfig" $INSTALL_LOGS | basenames | pipe_queue $LEECH_QUEUE
  grep -lr "^/lib/pkgconfig\|^/lib64/pkgconfig" $INSTALL_LOGS | basenames | pipe_queue $CAST_QUEUE
 }

 fix_inittab(){
  if   grep -q   /dev/tty       /etc/inittab
  then sed -i 's:/dev/tty:tty:' /etc/inittab
  fi
 }

 kde_fix(){
  LC_ALL=C grep -l '^/opt/kde4/' $INSTALL_LOGS/* | basenames | pipe_queue $LEECH_QUEUE
  LC_ALL=C grep -l '^/opt/kde4/' $INSTALL_LOGS/* | basenames | pipe_queue $CAST_QUEUE
 }

 ati_to_amd_fix(){
  if spell_installed ati-driver-installer; then
   echo amd-driver-installer | pipe_queue $LEECH_QUEUE
   echo amd-driver-installer | pipe_queue $CAST_QUEUE
  fi
 }

 # libgweather's libtool la will specify a requirement on libORBit2
 # however none of libgweather's ELFs will link with it
 # therefore requing is mandatory.
 # bad programmers!

 libgweather(){
  if   spell_installed libgweather &&
       spell_installed evolution-data-server
       grep -q libORBit-2 $ELF_LOGS/evolution-data-server
  then echo libgweather | pipe_queue $CAST_QUEUE
       echo libgweather | pipe_queue $LEECH_QUEUE
  fi
 }

 aux_dirs(){
  local vco=/var/cache/old
  local vct=/var/cache/tmp

  if  ! [ -d /aux           ]; then mkdir -pm 755 /aux;                  fi
  if  ! [ -d /aux/fit       ]; then mkdir -pm 700 /aux/fit;              fi
  if  ! [ -d /aux/new       ]; then mkdir -pm 700 /aux/new;              fi
  if  ! [ -d /aux/new/etc   ]; then mkdir -pm 700 /aux/new/etc;          fi
  if  ! [ -d /aux/old       ]; then mkdir -pm 755 /aux/old;              fi
  if  ! [ -d /aux/use       ]; then mkdir -pm 700 /aux/use;              fi
  if  ! [ -d /aux/use/etc   ]; then mkdir -pm 700 /aux/use/etc;          fi

  if    [ -d /lib64.sav     ]; then
   if ! [ -d /aux/fit/lib64 ]; then mv        /lib64.sav /aux/fit/lib64;
                               else rm    -fr /lib64.sav;            fi; fi
  if    [ -d /lib.sav       ]; then
   if ! [ -d /aux/fit/lib   ]; then mv        /lib.sav   /aux/fit/lib;
                               else rm    -fr /lib.sav;              fi; fi

  if    [ -d /lib64.bad     ]; then rm    -fr /lib64.bad;                fi
  if    [ -d /lib.bad       ]; then rm    -fr /lib.bad;                  fi

  if    [ -d /etc.sav       ]; then cp    -a  /etc.sav/* /aux/use/etc/;
                                    rm    -fr /etc.sav;                  fi

  if    [ -d /etc.ori       ]; then cp    -a  /etc.ori/* /aux/new/etc/;
                                    rm    -fr /etc.ori;                  fi

  if    [ -d $vct           ]; then rm    -fr $vct;                      fi
  if    [ -d $vco           ]; then mv        $vco/*     /aux/old/;
                                    rm    -fr $vco;
                                    /sbin/ldconfig;                      fi
 }

 discard_old_index		#	Always run this function

 # Temporary fixes to provide for 6 months.

 mod_mode			#	20110706
 pkgconfig_fixes		#	20110911
 fix_inittab			#	20110912
 kde_fix			#	20120202
 ati_to_amd_fix			#	20120412
 libgweather			#	20120528
 aux_dirs			#	20120823
 default_post_install
}
