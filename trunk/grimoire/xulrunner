# 16.0 failed compilation
# 18.0.1 failed compilation
# 18.0 failed compilation with same error as 18.0.1
# 17.0.1 failed compilat with different error than 18.0.1 and 18.0
# 19.0 failed to compile

# included java script library not makej compatible?

with trait   broke
with info    edit 20131129
with info    last 20131025
with version   stable 25.0 16.0.2
# Using internal mng
with base    GConf imake jdk libXScrnSaver libnotify nss pygobject sqlite startup-notification xorg-cf-files yasm zip
#with base    GConf imake jdk libXScrnSaver libIDL libnotify nss pygobject sqlite startup-notification xorg-cf-files yasm zip
# with switch  --enable-glitz --disable-glitz 'enable glitz for use with cairo'
with role    network/web
with trait   client library litelink makej multilib-fail optimize solo x11

#with source  stable \
#             http://releases.mozilla.org/pub/mozilla.org/firefox/releases/$VERSION/source/ \
#                   ftp://ftp.mozilla.org/pub/mozilla.org/firefox/releases/$VERSION/source/ \
#             firefox-$VERSION.source.tar.bz2
#with source  unstable \
#             http://releases.mozilla.org/pub/mozilla.org/firefox/releases/$VERSION/source/ \
#                   ftp://ftp.mozilla.org/pub/mozilla.org/firefox/releases/$VERSION/source/ \
#             firefox-$VERSION.source.tar.bz2

with source    stable http://ftp.mozilla.org/pub/mozilla.org/xulrunner/releases/$VERSION/source/xulrunner-$VERSION.source.tar.bz2
with source  unstable http://ftp.mozilla.org/pub/mozilla.org/xulrunner/releases/$VERSION/source/xulrunner-$VERSION.source.tar.bz2

with info    home http://developer.mozilla.org/en/XULRunner
with info    vurl http://developer.mozilla.org/en/XULRunner
#with also    --with-system-jpeg
with also    --with-system-zlib --with-system-bz2
with also    --enable-startup-notification --disable-static
#     with also --enable-system-cairo
with also    --disable-gstreamer
with also    --disable-system-cairo
with also    --enable-system-lcms
with also    --enable-application=xulrunner --enable-libxul
with also    --with-java-include-path=/opt/jdk/include
with also    --with-java-bin-path=/opt/jdk/bin
with also    --with-system-nspr --with-system-nss
with also    --enable-strip
with also    --enable-default-toolkit=cairo-gtk2
with also    --disable-tests --disable-mochitest --disable-crashreporter
with also    --enable-system-sqlite
with also    --with-system-png

#     with also --enable-system-sqlite
# xulrunner version 1.9.2.9 requires ancient version of sqlite
# checking for sqlite3 >= 3.6.22... yes
# checking SQLITE_CFLAGS...  
# checking SQLITE_LIBS... -lsqlite3  
# checking for SQLITE_SECURE_DELETE support in system sqlite... no
# configure: error: System Sqlite library is not compiled with SQLITE_SECURE_DELETE


## --with-system-png requires png with apng support and currently the patch does not apply
#     with also --with-system-png

with info    cite 'HTML rendering and javascript library'

build(){
 add_symlinks(){
  # symbolic links to libmozjs.so help gnome-shell to compile

  if   [[ -d                            "$DESTDIR"/usr/lib/xulrunner-$VERSION ]]; then
   ln -s xulrunner-$VERSION             "$DESTDIR"/usr/lib/xulrunner
   ln -s xulrunner-$VERSION/libmozjs.so "$DESTDIR"/usr/lib/libmozjs.so
  fi

  if   [[ -d                            "$DESTDIR"/usr/lib64/xulrunner-$VERSION ]]; then
   ln -s xulrunner-$VERSION             "$DESTDIR"/usr/lib64/xulrunner
   ln -s xulrunner-$VERSION/libmozjs.so "$DESTDIR"/usr/lib64/libmozjs.so
  fi

  ln -s xulrunner-$VERSION "$DESTDIR"/usr/include/xulrunner
 }

 export LDFLAGS+=" -Wl,-rpath,/usr/lib/xulrunner-$VERSION"

 if    [[ $HOSTTYPE == x86_64 ]] && [[ $CFLAGS =~ -m32 ]]
 then with also --host="${MACHTYPE/x86_64/i686}"
 fi

 export   CFLAGS="${CFLAGS//-flto/}"
 export CXXFLAGS="${CXXFLAGS//-flto/}"
 export  LDFLAGS="$( echo "$LDFLAGS" | sed "s:-flto=[^ ]::" )"

 ./configure \
 --prefix=/usr \
 --sysconfdir=/etc \
 --localstatedir=/var \
 --enable-optimize="$CFLAGS" \
 $OPTS &&
 make &&
 make install DESTDIR="$DESTDIR" &&
 add_symlinks
}
