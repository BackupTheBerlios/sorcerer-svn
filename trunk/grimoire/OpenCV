# this spell must be multilib-dual

# 2.4.3 2.4.2 2.4.1 2.4.0 failed to compile
# because they are not multilib compatible and attempt to link
# with the ELF 64-bit libraries when compiling with -m32

# upgrading cmake does not solve OpenCV version greater than 2.3.1a
# inability to select the proper libraries for linking.
# it must somewhere unset PKG_CONFIG_PATH from the environment
# but I was unable to grep it in the source tree.
# 2.4.4 failed to properly link

# Neither 2.3.1a nor 2.4.4a are compiling and linking at the moment.

with info    last 20131110
with version   stable 2.4.7 2.4.6.1 2.4.4a
case $VERSION in
 2.3.1a)
with also    -DWITH_FFMPEG:BOOL=OFF
#with base    ffmpeg-v0.7 ;;
esac
# case $VERSION in
#  2.2.0)
#       with also -DWITH_FFMPEG:BOOL=OFF ;;
# esac
with base    ffmpeg gst-plugins-base-0.10 gtk+ numpy openexr v4l-utils
#with base    gst-plugins-base libv4l numpy openexr
with elect   libdc1394
with role    graphic
with trait   library makej multilib-dual setarch
#with trait   library multilib-dual setarch
with source    stable $SOURCEFORGE_URL opencvlibrary/opencv-unix/$VERSION/opencv-$VERSION.tar.gz
with source  unstable $SOURCEFORGE_URL opencvlibrary/opencv-unix/$VERSION/opencv-$VERSION.tar.gz
with info    home http://opencv.willowgarage.com/wiki/
with info    cite 'open source computer vision library'

build(){
 ffmpeg_legacy(){
  local SUFFIX

  if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
  then SUFFIX=64
  else SUFFIX=
  fi

  export   CFLAGS+=' -I/opt/ffmpeg/0.7/usr/include'
  export CXXFLAGS+=' -I/opt/ffmpeg/0.7/usr/include'
  export      PKG_CONFIG_PATH="/opt/ffmpeg/0.7/usr/lib$SUFFIX:$PKG_CONFIG_PATH"
  export LDFLAGS+=" -Wl,-rpath,/opt/ffmpeg/0.7/usr/lib$SUFFIX"
 }

 if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
 then export LDFLAGS+=' -L/usr/lib64 -L/lib64'
 else export LDFLAGS+=' -L/usr/lib -L/lib'
 fi

# case $VERSION in
#  2.3.1a) ffmpeg_legacy ;;
# esac

 default_build &&
 if     [[ $HOSTTYPE == x86_64 ]] &&
      ! [[ $CFLAGS   =~ -m32   ]]
 then mv $DESTDIR/usr/lib{,64}
      sed -i 's:prefix}/lib:prefix}/lib64:' $DESTDIR/usr/lib64/pkgconfig/opencv.pc
 fi
}
