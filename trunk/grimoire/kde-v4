# always skip the x.y.0 updates

# Notes about problems and solutions.

# if jackd can not be started by qjackctl
# re-configure it to begin without real-time priority.

# If .xsession-errors  has errors about io-slave protocol file not being found
# then as the user:
# $ rm -f ~/.kde/share/config/ksycoca
# $ rm -r /var/tmp/kdecache-$USERNAME/ksyscoca
# $ kbuildsycoca4

# The missing icon pictures for Home Trash and so forth
# is because they are leftover from KDE 3.x in ~/Desktop
# Removing them is safe.

# kde version 4.5.0 does not have a kdepim

if [[ -z $VERSION ]]; then
   version stable 4.6.1 4.6.0 4.5.5
   version legacy 4.4.5
# legacy versions for those missing pim components of kde.
fi

if [ -z "${ATTRIBUTE[library]}" ]; then
      opts -DCMAKE_INSTALL_PREFIX:PATH=/opt/kde4
fi
      opts -DCMAKE_SKIP_BUILD_RPATH:BOOL=TRUE
      opts -DCMAKE_BUILD_WITH_INSTALL_RPATH:BOOL=TRUE
      opts -DCMAKE_INSTALL_RPATH_USE_LINK_PATH:BOOL=TRUE
      opts -DCMAKE_BUILD_TYPE=Release
      opts -DCMAKE_VERBOSE_MAKEFILE:BOOL=TRUE

 attribute kde4 makej
      info home  http://www.kde.org
      info docs  http://docs.kde.org/
      info mail  http://www.kde.org/support/mailinglists/

case $SPELL in
    kde-v4)
  category profile
   require kdeartwork-v4 kdebase-v4 kdebase-runtime-v4 kdebase-workspace-v4
case $VERSION in
 4.4.*)
  optional kdepim-v4 ;;
esac
  optional kdeaccessibility-v4
  optional kdebindings-v4
  optional kdeadmin-v4
  optional kdeedu-v4
  optional kdegames-v4
  optional kdegraphics-v4
  optional kdenetwork-v4
  optional kdemultimedia-v4
  optional kde-path-v4
  optional kdeplasma-addons-v4
  optional kdesdk-v4
  optional kdetoys-v4
  optional kdeutils-v4
  optional kdewebdev-v4
  optional kcoloredit
  optional kfax
  optional kgraphviewer
  optional kiconedit
  optional kmldonkey
  optional kphotoalbum
  optional ktorrent
  optional rsibreak
  optional qjackctl
  optional scim-bridge-qt4

# extragear-plasma last release was 4.0.2? no 4.0.3 release?
#            'extragear-plasma:::for additional plasma apps/themes'
#            'kpovmodeler:::broken'
#            'ligature:::broken'
      desc 'K, version 4.x, desktop environment.
It combines ease of use, contemporary
functionality and outstanding graphical design.
KDE is a completely new desktop, incorporating
a large suite of applications.
While KDE includes a window manager, file manager,
panel, control center and many other components
that one would expect to be part of a contemporary
desktop environment, the true strength of this
exceptional environment lies in the
interoperability of its components.' ;;

 kde*-v4) source $KDE_URL stable/$VERSION/src/${SPELL%-v4}-$VERSION.tar.bz2
esac

kde_build(){ (
 if  [[ $HOSTTYPE == x86_64 ]]; then
  if [[ $CFLAGS   =~ -m32   ]]; then
   export            PATH=/opt/kde4/i686/bin:$PATH
   export PKG_CONFIG_PATH=/opt/kde4/i686/lib/pkgconfig:/usr/lib/pkgconfig
   export         KDEDIRS=/opt/kde4/i686
   OPTS+=' -DCMAKE_INSTALL_PREFIX:PATH=/opt/kde4/i686'
   OPTS+=' -DCMAKE_INSTALL_RPATH:PATH=/opt/kde4/i686/lib'
   ARCH=i686
  else
   export            PATH=/opt/kde4/bin:$PATH
   export PKG_CONFIG_PATH=/opt/kde4/lib64/pkgconfig:/usr/lib64/pkgconfig
   OPTS+=' -DCMAKE_INSTALL_PREFIX:PATH=/opt/kde4'
   OPTS+=' -DCMAKE_INSTALL_RPATH:PATH=/opt/kde4/lib64'
   OPTS+=' -DLIB_SUFFIX:STRING=64'
   ARCH=$HOSTTYPE
  fi
 else
  export      PATH="/opt/kde4/bin:$PATH"
  export PKG_CONFIG_PATH=/opt/kde4/lib/pkgconfig:/usr/lib/pkgconfig
  OPTS+=' -DCMAKE_INSTALL_PREFIX:PATH=/opt/kde4'
  ARCH=$HOSTTYPE
 fi

 if    [ ${ATTRIBUTE[multilib-concurrent]} ]; then
  if   [ $m32 ]
  then mkdir -p build.32; cd build.32
  else mkdir -p build.64; cd build.64
  fi
 else
  mkdir -p build
  cd       build
 fi

 cmake $OPTS .. &&
 make V=1 install "DESTDIR=$DESTDIR"
) }

build(){ 
 if [[ $SPELL == kde-v4 ]]
 then default_build
 else kde_build
 fi
}
