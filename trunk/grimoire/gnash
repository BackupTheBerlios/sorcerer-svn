# Does not compile using cmake, uses configure instead
# Using boost compiled with newer gcc than gnash causes link error
# However, gnash does not compile with current version of gcc.

with version stable 0.8.10
with base    agg bluez boost desktop-file-utils faac farstream-0.1 gamin gsm gst-ffmpeg kdelibs-v4 lame libvpx schroedinger x264 xulrunner
case $VERSION in
 0.8.10)
with also    --disable-npapi
with also    --enable-media=gst
   use_gcc gcc-v4.5
with base    giflib-v4 ffmpeg-v0.7 ;;
esac
with role    network/web
with trait   mozilla-plugin kde4 x11
with trait   broke
with source  $GNU_URL gnash/$VERSION/gnash-$VERSION.tar.bz2
with info    last 20120131
with info    home http://www.gnashdev.org/
with info    docs 'http://www.gnashdev.org/?q=node/26'
with info    mail 'https://savannah.gnu.org/mail/?group=gnash'
with info    cite 'Free flash player'

build(){ (
 # Below did not fix the link errors for use of deprecated defines
 # export   CFLAGS+=" -UGTK_DISABLE_DEPRECATED -UGDK_PIXBUF_DISABLE_DEPRECATED"
 # export CXXFLAGS+=" -UGTK_DISABLE_DEPRECATED -UGDK_PIXBUF_DISABLE_DEPRECATED"

#  export PATH="/usr/bin:$PATH"
#  export PKG_CONFIG_PATH=/usr/lib/pkgconfig
#  default_build &&

 ffmpeg_legacy(){
  local SUFFIX

  if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
  then SUFFIX=64
  else SUFFIX=
  fi

  export   CFLAGS+=' -I/opt/ffmpeg/0.7/usr/include'
  export CXXFLAGS+=' -I/opt/ffmpeg/0.7/usr/include'
  export      PKG_CONFIG_PATH="/opt/ffmpeg/0.7/usr/lib$SUFFIX:$PKG_CONFIG_PATH"
  export LDFLAGS+=" -Wl,-rpath,/opt/ffmpeg/0.7/usr/lib$SUFFIX"
 }

 giflib_fix(){
  if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
  then GIFLIBLIBDIR=/opt/giflib/4/usr/lib64
  else GIFLIBLIBDIR=/opt/giflib/4/usr/lib
  fi
  export   CFLAGS+=" -I/opt/giflib/4/usr/include"
  export CXXFLAGS+=" -I/opt/giflib/4/usr/include"
  export  LDFLAGS+=" -L$GIFLIBLIBDIR -Wl,-rpath,$GIFLIBLIBDIR"
  export PKG_CONFIG_PATH="$GIFLIBLIBDIR/pkgconfig:$PKG_CONFIG_PATH"
  echo "LDFLAGS=$LDFLAGS"
  echo "PKG_CONFIG_PATH=$PKG_CONFIG_PATH"
 }

 case $VERSION in
  0.8.10) giflib_fix
          ffmpeg_legacy ;;
 esac

 if   [[ $HOSTTYPE == x86_64 ]] && [[ $CFLAGS =~ -m32 ]]
 then with also --with-kde4-prefix=/opt/32bit/usr
 else with also --with-kde4-prefix=/usr
 fi
 default_build &&
 make install-plugins DESTDIR=$DESTDIR
) }
