#!/bin/bash

# Copyright 2013 by Kyle Sallee All Rights Reserved
# ttyd is a daemon to identify an avaialble virtual console
# and allow activation of the virtual console and login

main(){
 # Do not allocate virtual consoles until after getty programs
 # specified in /etc/inittab are launched by /sbin/init
 while pgrep -u root "^rcS$"
 do    sleep 5
 done

 while :; do 
  pgrep -u root "^rgetty$" ||
  openvt /sbin/rgetty
  sleep 5
 done
}

not_root(){ ! (( $UID == 0 )); }
not_rootfs(){ [ -z "$( find /media/root -mindepth 1 -maxdepth 1 -type d )" ]; }

if not_root || not_rootfs; then exit 1; fi

trap : SIGHUP SIGINT SIGQUIT SIGILL SIGABRT
[      -f /usr/libexec/bash/sleep ] &&
enable -f /usr/libexec/bash/sleep sleep
main < /dev/null &> /dev/null &
