#!/bin/bash

# Copyright 2013 by Kyle Sallee All Rights Reserved
# ttyd is a daemon to identify an avaialble virtual console
# and allow activation of the virtual console and login

clr(){ deallocvt; printf "%b\033c"; }

root_avail(){
 find /media/root/*/bin/login -maxdepth 0 -type f -executable |
 cut -d / -f4 | sort -u
}

root_select(){
 local -i loop=0
 local -i index=-1
 local -a roots
 read  -a roots <<< $( root_avail )
 clr
 /bin/tty
 printf "%(%c)T\n" -1
 echo $"#  root file system name"
 while [ -n "${roots[$loop]}" ]; do
  if (( loop < 10 ))
  then printf     "$loop  ${roots[$loop]}\n" 
  else printf     "$loop ${roots[$loop]}\n"
  fi
  (( loop++ ))
 done
 printf $"Please select a root file system by number: "
 if read -t 3600 index &&
                  [ -n "${roots[$index]}" ]
 then root="/media/root/${roots[$index]}"
 else return 1
 fi
}

activate(){
 local        root
 while [ -z "$root" ]; do root_select; done

 openvt /sbin/rgetty
 clr
 [ -f             "$root"/etc/issue ] &&
 cat              "$root"/etc/issue
 exec /bin/chroot "$root" /bin/login
}

not_root(){ ! (( $UID == 0 )); }
not_rootfs(){ [ -z "$( find /media/root -mindepth 1 -maxdepth 1 -type d )" ]; }

if not_root || not_rootfs; then exit 1; fi

trap : SIGHUP SIGINT SIGQUIT SIGILL SIGABRT SIGSTOP
[      -f /usr/libexec/bash/sleep ] &&
enable -f /usr/libexec/bash/sleep sleep
activate
