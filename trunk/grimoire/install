# install spell is for the Sorcerer distribution only
# Copyright 2007, 2008 by Kyle Sallee, all rights reserved.

    stable 20080809
   require LVM2 alsa-utils at76_usb bash-completion cdrtools core cryptmount dhcp dhcpcd dmidecode dump eject favor gpart hdparm inetutils iptables isapnptools jfsutils kbd lftp linux-modular lshw lsof lsscsi lynx madwifi mailutils man mcron mdadm minicom ms-sys mutt nano nmap ntfsprogs ntp openssh parted pciutils pcmciautils ppp procinfo protocols  rp-pppoe reiserfsprogs sdelta3 sdparm services sg3_utils sshfs-fuse syslinux traceroute unzip usbutils v86d vim  wireless_tools wpa_supplicant xf86-video-all xfsdump xorg zile
  category administration/bootloader
 attribute archive_off console solo
   exclude /etc/mtab
      desc 'install provides the menu driven installer for Sorcerer.'

build(){
 on_iso(){
  if   ! [ -d /boot/isolinux ]
  then echo $"install only installs on the Sorcerer IR"; false
  fi
 }

 install_isolinux(){
  lver83(){
   LAST="$1"
    NOW="$1"
   while [[ $NOW =~ \. ]]
   do LAST="$NOW"
      NOW="${NOW/\./_}"
   done
   LVER83="$LAST"
  }

  LVER="$( installed_version linux-modular )"
  lver83 $LVER

  mkdir -vp /boot/isolinux
  cp    -va /usr/lib/syslinux/isolinux.bin \
            $SCRIPT_DIR/isolinux/* /boot/isolinux/
  sed   -i "s:\$HOSTTYPE:$HOSTTYPE:
            s:\$LVERSION:$LVER:
            s:\$VERSION:$VERSION:" /boot/isolinux/sorcerer.txt
  sed   -i "s:\$LVER83:$LVER83:"   /boot/isolinux/isolinux.cfg
 }

 # on_iso        &&
 prepare_install &&  
 install -vm 700 $SCRIPT_DIR/sinstall /sbin/ &&
 install_isolinux
}


post_remove(){
 rm -fr /sbin/install /boot/isolinux
 default_post_remove
}


post_install(){
 view_index av |
 sed -n "$( sed "s:^:/^:;s:$:\t/p:" $SCRIPT_DIR/sources.txt )" |
 sed    "s:^:$SOURCE_CACHE/:;s:\t:/:" |
 sed p |
 pipe find $SOURCE_CACHE -maxdepth 2 -mindepth 2 -type d |
 LC_ALL=C sort | uniq -u |
 xargs -r --max-lines=256 rm -rf
 find $SOURCE_CACHE -maxdepth 1 -mindepth 1 -type d -empty |
 xargs -r --max-lines=256 rmdir
 if ! [ -h /etc/mtab ]; then
  rm -f              /etc/mtab
  ln -s /proc/mounts /etc/mtab
 fi
 leech $(< $SCRIPT_DIR/sources.txt )
 default_post_install
}

current(){
 if   ! [ -d /boot/isolinux ]
 then echo install | pipe_queue "$DISPEL_QUEUE"
 fi
}
