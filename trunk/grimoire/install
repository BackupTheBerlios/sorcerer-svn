# install spell is for the Sorcerer distribution only
# Copyright 2007, 2008 by Kyle Sallee, all rights reserved.

   VERSION=( 20080522 )
  CATEGORY='administration/bootloader'
 ATTRIBUTE='archive_off console solo'
       REQ=( 'LVM2 alsa-utils at76_usb bash-completion
              cdrtools core cryptmount
              dhcp dhcpcd dmidecode dump
              eject favor gpart hdparm inetutils iptables isapnptools
              jfsutils kbd lftp linux-modular lshw lsof lsscsi lynx
              madwifi mailutils man mcron mdadm minicom ms-sys mutt
              nano nmap ntfsprogs ntp openssh
              parted pciutils pcmciautils ppp procinfo protocols 
              rp-pppoe reiserfsprogs
              sdelta3 sdparm services sg3_utils sshfs-fuse syslinux
              traceroute unzip usbutils v86d vim 
              wireless_tools wpa_supplicant xfsdump zile' )
   EXCLUDE='/etc/mtab'
  ESTIMATE='5'
      DESC='install provides the menu driven installer for Sorcerer.'

build(){
 trim_excess(){
  remind(){ if [ -e "$1" ]; then echo "$1 remember to $2"; fi; }
  rm -rf /tmp/*
  rm  -f ${LOCAL_CONFIG:-/etc/sorcery/local.config}
  rm  -f ${LOCAL_EXCLUDE:-/etc/sorcery/local.excluded}
  rm -rf ${FAILED_CACHE:-/var/tmp/failed}/*
  rm -rf ${LEECH_CACHE:-/var/tmp/leech}/*
  rm -rf ${FAIL_LOGS:-/etc/sorcery/log/fail}/*
  rm -rf ${ACTIVITY_LOGS:-/etc/sorcery/log/activity}/*
  rm -rf ${COMPILE_LOGS:-/etc/sorcery/log/compile}/*.gz
  rm -rf ${ESTIMATE_LOGS:-/etc/sorcery/log/estimate}/*
  rm -rf ${ETC_LOGS:-/etc/sorcery/log/etc}/*
  rm -rf ${EVENT_LOGS:-/etc/sorcery/log/event}/*
  rm -rf ${LEECH_LOGS:-/etc/sorcery/log/leech}/*
  rm -rf ${SNAP_LOGS:-/etc/sorcery/log/snap}/*
  rm -rf {,/usr}/lib{,64}.old
  rm -rf /root/{.ssh,.lesshst}
  rm -f  /etc/sorcery/log/{history.gz,snap.gz}
  remind /usr/src/linux     remove
  remind /var/cache/archive empty
  remind /var/cache/ccache  empty
 }

 on_iso(){
  if   ! [ -d /boot/isolinux ]
  then echo $"install only installs on the Sorcerer IR"; false
  fi
 }

 install_isolinux(){
  lver83(){
   LAST="$1"
    NOW="$1"
   while [[ $NOW =~ \. ]]
   do LAST="$NOW"
      NOW="${NOW/\./_}"
   done
   LVER83="$LAST"
  }

  LVER="$( installed_version linux-modular )"
  lver83 $LVER

  mkdir -vp /boot/isolinux
  cp    -va /usr/lib/syslinux/isolinux.bin \
            $SCRIPT_DIR/isolinux/* /boot/isolinux/
  sed   -i "s:\$HOSTTYPE:$HOSTTYPE:
            s:\$LVERSION:$LVER:
            s:\$VERSION:$VERSION:" /boot/isolinux/sorcerer.txt
  sed   -i "s:\$LVER83:$LVER83:"   /boot/isolinux/isolinux.cfg
 }

 # on_iso        &&
 prepare_install &&  
 install -vm 0700 $SCRIPT_DIR/install / &&
 install_isolinux &&
 trim_excess
}


post_remove(){
 rm -f /install
 default_post_remove
}


post_install(){
 view_index av |
 sed -n "$( sed "s:^:/^:;s:$:\t/p:" $SCRIPT_DIR/sources.txt )" |
 sed    "s:^:$SOURCE_CACHE/:;s:\t:/:" |
 sed p |
 pipe find $SOURCE_CACHE -maxdepth 2 -mindepth 2 -type d |
 LC_ALL=C sort | uniq -u |
 xargs -r --max-lines=256 rm -rf
 find $SOURCE_CACHE -maxdepth 1 -mindepth 1 -type d -empty |
 xargs -r --max-lines=256 rmdir
 rm -f              /etc/mtab	# CDROM has read only /etc/mtab
 ln -s /proc/mounts /etc/mtab	# Must be symbolic link
 leech $(< $SCRIPT_DIR/sources.txt )
 default_post_install
 echo initramfs | pipe_queue "$CAST_QUEUE" com
}

current(){
 if   ! [ -d /boot/isolinux ]
 then echo install | pipe_queue "$DISPEL_QUEUE"
 fi
}
