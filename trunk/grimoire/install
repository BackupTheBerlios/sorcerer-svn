# install spell is for the Sorcerer distribution only
# Copyright 2007 through 2010 by Kyle Sallee, all rights reserved.


    stable 20110211
   require LVM2 alsa-utils bash-completion btrfs-tools cdrtools core dhcp dhcpcd dmidecode eject favor hdparm inetutils iptables isapnptools isolinux jfsutils kbd kexec-tools linux lsof lsscsi lynx mdadm minicom ms-sys multipath-tools nano ntfsprogs ocfs2-tools openssh parted pciutils pcmciautils ppp protocols rp-pppoe reiserfsprogs rsync sdelta3 sdparm services sg3_utils sshfs-fuse traceroute unzip usbutils v86d vim wireless-regdb wireless_tools wpa_supplicant zile
##  ndiswrapper and nmap are currently broke
#  require ndiswrapper nmap

## firmware
   require alsa-firmware atmel-firmware iwlwifi-1000-ucode iwlwifi-3945-ucode iwlwifi-4965-ucode iwlwifi-5000-ucode iwlwifi-5150-ucode iwlwifi-6000-ucode prism54-firmware ralink-firmware

# madwifi

case $MACHTYPE in
 *-glibc) require dump lftp lshw man ntp xfsdump ;;
esac

  category administration/bootloader
 attribute archive_off console solo
      desc 'the menu driven installer for Sorcerer'

build(){
 on_iso(){
  if   ! [[ -d /boot/isolinux ]]
  then echo $"install only installs on the Sorcerer IR"; false
  fi
 }

 install_isolinux(){
  lver83(){
   LAST="$1"
    NOW="$1"
   while [[ $NOW =~ \. ]]
   do LAST="$NOW"
      NOW="${NOW/\./_}"
   done
   LVER83="$LAST"
  }

  LVER="$( installed_version linux )"
  lver83 $LVER
  YEAR="$( date +%Y )"

  mkdir -vp $DESTDIR/boot/isolinux
  cp    -va /usr/share/isolinux/isolinux.bin \
            $SCRIPT_DIR/isolinux/* $DESTDIR/boot/isolinux/
  sed   -i "s:\$HOSTTYPE:$HOSTTYPE:
            s:\$LVERSION:$LVER:
            s:\$VERSION:$VERSION:"   $DESTDIR/boot/isolinux/sorcerer.txt
  sed   -i "s:\$LVER83:$LVER83:"     $DESTDIR/boot/isolinux/isolinux.cfg
  sed   -i "s:\$YEAR:$YEAR:"         $DESTDIR/boot/isolinux/sorcerer.txt
  gzip  -c9 /usr/src/linux/.config > $DESTDIR/boot/isolinux/config.gz
 }

 # on_iso        &&
 mkdir -p $DESTDIR/sbin
 install -vm 700 $SCRIPT_DIR/sinstall $DESTDIR/sbin/
 install -vm 700 $SCRIPT_DIR/dt       $DESTDIR/sbin/
 install_isolinux
}


post_remove(){
 rm -fr /sbin/install /boot/isolinux
 default_post_remove
}


post_install(){
 view_index av |
 sed -n "$( sed "s:^:/^:;s:$:\t/p:" $SCRIPT_DIR/sources.txt )" |
 sed    "s:^:$SOURCE_CACHE/:;s:\t:/:" |
 sed p |
 pipe find $SOURCE_CACHE -maxdepth 2 -mindepth 2 -type d |
 LC_ALL=C sort | uniq -u |
 xargs -r --max-lines=256 rm -rf
 find $SOURCE_CACHE -maxdepth 1 -mindepth 1 -type d -empty |
 xargs -r --max-lines=256 rmdir
 leech $(< $SCRIPT_DIR/sources.txt )
 default_post_install
}

current(){
 if   ! [ -d /boot/isolinux ]
 then echo install | pipe_queue "$DISPEL_QUEUE"
 fi
}
