# xorg-server requirement added purely for ordering.
# With NVIDIA-Linux-x86 version 173.14.12
# installed ontop of MesaLib version 7.2
# xorg-server version 1.5.1 will fail to compile
# Due to the NVIDIA-Linux-x86 header files not providing
# what xorg-server expects.

# 185.18.14 probably has bugs
# the ground textures do not show in warzone2100 with NVIDIA-Linux-x86 185.18.14
# for warzone2100 try 180.60

    legacy 180.60
    stable 190.53 190.42 185.18.36 185.18.14 180.60 180.29 180.22
   require MesaLib gtk+ mktemp
   require xorg-server
  category kernel
       url http://us.download.nvidia.com/XFree86/
case $HOSTTYPE in
 x86_64) attribute solo linux-26-module x11 x86_64
            source Linux-x86_64/$VERSION/NVIDIA-Linux-x86_64-$VERSION-pkg2.run ;;
      *) attribute solo linux-26-module x11 x86
            source Linux-x86/$VERSION/NVIDIA-Linux-x86-$VERSION-pkg1.run ;;
esac
      vurl http://www.nvidia.com/object/unix.html
  homepage http://www.nvidia.com
 freshmeat nvidiaxfree86_40drivers
    CFLAGS='-O3'
   LDFLAGS='-Wl,-O1'
  estimate 200
      desc 'drivers provided by NVIDIA for NVIDIA GPUs
NVIDIA-Linux-x86 contains both
the nvidia provided binary xorg drivers
and the linux kernel module.

In order for this to work remember to edit Section "Files"
of /etc/X11/xorg.conf and add:

    ModulePath      "/usr/lib/modules"
    ModulePath      "/usr/lib/xorg/modules"

Included is a sample config file that works with 2 monitors.
/root/.sorcery/grimoire/NVIDIA-Linux-x86.d/xorg.conf'

pre_build(){
#default_pre_build
 BUILD_DIR="$SOURCE_DIR/$SPELL/$SPELL-$VERSION"
 cd  ..
 rm -fr                 $BUILD_DIR
 sh $SOURCE -x --target $BUILD_DIR
 chown -R root:root     $BUILD_DIR
}

build(){
 make_install(){
  cd $BUILD_DIR/usr

  GB="ltmain.sh - GNU libtool 1.5 (1.1220 2003/04/05 19:32:58)"
  sed -i "s:__LIBGL_PATH__:/usr/lib:
          s,__GENERATED_BY__,$GB," lib/libGL.la

  case $HOSTTYPE in
   x86_64)
    /sbin/ldconfig -n lib{,32}{,/tls} X11R6/lib{,/modules/extensions}
    ln -s libGL.so.1     lib32/libGL.so
    ln -s libGLcore.so.1 lib32/libGLcore.so
    ln -s libGL.so.1     lib32/tls/libGL.so
    ln -s libGLcore.so.1 lib32/tls/libGLcore.so
#    rm -f /usr/lib64/libGL.so*
#    sed -i '\,/usr/lib64/libGL\.so,d' \
#        $INSTALL_LOGS/MesaLib \
#            $ELF_LOGS/MesaLib \
#         $MD5SUM_LOGS/MesaLib
    ;;
   *) /sbin/ldconfig -n lib{,/tls} X11R6/lib{,/modules/extensions} ;;
  esac

  ln -s libGL.so.1     lib/libGL.so
  ln -s libGLcore.so.1 lib/libGLcore.so
  ln -s libGL.so.1     lib/tls/libGL.so
  ln -s libGLcore.so.1 lib/tls/libGLcore.so

  #if /lib/libc.so.6 | grep -q  "Thread-local storage"; then
  #  cp -a lib/tls/*   lib; [[ -d lib32 ]] &&
  #  cp -a lib32/tls/* lib32
  #fi

  rm -rf src

  if    [  -f  share/doc/Copyrights  ]
  then  mv     share/doc NVIDIA-Linux-x86
        mkdir  share/doc
        mv               NVIDIA-Linux-x86  \
               share/doc
  fi

  cd $BUILD_DIR
  mv           usr/include usr/nv
  mkdir        usr/include
  mv    usr/nv usr/include

  mkdir                 usr/lib/nv
  mv    usr/lib/libGL.* usr/lib/nv

  find usr -type f | while read; do install -vD $REPLY /$REPLY; done
  find usr -type l | while read; do mv      -v  $REPLY /$REPLY; done

  if   ! [[ -f                  /etc/ld.so.conf.d/head ]] ||
       ! grep -q /usr/lib/nv    /etc/ld.so.conf.d/head
  then echo      /usr/lib/nv >> /etc/ld.so.conf.d/head
  fi
 }

 LVER=$( installed_version $( get_provider linux-kernel ) )

 if [ -z "$LVER" ]; then LVER=$( uname -r ); fi

 cd $BUILD_DIR
 cd usr/src/nv

 case $VERSION in
  169.12) patch -p3 < $SCRIPT_DIR/NVIDIA_kernel-169.12-2286310.diff.txt ;;
 esac

 rm -f makefile Makefile

 case $LVER in
  2.4*) cp Makefile.nvidia Makefile ;;
     *) cp Makefile.kbuild Makefile ;;
 esac

  SM=/usr/src/linux/System.map
 SSC=suser-sanity-check
 RSC=rmmod-sanity-check

 sed -i "s/\$(shell uname -r)/$LVER/" Makefile
 sed -i "s:depmod:true:"              Makefile
 sed -i "s:modprobe:true:"            Makefile
 sed -i "s:$SSC $RSC:$SSC:"           Makefile
 sed -i "s:install $RSC:install:"     Makefile
 sed -i "s:rivafb-sanity-check nvidiafb-sanity-check::" Makefile

 prepare_install &&
 make    install CC=gcc \
                 IGNORE_CC_MISMATCH=1 \
                 IGNORE_XEN_PRESENCE=1 &&
    make_install
}

current(){
case $VERSION in
 190.53) [ -f /usr/lib/xorg/modules/drivers/nvidia_drv.so ] &&
 [ -f                /etc/ld.so.conf.d/head ] &&
 grep -q /usr/lib/nv /etc/ld.so.conf.d/head   ;;
esac
}
