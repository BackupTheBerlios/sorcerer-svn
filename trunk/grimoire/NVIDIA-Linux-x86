# xorg-server requirement added purely for ordering.
# With NVIDIA-Linux-x86 version 173.14.12
# installed ontop of MesaLib version 7.2
# xorg-server version 1.5.1 will fail to compile
# Due to the NVIDIA-Linux-x86 header files not providing
# what xorg-server expects.

    stable 256.44 195.36.24 195.36.15
   require MesaLib gtk+ mktemp
   require xorg-server
  category kernel
case $HOSTTYPE in
 x86_64) attribute solo linux-26-module x11 x86_64
            source http://us.download.nvidia.com/XFree86/Linux-x86_64/$VERSION/NVIDIA-Linux-x86_64-$VERSION-no-compat32.run ;;
#           source http://us.download.nvidia.com/XFree86/Linux-x86_64/$VERSION/NVIDIA-Linux-x86_64-$VERSION-pkg2.run ;;
# http://us.download.nvidia.com/XFree86/Linux-x86_64/256.44/NVIDIA-Linux-x86_64-256.44.run
      *) attribute solo linux-26-module x11 x86
            source http://us.download.nvidia.com/XFree86/Linux-x86/$VERSION/NVIDIA-Linux-x86-$VERSION.run ;;
#           source http://us.download.nvidia.com/XFree86/Linux-x86/$VERSION/NVIDIA-Linux-x86-$VERSION-pkg1.run ;;
# http://us.download.nvidia.com/XFree86/Linux-x86/256.44/NVIDIA-Linux-x86-256.44.run
esac
      vurl http://www.nvidia.com/object/unix.html
  homepage http://www.nvidia.com
 freshmeat nvidiaxfree86_40drivers
    CFLAGS='-O3'
   LDFLAGS='-Wl,-O1'
  estimate 200
      desc 'drivers provided by NVIDIA for NVIDIA GPUs
NVIDIA-Linux-x86 contains both
the nvidia provided binary xorg drivers
and the linux kernel module.

In order for this to work remember to edit Section "Files"
of /etc/X11/xorg.conf and add:

    ModulePath      "/usr/lib/modules"
    ModulePath      "/usr/lib/xorg/modules"

Included is a sample config file that works with 2 monitors.
/root/.sorcery/grimoire/NVIDIA-Linux-x86.d/xorg.conf'


build(){
 fix_install(){
  mv       $DESTDIR/usr/include     $DESTDIR/usr/nv
  mkdir -p $DESTDIR/usr/include
  mv       $DESTDIR/usr/nv/vdpau    $DESTDIR/usr/include
  mv       $DESTDIR/usr/nv          $DESTDIR/usr/include
  mkdir -p $DESTDIR/usr/lib/nv
  mv       $DESTDIR/usr/lib/libGL.* $DESTDIR/usr/lib/nv
  mkdir -p           $DESTDIR/etc/ld.so.conf.d/
  echo /usr/lib/nv > $DESTDIR/etc/ld.so.conf.d/head
  rm -f $DESTDIR/usr/lib/xorg/modules/libwfb.*
# rm -f $DESTDIR/usr/lib/xorg/modules/extensions/libglx.*
## libglx extension should be installed over xorg-server's libglx

  return 0
 }

 LVER="$( installed_version $( get_provider linux-kernel ) )"

 PARAMETERS="
--accept-license
--no-questions
--ui=none
--x-prefix=$DESTDIR/usr
--x-module-path=$DESTDIR/usr/lib/xorg/modules
--x-library-path=$DESTDIR/usr/lib
--opengl-prefix=$DESTDIR/usr
--installer-prefix=$DESTDIR/usr
--utility-prefix=$DESTDIR/usr
--documentation-prefix=$DESTDIR/usr
--kernel-source-path=/usr/src/linux
--kernel-install-path=$DESTDIR/lib/modules/$LVER/kernel/drivers/video
--kernel-name=$LVER
--no-runlevel-check
--no-abi-note
--no-rpms
--no-backup 
--no-network
--no-recursion
--no-x-check
--no-cc-version-check
--no-distro-scripts"

local     BUILD_DIR="$SOURCE_DIR/$SPELL/$SPELL-$VERSION"
mkdir -p $BUILD_DIR
cd       $BUILD_DIR
echo -e "#!/bin/bash\n/sbin/lsmod | grep -v \"nvidia\|rivafb\|nvidiafb\"" > $BUILD_DIR/lsmod
chmod a+x $BUILD_DIR/lsmod
export PATH=$BUILD_DIR:$PATH

mkdir -p $DESTDIR/lib/modules/$LVER/kernel/drivers/video
mkdir -p $DESTDIR/usr/{include,lib}
bash $SOURCE $PARAMETERS &&
fix_install
}
