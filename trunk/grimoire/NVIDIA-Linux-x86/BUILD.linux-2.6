install_libs()  {

  cd  $BUILD_DIR/usr

  if    /lib/libc.so.6   |
        grep  -q  "Thread-local storage"
  then  cp    -a   X11R6/lib/modules/extensions/tls/*  \
                   X11R6/lib/modules/extentions
  fi

  /sbin/ldconfig  -n  lib  lib/tls   \
                         X11R6/lib   \
                         X11R6/lib/modules/extensions

  ln  -s  libGL.so.1      lib/libGL.so
  ln  -s  libGLcore.so.1  lib/libGLcore.so
  ln  -s  libGL.so.1      lib/tls/libGL.so
  ln  -s  libGLcore.so.1  lib/tls/libGLcore.so
   

  rm  -f  /usr/X11R6/lib/libGL.so*
  rm  -f  /usr/lib/libGL.so*
# rm  -f  /usr/lib/libGLU.so*
  rm  -f  /usr/X11R6/lib/modules/extentions/libglx.*
  rm  -f  /usr/X11R6/lib/modules/extentions/libGLcore.*
  rm  -f  /usr/X11R6/lib/libGL.a
# rm  -f  /usr/X11R6/lib/libGLU.a

  cp  -a   lib  X11R6  /usr/                2>/dev/null
  cp  -a   include/GL  /usr/X11R6/include/  2>/dev/null
  cp  -a   share/doc  ..                    2>/dev/null
  cp  -a   include    ../doc                2>/dev/null
}

make_device_nodes()  {
  for  ((CX=0;CX<8;CX++));  do
    NODE="/dev/nvidia$CX"
    rm     -f    $NODE
    mknod        $NODE  c  195  $CX
    chmod  0666  $NODE
  done
  NODE="/dev/nvidiactl"
  rm     -f    $NODE
  mknod        $NODE  c  195  255
  chmod  0666  $NODE
  true
}

chown  -R  root:root  *
cd  usr/src/nv

bzip2  -cd  $(  guess_filename  ${SOURCE[1]}  )  |
patch  -p1

LVER=$(  installed_version  $(  get_provider  linux  )  )

if    !  [  "${LVER:0:3}"  ==  "2.6"  ]
then           LVER="2.6.0"
fi

sed  -i  "s/\$(shell uname -r)/$LVER/"              Makefile.kbuild
sed  -i  "s/\$(shell uname -r)/$LVER/"              Makefile.nvidia
sed  -i  "s:install rmmod-sanity-check:install:"    Makefile.kbuild
sed  -i  "s:nvidia.o rmmod-sanity-check:nvidia.o:"  Makefile.nvidia
sed  -i  "s:/sbin/modprobe:true:"                   Makefile.kbuild
sed  -i  "s:/sbin/modprobe:true:"                   Makefile.nvidia
sed  -i  "s:/sbin/depmod:true:"                     Makefile.kbuild
sed  -i  "s:/sbin/depmod:true:"                     Makefile.nvidia

cp  Makefile.kbuild  Makefile
prepare_install                        &&
make    install  IGNORE_CC_MISMATCH=1  &&
install_libs                           &&
make_device_nodes
