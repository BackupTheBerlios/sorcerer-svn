#!/bin/bash
# Copyright 2000 through 2008 by Kyle Sallee,
# All rights reserved.
# For use with the distribution Sorcerer only.
# backup creates monthly backup tarballs of
# /bin /etc /lib /lib64 /opt /sbin /usr

fail(){ echo 'Backup failed'  1>&2; rm -f $TMP; }
made(){ echo 'Backup success' 1>&2; rm -f $BAK; mv $TMP $BAK; }

export LC_ALL=C
trap : SIGHUP SIGINT SIGQUIT SIGILL SIGABRT SIGSTOP SIGTERM

BAK=/var/cache/backup/"$( date -u +%Y%m ).tar.7z"
TMP=$BAK.tmp.$$$RANDOM

DIRS='/bin /etc /lib '; [[ $HOSTTYPE == x86_64 ]] && DIRS+='/lib64 '
DIRS+='/opt /sbin /usr'

renice 19      -p $$ &>/dev/null
ionice -c2 -n7 -p $$ &>/dev/null

find /var/cache/backup -type f -mtime +90 | xargs -r --max-lines=128 rm -f

rm    -f  $TMP
touch     $TMP
chmod 600 $TMP

if ! tar -cP $DIRS;      then fail; fi |
if ! 7za -bd -si "$TMP"; then fail; fi
if [[ -f $TMP ]];        then made; fi
