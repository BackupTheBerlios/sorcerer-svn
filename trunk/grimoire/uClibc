# Do not cast this unless the box is *-linux-uclibc,
# because otherwise a box must be properly cross-compiled
# to become a uClibc spell.
# forcing this to cast will only break a glibc installed box.

    stable 0.9.30.1 0.9.30 0.9.29
  category development
 attribute library solo; [[ ${MACHTYPE##*-} == gnu ]] &&
 attribute broke
   require linux-headers
    source http://www.uclibc.org/downloads/uClibc-$VERSION.tar.bz2
#   source http://www.uclibc.org/downloads/uClibc-locale-030818.tgz 
  homepage http://www.uclibc.org/
   exclude /etc/ld.so.cache
   exclude /etc/ld.so.conf
   protect /lib/ld-uClibc.so.0
#  protect /lib64/ld-uClibc-x86-64.so.0
   protect /etc/hostname
   protect /etc/hosts
   protect /etc/host.conf
   protect /etc/hosts
   protect /etc/hosts.allow
   protect /etc/hosts.deny
   protect /etc/hosts.equiv
   protect /etc/hosts.lpd
   protect /etc/networks
   protect /etc/nsswitch.conf
   protect /etc/resolv.conf
   protect /sbin/ldconfig
  estimate 1500
      desc 'a C library implementation ideally suited for embedded distributions'

build(){

 restore_config(){
  if   [ -d /boot/isolinux ]
  then local MAC="$HOSTTYPE"
  else local MAC="$( uname -m )"
  fi

  if   [ -f            $SCRIPT_DIR/$MAC ]
  then install -vm 600 $SCRIPT_DIR/$MAC .config
  else install -vm 600 $SCRIPT_DIR/i586 .config
  fi
 }

 del_library_cache(){
  ldconfig
  rm -fr ${LIBRARY_CACHE:-/lib.old}
  ldconfig
  true
 }

 install_libc(){
  cd $IR
  prepare_install
  cp -av * /
  del_library_cache
  true
 }

## unset LANG LC_ALL
#  find extra/locale -type f -printf "%P\n" | sed "/\.pairs$/p;d" > extra/locale/codesets.txt
## cp -v ${SOURCE[1]} extra/locale/

## mv -v c8tables.h locale_data.c locale_mmap.h lt_defines.h uClibc_locale_data.h wctables.h extra/locale/

# cp -v ${SOURCE[1]} extra/locale/uClibc-locale-20081111-32-el.tgz

           IR=$PWD/install
 mkdir -p $IR

 export   CFLAGS="-O2 $( echo "${CFLAGS// /$LF}" | grep march )"
 export LDFLAGS='-Wl,-s -Wl,-O1'
 export LC_ALL=C
 unset  LD_PRELOAD LTDL_LIBRARY_PATH LD_LIBRARY_PATH LD_RUN_PATH

 [ -f /opt/uClibc/usr/bin ] &&
 export PATH="/opt/uClibc/usr/bin:$PATH"

 restore_config
 yes "" | make oldconfig
 make     all       V=1            &&
 make install       V=1 PREFIX=$IR &&
 make install_utils V=1 PREFIX=$IR &&
 install_libc
}
