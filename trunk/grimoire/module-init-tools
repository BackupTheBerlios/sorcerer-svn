# version 3.4 exists in a user's directory, but is an official release?
# 3.4 does not compile due to complications created by using
# docbook2man from docbook2X and docbook2man does not work properly.

    stable 3.4.1 3.2.2 3.2.1 3.1 3.0
  unstable 3.4.1 3.4 3.2.2
   require bison flex init-functions zlib
  category kernel
 attribute console
       url $KERNEL_URL
    source pub/linux/utils/kernel/module-init-tools/module-init-tools-$VERSION.tar.bz2
  homepage ftp://ftp.kernel.org/pub/linux/kernel/people/rusty/modules/FAQ
      opts --enable-zlib
# Odd documentation building requirements for version 3.4
# case  $VERSION  in
#   3.[0-2])  :  ;;
#   3.[4-9])  require docbook2X docbook-sgml-4.2 ;;
# esac
## Unfortunately, with requirements installed it still errors:
## docbook2man doc/modprobe.conf.sgml
## I/O error : Attempt to load network entity http://docbook2x.sf.net/latest/xslt/man/docbook.xsl
## warning: failed to load external entity "http://docbook2x.sf.net/latest/xslt/man/docbook.xsl"
## cannot parse http://docbook2x.sf.net/latest/xslt/man/docbook.xsl
## Unable to recognise encoding of this document at 
## /usr/lib/perl5/site_perl/5.8.8/XML/SAX/PurePerl/EncodingDetect.pm line 100.
## Document requires an element [Ln: 1, Col: 0]

## docbook2X really aught to install any xsl sheets it requires.

   exclude /etc/modprobe.conf
   exclude /etc/modules.conf
   protect /etc/modules
   protect /etc/modules.rm
  eprovide linux-module-tools
  estimate 200
      desc 'module-init-tools provides modules utilities for linux 2.6.x and later kernels'

build(){
conf_install(){
 touch     /etc/modprobe.conf
 mkdir  -p /etc/modules.d
 if ! [[ -f /etc/modules    ]]; then cp -av $SCRIPT_DIR/modules    /etc; fi
 if ! [[ -f /etc/modules.rm ]]; then cp -av $SCRIPT_DIR/modules.rm /etc; fi
}

wrap_install(){
 install -m 700 $SCRIPT_DIR/modprobe /usr/sbin/
 install -m 700 $SCRIPT_DIR/rmmod    /usr/sbin/
}

sed -i 's:-Wl,-Bdynamic::
        s:-Wl,-Bstatic:-L/lib -L/lib64:' configure{.in,}
sed -i 's:insmod.static$(EXEEXT)::'      Makefile.in

case $VERSION in
 3.4.1) sed -i 's:install-exec-am install-data-am:install-exec-am:
                s:MAN5 =.*:MAN5 =:
                s:MAN8 =.*:MAN8 =:' Makefile.in ;;
esac

./configure          \
--build=$BUILD       \
--prefix=/           \
--datadir=/usr/share \
--sysconfdir=/etc    \
--localstatedir=/var \
--mandir=/usr/man    \
$OPTS                &&
make                 &&
prepare_install      &&
make    install      &&
   conf_install      &&
   wrap_install
}
