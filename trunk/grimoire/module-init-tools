# Oddly the version 3.16 is no longer hosted for download
# version 3.16 tarball disappeared from www.kernel.org
# following the restoration of services
# following the compromise of www.kernel.org

# version 3.12 does not support loading of xz compressed modules

with version stable 3.16
with base    bison flex init-functions zlib
#with base    bison docbook2X flex init-functions zlib
with also    --enable-zlib --enable-zlib-dynamic --disable-static-utils
with role    kernel
with trait   console
with source  $KERNEL_URL pub/linux/utils/kernel/module-init-tools/module-init-tools-$VERSION.tar.bz2
with info    good 20120625
with info    last 20110603
with info    home ftp://ftp.kernel.org/pub/linux/kernel/people/rusty/modules/FAQ
with omit    /etc/modules.conf
with protect /etc/modules
with protect /etc/modules.rm
with hold    linux-module-tools
with info    cite 'modules utilities for linux 2.6.x and later kernels'

build(){
conf_install(){
 mkdir -pvm 755 $DESTDIR/etc/modules.d
 cp    -av       $SCRIPT_DIR/modules    $DESTDIR/etc
 cp    -av       $SCRIPT_DIR/modules.rm $DESTDIR/etc
}

wrap_install(){
 mkdir  -pvm 755                      $DESTDIR/usr/sbin
 install -vm 700 $SCRIPT_DIR/modprobe $DESTDIR/usr/sbin/
 install -vm 700 $SCRIPT_DIR/rmmod    $DESTDIR/usr/sbin/
}

# sed -i 's:-Wl,-Bdynamic::
#         s:-Wl,-Bstatic:-L/lib -L/lib64:' configure{.in,}
# sed -i 's:insmod.static$(EXEEXT)::'      Makefile.in

case $VERSION in
 3.16*) sed -i 's:MAN8 = .*:MAN8 =:
                s:MAN5 = .*:MAN5 =:
                /modules.dep.5 modules.dep.bin.5/d' Makefile.in ;;
 3.12*) sed -i 's:install-exec-am install-data-am:install-exec-am:
                s:MAN5 =.*:MAN5 =:
                s:MAN8 =.*:MAN8 =:' Makefile.in ;;
esac

./configure \
--prefix=/ \
--datadir=/usr/share \
--sysconfdir=/etc \
--localstatedir=/var \
--mandir=/usr/man \
$OPTS &&
make &&
make install DESTDIR=$DESTDIR &&
conf_install &&
wrap_install
}
