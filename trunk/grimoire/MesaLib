    stable 7.8.2 7.8.1 7.7.1
  unstable 7.9
   require dri2proto expat gcc-g++ glproto libXdamage libXi libXmu libXxf86vm libdrm makedepend
  category graphic/library
 attribute library makej x11 X11R7 hidden
    source ftp://ftp.freedesktop.org/pub/mesa/$VERSION/MesaLib-$VERSION.tar.bz2
    source ftp://ftp.freedesktop.org/pub/mesa/$VERSION/MesaGLUT-$VERSION.tar.bz2
    source ftp://ftp.freedesktop.org/pub/mesa/$VERSION/MesaDemos-$VERSION.tar.bz2
      home http://www.mesa3d.org
  estimate 2700
      desc '3-D graphics library with an API similar to OpenGL'

    CFLAGS='-O3'
   LDFLAGS='-Wl,-O1'

build(){ (

 install_demos(){
  mkdir -p $DESTDIR/usr/bin
  install -vm 755 progs/xdemos/{glxgears,glxinfo} $DESTDIR/usr/bin
 }

 install_drirc(){
  mkdir -p $DESTDIR/etc
  install -vm 644 $SCRIPT_DIR/drirc $DESTDIR/etc
 }

 if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
 then CONFIG_NAME=linux-dri-x86-64 ; LIB=lib64
 else CONFIG_NAME=linux-dri        ; LIB=lib
 fi

# linux-dri-x86 causes failed compilation on i586
# due to use of compiler flags for non supported CPU instruction sets.

 echo "DRI_DRIVER_INSTALL_DIR = /usr/${LIB}/dri" >> configs/${CONFIG_NAME}

 sed -ri 's:/usr/local:/usr:g' configs/default*

 # According to Evert Vorster
 # MesaLib should be compiled with -fno-strict-aliasing added to CFLAGS
 # in order for OpenGL to work with xf86-video-intel drivers
 CFLAGS+=' -fno-strict-aliasing'

 if   [[ $HOSTTYPE == x86_64 ]] && [[ $CFLAGS =~ -m32 ]]
 then opts --host="${MACHTYPE/x86_64/i686}"
 fi

 ./configure \
  --prefix=/usr \
  --enable-shared \
  --disable-static \
  --enable-pic \
  --enable-xcb \
  $OPTS &&
 make   &&
 make install "DESTDIR=$DESTDIR" &&
      install_demos &&
      install_drirc
) }


post_install(){
 recast(){
  if   spell_installed "$1"
  then echo            "$1" | pipe_queue "$CAST_QUEUE" com
  fi
 }
  recast ati-driver-installer
  recast NVIDIA-Linux-x86
}
