# was MesaGLUT included as part of the MesaLib tarball for version 8.0?
# MesaLib 8.0 removes DRI drivers that do not support DRI2:
# i810, mach64, mga, r128, savage, sis, tdfx
# Removal of i810 might effect some old desktops and laptops?

# MesaLib inherits ELF link with systemd if udev linked with systemd
# but do not explicitly specifiy otherwise it creates a requirement loop

# adding udev to requirement list creates recursive requirement loop

with info    last 20130723
with version   stable 9.1.5 9.1.4 9.1.3
with version unstable 9.1.5 9.1.4 9.1.3
with version   legacy 8.0.5
#with version      git snb-magic-12212-g99f14bc

with base    dri2proto glproto libXdamage libXi libXmu libXxf86vm libdrm libxml2 llvm makedepend systemd
#with base    dri2proto glproto libXdamage libXi libXmu libXxf86vm libdrm llvm makedepend udev
#with base    gcc-g++
with also    --with-gallium-drivers=i915,nouveau,r300,r600,svga,swrast
#with also    --with-gallium-drivers=i915,i965,nouveau,r300,r600,swrast
with role    graphic/library
with trait   X11R7 hidden library optimize x11
with trait   litelink
with trait   makej multilib-dual
with source    stable ftp://ftp.freedesktop.org/pub/mesa/$VERSION/MesaLib-$VERSION.tar.bz2
with source  unstable ftp://ftp.freedesktop.org/pub/mesa/$VERSION/MesaLib-$VERSION.tar.bz2
with source    legacy ftp://ftp.freedesktop.org/pub/mesa/$VERSION/MesaLib-$VERSION.tar.bz2
#with source       git MesaLib-$VERSION.tar $VERSION git://anongit.freedesktop.org/git/mesa/mesa
with info    home http://www.mesa3d.org
with info    mail http://www.mesa3d.org/lists.html
with info    bugs http://www.mesa3d.org/bugs.html
with info    cite '3-D graphics library with an API similar to OpenGL'

build(){
 install_drirc(){
  mkdir  -pvm 755                     "$DESTDIR"/etc
  install -vm 644 "$SCRIPT_DIR"/drirc "$DESTDIR"/etc
 }
 

 if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
 then CONFIG_NAME=linux-dri-x86-64 ; LIB=lib64
 else CONFIG_NAME=linux-dri        ; LIB=lib
 fi

# linux-dri-x86 causes failed compilation on i586
# due to use of compiler flags for non supported CPU instruction sets.

 echo "DRI_DRIVER_INSTALL_DIR = /usr/${LIB}/dri" >> configs/${CONFIG_NAME}

 sed -ri 's:/usr/local:/usr:g' configs/default*

 # According to Evert Vorster
 # MesaLib should be compiled with -fno-strict-aliasing added to CFLAGS
 # in order for OpenGL to work with xf86-video-intel drivers
 export CFLAGS+=' -fno-strict-aliasing'

 if   [[ $HOSTTYPE == x86_64 ]] && [[ $CFLAGS =~ -m32 ]]
 then OPTS+=" ${MACHTYPE/x86_64/i686}"
 fi

 case $VERSION in
  9.0.1) autoreconf; automake -afc; aclocal; autoconf -f; libtoolize -cf ;;
      *) if [ -f autogen.sh ]; then sh ./autogen.sh; fi ;;
 esac

 ./configure \
  --prefix=/usr \
  --enable-shared \
  --disable-static \
  --enable-pic \
  --enable-xcb \
  $OPTS &&
 make   V=1 &&
 make install DESTDIR="$DESTDIR" &&
      install_drirc
}


post_install(){
 recast(){
  if   spell_installed "$1"
  then echo            "$1" | pipe_queue "$MOIL_QUEUE"
  fi
 }
  recast ati-driver-installer
  recast NVIDIA-Linux-x86
  recast NVIDIA-Linux-x86_64
}
