# 7.0.2 is missing glw.pc.in and therefore fails during installation
# 7.3 requires dri2proto 1.99.3+
# 7.2 failed compilation recently.

# with 7.5
# /usr/bin/ld: cannot find -lGLEW
# collect2: ld returned 1 exit status
# make[3]: *** [arbfplight] Error 1
# make[3]: Leaving directory `/usr/src/sorcery/MesaLib/Mesa-7.5/progs/demos'


    stable 7.4.4 7.4.3 7.4.2 7.4.1 7.2 7.0.1 6.5.2
  unstable 7.5
   require dri2proto expat glproto libXdamage libXi libXmu libXxf86vm libdrm makedepend
  category graphic/library
 attribute library x11 X11R7
       url $SOURCEFORGE_URL
    source mesa3d/MesaLib-$VERSION.tar.bz2
       url $SOURCEFORGE_URL
    source mesa3d/MesaGLUT-$VERSION.tar.bz2 
       url $SOURCEFORGE_URL
    source mesa3d/MesaDemos-$VERSION.tar.bz2
  homepage http://www.mesa3d.org
    CFLAGS='-O3'
   LDFLAGS='-Wl,-O1'
  estimate 6000
      desc '3-D graphics library with an API similar to OpenGL'

build(){

 install_demos(){ install -vm 755 progs/xdemos/{glxgears,glxinfo} /usr/bin; }
 install_drirc(){ install -vm 644 $SCRIPT_DIR/drirc /etc; }

 case $HOSTTYPE in
  x86_64) CONFIG_NAME=linux-dri-x86-64 ; LIB=lib64 ;;
       *) CONFIG_NAME=linux-dri-x86    ; LIB=lib   ;;
 esac

#echo "DRI_DRIVER_INSTALL_DIR = /usr/${LIB}/modules/dri" >> configs/${CONFIG_NAME}
 echo "DRI_DRIVER_INSTALL_DIR = /usr/${LIB}/dri" >> configs/${CONFIG_NAME}

 sed -ri 's:/usr/local:/usr:g' configs/default*

 # According to Evert Vorster
 # MesaLib should be compiled with -fno-strict-aliasing added to CFLAGS
 # in order for OpenGL to work with xf86-video-intel drivers
 CFLAGS+=' -fno-strict-aliasing'

 make    "$CONFIG_NAME"           \
         "PIC_FLAGS=-fPIC"        \
         "OPT_FLAGS=$CFLAGS"      &&
 cd      progs/xdemos             &&
 make    PROGS='glxinfo glxgears' &&
 cd      ../..                    &&
 prepare_install       &&
 make    install       &&
         install_demos &&
         install_drirc &&
 sed -i 's:#  define GLUTAPIENTRY GLAPIENTRY:#  define GLUTAPIENTRY:' /usr/include/GL/glut.h 
 #PREVIOUS line is to fix a mistake in the header -- JLM
}


post_install(){
 recast(){
  if   spell_installed "$1"
  then echo            "$1" | pipe_queue "$CAST_QUEUE" com
  fi
 }
  recast ati-driver-installer
  recast NVIDIA-Linux-x86
}
