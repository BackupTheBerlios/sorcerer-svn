# was MesaGLUT included as part of the MesaLib tarball for version 8.0?
# MesaLib 8.0 removes DRI drivers that do not support DRI2:
# i810, mach64, mga, r128, savage, sis, tdfx
# Removal of i810 might effect some old desktops and laptops?

# 7.11 is developmental version and 7.11.1 will be next stable release

   version   stable 8.0.2 8.0.1 7.11.2 7.11.1 7.10.3
#  version unstable 8.0
   version   legacy 7.11.2
   require dri2proto glproto libXdamage libXi libXmu libXxf86vm libdrm llvm makedepend udev
#  require gcc-g++
      opts --with-gallium-drivers=i915,nouveau,r300,r600,svga,swrast
#     opts --with-gallium-drivers=i915,i965,nouveau,r300,r600,swrast
  category graphic/library
 attribute X11R7 hidden library optimize x11
# linking requires too much memory to be multilib and makej
# yet it works provided enough RAM exists.
#attribute X11R7 hidden library makej multilib-dual optimize x11
    source ftp://ftp.freedesktop.org/pub/mesa/$VERSION/MesaLib-$VERSION.tar.bz2
case $VERSION in
 7.1*)
    source ftp://ftp.freedesktop.org/pub/mesa/$VERSION/MesaGLUT-$VERSION.tar.bz2 ;;
# 8.0.1)
#    source ftp://ftp.freedesktop.org/pub/mesa/7.11.2/MesaGLUT-7.11.2.tar.bz2 ;;
esac
      info last 20120323
      info home http://www.mesa3d.org
      info mail http://www.mesa3d.org/lists.html
      info bugs http://www.mesa3d.org/bugs.html
      desc '3-D graphics library with an API similar to OpenGL'

build(){
 install_drirc(){
  mkdir  -pvm 755                   $DESTDIR/etc
  install -vm 644 $SCRIPT_DIR/drirc $DESTDIR/etc
 }
 

 if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
 then CONFIG_NAME=linux-dri-x86-64 ; LIB=lib64
 else CONFIG_NAME=linux-dri        ; LIB=lib
 fi

# linux-dri-x86 causes failed compilation on i586
# due to use of compiler flags for non supported CPU instruction sets.

 echo "DRI_DRIVER_INSTALL_DIR = /usr/${LIB}/dri" >> configs/${CONFIG_NAME}

 sed -ri 's:/usr/local:/usr:g' configs/default*

 # According to Evert Vorster
 # MesaLib should be compiled with -fno-strict-aliasing added to CFLAGS
 # in order for OpenGL to work with xf86-video-intel drivers
 export CFLAGS+=' -fno-strict-aliasing'

 if   [[ $HOSTTYPE == x86_64 ]] && [[ $CFLAGS =~ -m32 ]]
 then OPTS+=" ${MACHTYPE/x86_64/i686}"
 fi

 ./configure \
  --prefix=/usr \
  --enable-shared \
  --disable-static \
  --enable-pic \
  --enable-xcb \
  $OPTS &&
 make   &&
 make install "DESTDIR=$DESTDIR" &&
      install_drirc
}


post_install(){
 recast(){
  if   spell_installed "$1"
  then echo            "$1" | pipe_queue "$CAST_QUEUE"
  fi
 }
  recast ati-driver-installer
  recast NVIDIA-Linux-x86
  recast NVIDIA-Linux-x86_64
}
