   version stable 7.10.3 7.10.2 7.8.2 7.8.1 7.7.1
   version unstable 7.10.2 7.9
   require dri2proto glproto libXdamage libXi libXmu libXxf86vm libdrm makedepend udev
#  require gcc-g++
  category graphic/library
 attribute X11R7 hidden library makej multilib-dual x11
#attribute multilib-concurrent
    source ftp://ftp.freedesktop.org/pub/mesa/$VERSION/MesaLib-$VERSION.tar.bz2
    source ftp://ftp.freedesktop.org/pub/mesa/$VERSION/MesaGLUT-$VERSION.tar.bz2
      info last  20110617
      info home  http://www.mesa3d.org
      desc '3-D graphics library with an API similar to OpenGL'
    CFLAGS='-O2'
   LDFLAGS='-Wl,-O1'

build(){
 applypatch(){
  if   [[ $HOSTTYPE == x86_64 ]] && [[ $VERSION == 7.10.2 ]]
  then patch -p1 -R < ${SCRIPT_DIR}/Mesa-7.10.2-r200fix.patch
  fi
 }

 install_drirc(){
  mkdir  -pvm 755                   $DESTDIR/etc
  install -vm 644 $SCRIPT_DIR/drirc $DESTDIR/etc
 }
 

 if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
 then CONFIG_NAME=linux-dri-x86-64 ; LIB=lib64
 else CONFIG_NAME=linux-dri        ; LIB=lib
 fi

# linux-dri-x86 causes failed compilation on i586
# due to use of compiler flags for non supported CPU instruction sets.

 echo "DRI_DRIVER_INSTALL_DIR = /usr/${LIB}/dri" >> configs/${CONFIG_NAME}

 sed -ri 's:/usr/local:/usr:g' configs/default*

 # According to Evert Vorster
 # MesaLib should be compiled with -fno-strict-aliasing added to CFLAGS
 # in order for OpenGL to work with xf86-video-intel drivers
 export CFLAGS+=' -fno-strict-aliasing'

 if   [[ $HOSTTYPE == x86_64 ]] && [[ $CFLAGS =~ -m32 ]]
 then OPTS+=" ${MACHTYPE/x86_64/i686}"
 fi

 applypatch &&
 ./configure \
  --prefix=/usr \
  --enable-shared \
  --disable-static \
  --enable-pic \
  --enable-xcb \
  $OPTS &&
 make   &&
 make install "DESTDIR=$DESTDIR" &&
      install_drirc
}


post_install(){
 recast(){
  if   spell_installed "$1"
  then echo            "$1" | pipe_queue "$CAST_QUEUE"
  fi
 }
  recast ati-driver-installer
  recast NVIDIA-Linux-x86
  recast NVIDIA-Linux-x86_64
}
