# Copyright Kyle Sallee 2011, 2012
# All rights reserved.
# For use with the distribution sorcerer only!

   version stable 20120819
   require md5crypt tomoyo-tools
  category immune-system
 attribute archive_off solo stale
      info last 20120819
      info home http://sorcerer.silverice.org/
      desc 'enhanced security

Tomoyo on Sorcerer has 5 generally used domain
<kernel> /sbin/init
<kernel> /media/root/domain/freedom
<kernel> /media/root/domain/user
<kernel> /media/root/domain/limited
<kernel> /media/root/domain/sorcery

The first domain is a default domain and provides no restrictions.
The second domain provides no resctrictions.
The third domain provides restrictions appropriate for users.
The forth domain provides restrictions appropraite
for servers/daemons that do not provide user login.
The fifth domain has restrictions suitable for software compilation,
but not software installation.

Domain transition is accomplished by running
a domain transition script installed in /domain/

Transitioning to domain
<kernel> /media/root/domain/freedom
allowed only from
<kernel> /media/root/domain/user
requires authentication with the root password when root.
However, any user can authenticate with a password
that was specified by the SA
when the SA previously runs
# /etc/init.d/tomoyo-freedom-password configure
Authentication ensures that those who achieve root UID
are rightfully entitled to the privilege of root
rather than having acquired root by exploiting a bug
in a process already running as root
or by exploiting a bug in a SUID 0 executable file.

Processes in domain
<kernel> /media/root/domain/limited
<kernel> /media/root/domain/user
will be unable to modify files in
/bin /boot /etc /home /lib /lib64 /opt /usr /var/log/
Mounting also is disabled.
This limits the damage that can be done
when someone acquires UID 0 without authentication.

Processes in domain
<kernel> /media/root/domain/limited
will be unable to execute files on temporary directories
and are unable to modify files in home directories.

tomyo can still be configured to provide
mandatory access control lists specific to programs
exactly as described in the tomoyo documentations.
Write the new domain files in /etc/tomoyo/sorcerer/domain/
Write the new exception files in /etc/tomoyo/sorcerer/exception/
Write the transition scripts in  /etc/tomoyo/sorcerer/transition/
That way the modifications are merged
with Sorcerer defaults and loaded into the kernel.

Tomoyo on Sorcerer is not intended to replace traditional security.
Rather the security model is enforced by ensuring that those
who become root can also provide the root password
before gaining privilege to make potentially unwated modifications.

Note that services might have custom domains
that that are far more restrictive than the limited domain.'

build(){
 mkdir   -pvm 755                     $DESTDIR/usr/bin/
 install -pvm 755 $SCRIPT_DIR/sulogin $DESTDIR/usr/bin/
}

post_install(){
 rm -f           /root/.bash_history
 ln -s /dev/null /root/.bash_history
 if   [ -f /lib64/tomoyo/init_policy ]; then /lib64/tomoyo/init_policy --file-only-profile --max_learning_entry=65536
 elif [ -f   /lib/tomoyo/init_policy ]; then   /lib/tomoyo/init_policy --file-only-profile --max_learning_entry=65536
 fi
 return 0
}
