wait_for_prc(){
        running(){ ps -C prc --no-headers -o fname | grep -q prc; }
 if     running; then
  while running; do sleep 1; done
  read -n 1 -t 60 -p "Wait 60 seconds or press space to continue"
 fi
}

first_boot_menu(){

 installed(){ augur installed "$1" | grep -qx "$1"; }

 main_menu(){

  HELP=$"\
If a Sorcerer Sentient workstation is desired
then sorcerer-sentient should probably be installed.
Otherwise dispel this menu and install software
by using the sorcery tools such as:
augur the command line tool;
sorcery the menu driven tool."

  dialog --backtitle "Sorcerer" \
         --title "First Boot Menu" \
         --stdout --ok-label Select --cancel-label Shell \
         --item-help --menu "$HELP" 0 0 0 \
  Dispel   "# augur being reap/immune-boot-first" \
           "Removes this menu to allow for normal booting" \
  Scry     "# augur scry" \
           "View the heads up display of sorcery activity" \
  WPA      "# /etc/init.d/wpa_supplicant configure" \
           "Adjust the WPA configuration information for this computer" \
  Kiosk    "# augur begin immune-auto-login" \
           "Provides an automatic KDE user login on each boot" \
  Sentient "# augur begin sorcerer-sentient" \
           "Installs Sorcerer Sentient workstation loadout"
 }

 dialog --msgbox "\
Deployment is two parts.
First, a base system was installed.

Second, role specific software should be installed.
This requires a configured networking device.
The device was configured automatically.
If encryption is required
then the SA must configure networking." 0 0

 while REPLY=$( main_menu ); do
  case $REPLY in
   Scry)     augur scry ;;
   WPA)      /etc/init.d/wpa_supplicant configure ;;
   Sentient) TERM=dumb augur begin sorcerer-sentient ;;
   Kiosk)    TERM=dumb augur begin kde immune-auto-login ;;
   Dispel)   augur begin reap/immune-boot-first ;;
  esac
 done
}

if read < /proc/cmdline; ! [[ $REPLY =~ boot=IR ]]; then
 if   (( UID == 0 ))
 then wait_for_prc; first_boot_menu
 fi
fi
