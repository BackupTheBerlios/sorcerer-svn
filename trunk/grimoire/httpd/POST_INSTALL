generate_certificates() {
  if  ! grep -q "configured" $SPELL_CONFIG; then
    echo "configured" >>$SPELL_CONFIG
    if grep -q "APACHE_SSL=true" $SPELL_CONFIG; then
      echo the passphrase will be asked several time by the tools, this is normal
      for I in 1 2 3 4 5; do
        dd if=/dev/urandom of=file${I} count=20
      done
      openssl genrsa -des3 -rand file1:file2:file3:file4:file5 -out server.key 1024 2>&1 &&
      openssl req -new -key server.key -out server.csr  2>&1 &&
      openssl rsa -in server.key -out server.pem 2>&1 2>&1 &&
      openssl x509 -req -days 1000 -in server.csr -signkey server.key -out server.crt 2>&1 &&
      chown root\:root  server.csr server.key server.crt server.pem 2>&1 &&
      chmod go-rwx server.csr server.key server.crt server.pem 2>&1 &&
      mkdir -p /etc/httpd/ssl.crt &&
      mkdir -p /etc/httpd/ssl.key &&
      mv server.crt /etc/httpd/ssl.crt &&
      mv server.pem /etc/httpd/ssl.key &&
      sed -i "s:^#SSLCertificateFile /etc/httpd/ssl.crt/server.crt:SSLCertificateFile /etc/httpd/ssl.crt/server.crt:" /etc/httpd/ssl.conf &&
      sed -i "s:^#SSLCertificateKeyFile /etc/httpd/ssl.key/server.key:SSLCertificateKeyFile /etc/httpd/ssl.key/server.pem" /etc/httpd/ssl.conf
    fi
  fi
}





recast()  {
  PRO="$(  get_provider    "$1"    )"
  if      [  -n            "$PRO"  ]  &&
          spell_installed  "$PRO"     &&
        ! spell_held       "$PRO"
  then  cast               "$PRO"
  fi
}


generate_certificates
unlock_cast

recast  php
recast  mod_perl

/etc/init.d/httpd.sh  start
true
