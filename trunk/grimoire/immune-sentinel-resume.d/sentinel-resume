#!/bin/bash
# Copyright 2011 by Kyle Sallee,
# All rights reserved.
# For use with the Sorcerer distribution only.

# sentinel-resume periodically checks and resumes processing 
# of delayed or paused spells to avert intentional and unintentional stalls.

find_cgroup(){
 if [ -n "$CG" ]; then return 0; fi
 local DEV JUNK TYPE
 while read DEV CG TYPE JUNK; do
  if   [[ $DEV == cgroup_root ]] && [[ $TYPE == tmpfs  ]]; then return 0
  elif [[ $DEV == cgroup      ]] && [[ $TYPE == cgroup ]]; then return 0
  fi
 done < /proc/mounts
 unset CG
 return 1
}

thaw(){
 if ! [ -d $CG/freezer/sorcery/cast ]; then return 0; fi
 find      $CG/freezer/sorcery/cast -type f -name freezer.state -mmin +480 |
 xargs -r --max-lines=64 grep -l FROZEN |
 while read
 do    echo THAWED > $REPLY
 done
}

stalled(){
 if   [ -n "$( find /root/.sorcery/queue/$1 -maxdepth 1 -type f -mmin +10 )" ]
 then ! pgrep -u root "^$1$"
 fi
}

scan(){
 thaw
 if   stalled leech; then leech
 elif stalled cast;  then cast
 fi
}


main(){
 sleep 120; scan
 while sleep 900; do scan; done
}

find_cgroup

if   [[     -x /usr/libexec/bash/sleep ]]
then enable -f /usr/libexec/bash/sleep sleep
fi

main &>/dev/null &
exit 0
