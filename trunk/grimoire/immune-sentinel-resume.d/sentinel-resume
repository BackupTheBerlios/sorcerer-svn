#!/bin/bash
# Copyright 2011 by Kyle Sallee,
# All rights reserved.
# For use with the Sorcerer distribution only.

# sentinel-resume periodically checks and resumes processing 
# of delayed or paused spells to avert intentional and unintentional stalls.

find_cgroup(){
 if [ -n "$CG" ]; then return 0; fi
 local DEV JUNK TYPE
 while read DEV CG TYPE JUNK; do
  if   [[ $DEV == cgroup_root ]] && [[ $TYPE == tmpfs  ]]; then return 0
  elif [[ $DEV == cgroup      ]] && [[ $TYPE == cgroup ]]; then return 0
  fi
 done < /proc/mounts
 unset CG
 return 1
}

thaw(){
 if [ -d /root/.sorcery/queue/cast ]; then
  find   /root/.sorcery/queue/cast/ -not -empty -mmin +480 -type f -printf "%f\n" |
  while read SPELL; do
   if   [ -f   $CG/freezer/sorcery/cast/$SPELL ] &&
        find   $CG/freezer/sorcery/cast/$SPELL -mmin +480 | grep -q .
   then read < $CG/freezer/sorcery/cast/$SPELL
    if   [[   FROZEN == $REPLY ]]
    then echo THAWED > $CG/freezer/sorcery/cast/$SPELL
    fi
   fi
  done
 fi
}

stalled(){
 if   [ -d          /root/.sorcery/queue/$1 ] &&
      [ -n "$( find /root/.sorcery/queue/$1 -maxdepth 1 -type f -mmin +1 )" ]
 then ! pgrep -u root "^$1$"
 else return 1
 fi
}

scan(){
 # cast might be waiting for a source to download.
 thaw
 if   stalled leech || stalled cast
 then augur begin </dev/null &
 fi
}

main(){
 sleep 120; scan
 while sleep 300; do scan; done
}

find_cgroup

if   [[     -x /usr/libexec/bash/sleep ]]
then enable -f /usr/libexec/bash/sleep sleep
fi

main </dev/null &>/dev/null &
exit 0
