# systemd supplanted the udev project at release 183
# forked up udev is now included and installed with systemd

# The optional on libgee installs gobject-introspection and much of xorg

   version   stable 188 186
   require acl cryptsetup dbus glib gperf intltool kmod libcap pci.ids pkgconfig sysvinit usbutils
  optional ConsoleKit
  optional libgee
      opts --disable-introspection --sbindir=/sbin --libexecdir=/lib --bindir=/sbin
      opts --with-rootprefix=
      opts --with-distro=other
  category utility
 attribute console library lto makej multilib-concurrent optimize server
    source http://www.freedesktop.org/software/systemd/systemd-$VERSION.tar.xz
      info last 20120808
      info home http://www.freedesktop.org/wiki/Software/systemd
   exclude /dev
   exclude /lib/udev/dev/core
      desc 'replacement for sysvinit'

build(){

# /dev/zero and /dev/mem are needed for uvesafb before udevd starts

 nod_sym_install(){
  mkdir -vpm 755                        $DESTDIR/lib/udev/dev/{pts,shm}
  /bin/ln -fns /proc/self/fd            $DESTDIR/lib/udev/dev/fd
  /bin/ln -fns /proc/self/fd/0          $DESTDIR/lib/udev/dev/stdin
  /bin/ln -fns /proc/self/fd/1          $DESTDIR/lib/udev/dev/stdout
  /bin/ln -fns /proc/self/fd/2          $DESTDIR/lib/udev/dev/stderr
  /bin/ln -fns /proc/kcore              $DESTDIR/lib/udev/dev/core
  /bin/ln -fns /proc/asound/oss/sndstat $DESTDIR/lib/udev/dev/sndstat
  rm    -f                              $DESTDIR/lib/udev/dev/{console,mem,null,zero}
  mknod -m 600                          $DESTDIR/lib/udev/dev/console c 5 1
  mknod -m 640                          $DESTDIR/lib/udev/dev/mem     c 1 1
  mknod -m 666                          $DESTDIR/lib/udev/dev/null    c 1 3
  mknod -m 444                          $DESTDIR/lib/udev/dev/zero    c 1 5
  mknod -m 660                          $DESTDIR/lib/udev/dev/kmsg    c 1 11
  true
 }

# The extra rules are needed to create frequently needed nodes 
# and symlinks. Also needed to set privileges to nodes like
# /dev/dsp, etc.

 rules_install(){
  mkdir   -vpm 755                      $DESTDIR/lib/udev/rules.d
  install -vm 644 $SCRIPT_DIR/rules.d/* $DESTDIR/lib/udev/rules.d/
 }

 if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
 then opts --with-rootlibdir=/lib64
 else opts --with-rootlibdir=/lib
 fi

 export   CFLAGS="${CFLAGS//-flto/}"
 export CXXFLAGS="${CXXFLAGS//-flto/}"
 export  LDFLAGS="$( echo "$LDFLAGS" | sed "s:-flto=[^ ]::" )"

 # systemd is not compatible with openpam
 if   spell_installed openpam
 then opts --disable-pam
 fi

 default_build   &&
 nod_sym_install &&
   rules_install
}

post_install(){
 if   LC_ALL=C grep -q '^mem:x:'  /etc/group
 then sed -i 's/^mem:x:/kmem:x:/' /etc/group
 fi
}
