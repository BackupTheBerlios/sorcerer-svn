#!/bin/bash

### BEGIN INIT INFO
# Default-Mode: 500
# Required-Start: bind_dev $local_fs
# Default-Start: S
# Short-Description: binds mounted virtual filesystems into /media/root
### END INIT INFO

. /lib/lsb/init-functions
only start
deny control

start(){
 run(){
  cut -d ' ' -f2 /proc/mounts |
  sed '\,^/$,d;\,^/media/root,d;\,^/dev$,d' |
  LC_ALL=C sort |
  while read; do
   if   log_warning_msg "$REPLY binding"
        [ -d                    /media/root$REPLY ] ||
        mkdir -pm 755           /media/root$REPLY &&
        mount --bind     $REPLY /media/root$REPLY
   then log_success_msg "$REPLY bound"
   else log_failure_msg "$REPLY not bound"
   fi
  done
 }

 [ -f /media/root/sbin/init ] || return
 log_warning_msg 'Virtual filesystems to /media/root binding'; run
 log_success_msg 'Virtual filesystems to /media/root bound'
}
