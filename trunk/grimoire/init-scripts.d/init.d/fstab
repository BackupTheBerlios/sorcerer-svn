#!/bin/bash

### BEGIN INIT INFO
# Default-Mode: 500
# Should-Start: alt_boot find_ir udevsettle
# Default-Start: S
# Short-Description: avoids rdinit=/bin/bash when / is not in fstab
# Description: fstab checks for / in /etc/fstab and rewrites it to /media/root/main
### END INIT INFO

read < /proc/cmdline
if   [ -d /home ] || [[ $REPLY =~ boot=IR ]]
then exit 0
fi

. /lib/lsb/init-functions

only start
deny control

start(){
 root_menu(){
  block(){ /bin/find /dev -type b -printf '%p	%Y\n' | /bin/sed '/loop/d'; }

  /bin/dialog --backtitle fstab --stdout --no-cancel --title "Root Device Menu" \
              --menu "Expected / in /etc/fstab" 0 0 0 /sbin/sulogin '' $( block )
 }

 interact(){
  # usb disk device may not be immediately available?
  /bin/sleep 5
  ROOT=$( root_menu )
  case $ROOT in
   /sbin/sulogin) /sbin/sulogin -t 300 1>/dev/console 2>&1 0</dev/console ;;
   /dev*) echo "$ROOT /media/root/main auto defaults 0 0" >> /etc/fstab.rootfs
  esac
 }

 check(){ [ -n "$( /bin/sed "s/#.*//;s:\t: :g;\: $1:p;d" /etc/fstab.rootfs )" ]; }

 copy(){
  /bin/sed 's:#.*::' /etc/fstab |
  /bin/sed 's:\t: :g' |
  /bin/sed 's: / : /media/root/main :p;d' > /etc/fstab.rootfs
 }

 [ -f /etc/fstab.rootfs ] || copy

 if   log_warning_msg '/etc/fstab.rootfs contains /media/root checking'; check /media/root/
 then log_success_msg '/etc/fstab.rootfs contains /media/root verified'
 else log_failure_msg 'root file system search failed'; interact
 fi
}
