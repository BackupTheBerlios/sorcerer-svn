#!/bin/bash

### BEGIN INIT INFO
# Default-Mode: 500
# Required-Start: root-rw root-rw-retry root-alt
# Default-Start: S
# Short-Description: binds /dev to /media/root/dev
### END INIT INFO

. /lib/lsb/init-functions
only start
deny control

start(){
 destination(){
  while read
  do    find /media/root -mindepth 1 -maxdepth 1 -type d -printf "/dev %f/dev\n"
  done
 }

 b(){ [ -d "$2" ] || mkdir -pm 755 "$2"; mount --bind "$1" "$2"; }

 bind(){
   if   log_warning_msg "mount --bind $1 $2 executing"; b "$1" "$2"
   then log_success_msg "mount --bind $1 $2 executed"
   else log_failure_msg "mount --bind $1 $2 failed"; return 1
   fi
 }

 run(){
  local r=0
  for  d in /media/root/*
  do   bind /dev "$d/dev" || r=1
  done
  return $r
 }

 has_root(){
  for d in /media/root/*/usr
  do  [ -d $d ] && return 0
  done
  exit 0
 }

 has_root
 if   log_warning_msg '/dev to /media/root/*/dev binding'; run
 then log_success_msg '/dev to /media/root/*/dev bound'
 else log_failure_msg '/dev to /media/root/*/dev bound failed'
 fi
}
