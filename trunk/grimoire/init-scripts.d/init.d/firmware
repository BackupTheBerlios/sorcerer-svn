#!/bin/bash

### BEGIN INIT INFO
# Default-Mode: 500
# Required-Start: $local_fs
# Should-Start: root-rw
# Default-Start: S
# Short-Description: provides modules to root file systems that lack.
### END INIT INFO

. /lib/lsb/init-functions

if   ! rootfs
then echo "$0 can only be executed on the rootfs"; trap - EXIT; exit 1
fi

only start
deny control

firm_copy(){
 local d="$1"
 if   ! [   -d      "$d/lib/firmware/" ]
 then mkdir -pm 755 "$d/lib/firmware/" &&
      cp    -av     {,"$d"}/lib/firmware/
 elif ! [   -d      "$d/lib/firmware/$V/" ]
 then cp    -av     {,"$d"}/lib/firmware/
 fi
}

firm_check(){ [ -d "$1/lib/firmware/" ]; }

start(){
 local r
 for d in /media/root/*; do
  if   ! [ -f "$d/init" ]; then continue; fi
  if   log_warning_msg "$d/lib/firmware/ checking"; firm_check "$d"
  then log_success_msg "$d/lib/firmware/ exists"
  elif log_warning_msg "$d/lib/firmware/ copying";  firm_copy  "$d"
  then log_success_msg "$d/lib/firmware/ installed"
  else log_failure_msg "$d/lib/firmware/ copy failed"; r=1
  fi
 done
 return $r
}
