#!/bin/bash

# Copyright Kyle Sallee 2011
# All rights reserved.
# For use with the distribution sorcerer only!

# A cgroup with a sub-cgroup can not be removed.
# That could be useful when wanting modifications
# for a user's provisioning to remain until reboot.

# Users can make their own sub cgroup
# in order to control some aspects such as
# CPU core affinity.
# However, users may not modify settings
# that of their main user cgroup.
# And user sub cgroups are still bound by the constraints
# of the cgroups that contain it such as the user cgroup.



find_cgroup(){
 if [ -n "$CG" ]; then return 0; fi
 local DEV JUNK TYPE
 while read DEV CG TYPE JUNK; do
  if   [[ $DEV == cgroup_root ]] && [[ $TYPE == tmpfs  ]]; then return 0
  elif [[ $DEV == cgroup      ]] && [[ $TYPE == cgroup ]]; then return 0
  fi
 done < /proc/mounts
 unset CG
 return 1
}

task(){ while echo $PPID > $CG/$1/user/$PAM_USER/tasks; [ -n "$2" ]; do shift; done; }

open(){
 mkdir -pm 755   $CG/{blkio,cpu,cpuset,freezer,memory}/user
 mkdir  -m 700   $CG/{blkio,cpu,cpuset,freezer,memory}/user/$PAM_USER
 chown $PAM_USER $CG/{blkio,cpu,cpuset,freezer,memory}/user/$PAM_USER
 task blkio cpu cpuset freezer memory
}

untask(){
 while
  echo $$    > $CG/$1/tasks
  echo $PPID > $CG/$1/tasks
  read       < $CG/$1/user/$PAM_USER/tasks
  [ -n "$REPLY" ] || rmdir $CU
  [ -n "$2" ]; do
  shift
 done
}

close(){
 untask blkio cpu cpuset freezer memory
 return 0
}

find_cgroup || exit 0

case $PAM_TYPE in
  open_session) open  ;;
 close_session) close ;;
esac
