#!/bin/bash
# Copyright 2011 by Kyle Sallee
# All Rights Reserved
# For use on Sorcerer only

trap : INT QUIT TSTP
export PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin
umask 022

run(){
 if ! [ -f $1 ]; then return 1; fi
 if ! [ -x $1 ]; then return 1; fi

 local n="${1##*/}"; n=${n:3:256}
 local f=/var/log/init/failed/$n
 local p=/var/log/init/passed/$n

 $1 $2

 if   [ $? == 0 ]
 then echo -n > $p
 else echo -n > $f
 fi
}

series(){
 echo "Sysinit Begin"
 for S in /etc/rc.d/rcS.d/*; do run $S start; done
 echo "Sysinit End"
}

/sbin/agetty -f /etc/issue.rootfs /dev/tty7 9600 &

[ -f /var/log/init/sysinit ] && exit

if   ! [    -f               /proc/mounts ] ||
     ! grep -q /var/log/init /proc/mounts; then
 mkdir -p /var/log/init
 mount -o size=4m,nr_inodes=1k,mode=700 -t tmpfs tmpfs /var/log/init
 mkdir -p /var/log/init/{fail,pass}ed
fi

series

if [ -f /proc/$!/cmdline ]; then kill $!; fi
