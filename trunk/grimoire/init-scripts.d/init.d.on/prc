#!/bin/dash
trap : INT QUIT TSTP
export PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin
umask 022

CYAN="[36m"
NORM="[0m"

if   [ "$BASH_VERSION" ]
then BE=-e
fi

info(){ echo $BE "$CYAN * $NORM$1\r" 1>&2; }

linear() {
 for F in /etc/rc.d/rc${RL}.d/${1}*; do
  if [ -f $F ]; then
   $F $2
#   info "Run $F $2"; $F $2; info "Ran $F $2"
  fi
 done
}


# Breaking out of the loop early might cause a bug.

parallel(){
 SEQ=0
 while [ $SEQ -lt 100 ]; do
  if   [ $SEQ -lt 10  ]; then NOW="0$SEQ"; else NOW="$SEQ"; fi
  for F in /etc/rc.d/rc${RL}.d/$1${NOW}*
  do if [ -f $F ]; then $F $2 & else break 2; fi
  done
  wait
  SEQ=$(($SEQ+1))
 done
 wait
}

ssp(){ parallel K stop; parallel S start; }
ssl(){ linear   K stop; linear   S start; }
log(){ $1; echo End runlevel $RL; }

 RL=$1
RLL=/etc/init.d/log.d/runlevel.$RL
RLC=/etc/init.d/dev.d/rl

if   [ -c $RLC ] && echo > $RLC
then cap(){ tee $RLL > $RLC; }
else cap(){ tee $RLL; }
fi

case $RL in
   6|0) ssl ;;
 3|5|1) log ssl 2>&1 | cap ;;
   2|4) log ssp 2>&1 | cap ;;
esac
