#!/bin/bash
trap : INT QUIT TSTP
export PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin
umask 022
shopt -s nullglob

parallel(){
 for ((SEQ=0;SEQ<100;SEQ++)); do
  if (( 10 > SEQ )); then NOW="0$SEQ"; else NOW="$SEQ"; fi
  for SCRIPT in /etc/rc.d/rc${RL}.d/$1${NOW}*
  do $SCRIPT $2 &
  done
  wait
 done
}

linear() {
 for SCRIPT in /etc/rc.d/rc${RL}.d/${1}*
 do $SCRIPT $2
 done
}

ssp(){ parallel K stop; parallel S start; }
ssl(){ linear   K stop; linear   S start; }
log(){ $1; echo End runlevel $RL; }
cap(){ if [ -c $RLC ]; then tee $RLL > $RLC; else tee $RLL; fi; }

 RL=$1
RLL=/etc/init.d/log.d/runlevel.$RL
RLC=/etc/init.d/dev.d/rl

case $RL in
   6|0) ssl ;;
 3|5|1) log ssl 2>&1 | cap ;;
   2|4) log ssp 2>&1 | cap ;;
esac
