#!/bin/bash

### BEGIN INIT INFO
# Provides: $local_fs
# Required-Start: mtab root
# Required-Stop: halt cryptmount cryptsetup mdadm reboot
# Default-Start: S
# Default-Stop: 0 6
# Short-Description: mount mounts and un-mounts local file systems
### END INIT INFO

. /lib/lsb/init-functions

start(){
 run(){
  if   [ -f   /media/root/sbin/init ]
  then chroot /media/root mount -a
  else                    mount -a
  fi
 }

 log_warning_msg 'Mounting filesystems from /etc/fstab'; run
 log_success_msg 'Mounted  filesystems'
}

stop(){
 run(){
  sync
  [ -f /proc/mounts ] || mount -nrt proc proc /proc

  cut -d ' ' -f2 /proc/mounts |
  LC_ALL=C sort -ur | xargs -r --max-lines=256 umount -lr
 }

 log_warning_msg 'umounting all filesystems'; run
 log_success_msg 'umounted  all filesystems'
}

help(){ echo "Usage: $0 {start|stop}" 1>&2; }

case $@ in
 start) start ;;
 stop) stop ;;
 try-restart) : ;;
 *) help ;;
esac
