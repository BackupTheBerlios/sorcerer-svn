with version   stable 1.0.1e 1.0.1d 1.0.1c
with version   secure 1.0.1d
with base    perl pkgconfig
with role    security/encryption
with trait   library lto multilib-dual
#trait makej
with source  stable \
             http://www.openssl.org/source/\
              ftp://ftp.openssl.org/source/ \
              ftp://sunsite.cnlab-switch.ch/mirror/openssl/source/ \
              ftp://ftp.funet.fi/pub/crypt/cryptography/libs/openssl/source/ \
              ftp://ftp.pca.dfn.de/pub/tools/net/openssl/source/ \
              ftp://ftp.webmonster.de/pub/openssl/source/ \
              ftp://opensores.thebunker.net/pub/mirrors/openssl/source/ \
              ftp://ftp.net.lut.ac.uk/openssl/source/ \
              ftp://ftp.mirror.ac.uk/sites/ftp.openssl.org/source/ \
              ftp://sunsite.uio.no/pub/security/openssl/source/ \
              ftp://ftp.sunet.se/pub/security/tools/net/openssl/source/ \
              ftp://ftp.chl.chalmers.se/pub/unix/security/openssl/source/ \
              ftp://ftp.psy.uq.edu.au/pub/Crypto/OpenSSL/ \
              ftp://gd.tuwien.ac.at/infosys/security/openssl/source/ \
              ftp://guest.kuria.katowice.pl/pub/openssl/source/ \
              ftp://ftp.infoscience.co.jp/pub/Crypto/SSL/openssl/source/ \
              ftp://ftp.happysize.co.jp/mirror/openssl/source/ \
              ftp://ftp.elab.co.za/support/openssl/source/ \
              ftp://ftp.directnet.ru/pub/openssl/source/ \
              ftp://ftp.linux.hr/pub/openssl/source/ \
              ftp://ftp.openssl.uli.it/source/ \
              ftp://ftp.grmbl.com/pub/openssl/source/ \
              ftp://ftp.gin.cz/pub/MIRRORS/ftp.openssl.org/source/ \
              ftp://ftp.calyx.nl/pub/openssl/source/ \
              ftp://ftp.duth.gr/pub/OpenSSL/source/ \
              ftp://ftp.si.uniovi.es/mirror/OpenSSL/source/ \
            openssl-$VERSION.tar.gz
with source  secure \
             http://www.openssl.org/source/\
              ftp://ftp.openssl.org/source/ \
              ftp://sunsite.cnlab-switch.ch/mirror/openssl/source/ \
              ftp://ftp.funet.fi/pub/crypt/cryptography/libs/openssl/source/ \
              ftp://ftp.pca.dfn.de/pub/tools/net/openssl/source/ \
              ftp://ftp.webmonster.de/pub/openssl/source/ \
              ftp://opensores.thebunker.net/pub/mirrors/openssl/source/ \
              ftp://ftp.net.lut.ac.uk/openssl/source/ \
              ftp://ftp.mirror.ac.uk/sites/ftp.openssl.org/source/ \
              ftp://sunsite.uio.no/pub/security/openssl/source/ \
              ftp://ftp.sunet.se/pub/security/tools/net/openssl/source/ \
              ftp://ftp.chl.chalmers.se/pub/unix/security/openssl/source/ \
              ftp://ftp.psy.uq.edu.au/pub/Crypto/OpenSSL/ \
              ftp://gd.tuwien.ac.at/infosys/security/openssl/source/ \
              ftp://guest.kuria.katowice.pl/pub/openssl/source/ \
              ftp://ftp.infoscience.co.jp/pub/Crypto/SSL/openssl/source/ \
              ftp://ftp.happysize.co.jp/mirror/openssl/source/ \
              ftp://ftp.elab.co.za/support/openssl/source/ \
              ftp://ftp.directnet.ru/pub/openssl/source/ \
              ftp://ftp.linux.hr/pub/openssl/source/ \
              ftp://ftp.openssl.uli.it/source/ \
              ftp://ftp.grmbl.com/pub/openssl/source/ \
              ftp://ftp.gin.cz/pub/MIRRORS/ftp.openssl.org/source/ \
              ftp://ftp.calyx.nl/pub/openssl/source/ \
              ftp://ftp.duth.gr/pub/OpenSSL/source/ \
              ftp://ftp.si.uniovi.es/mirror/OpenSSL/source/ \
            openssl-$VERSION.tar.gz
with info    last 20130213
with info    home http://www.openssl.org/
with protect /etc/ssl/certs/
with info    cite 'library for providing encrypted transport layers
The OpenSSL Project is a collaborative effort to develop
a robust, commercial-grade, full-featured, and Open Source
toolkit implementing the Secure Sockets Layer (SSL v2/v3)
and Transport Layer Security (TLS v1) protocols as well
as a full-strength general purpose cryptography library.'

build(){
 remove_ar(){ rm -f $DESTDIR/{,usr/}lib{,64}/lib{crypto,ssl}.a; }

 move_include_man(){
  if ! [ -d $DESTDIR/usr     ]; then mkdir -pvm 755 $DESTDIR/usr; fi
  if   [ -d $DESTDIR/include ]; then mv     -v $DESTDIR/{include,usr/}; fi
  if   [ -d $DESTDIR/lib/pkgconfig ]; then
   mkdir -pvm 755 $DESTDIR/usr/lib
   mv     -v      $DESTDIR/{lib/pkgconfig,usr/lib/}
   sed -i 's:libdir=${exec_prefix}/lib:libdir=/lib:
           s:^prefix=/$:prefix=/usr:' $DESTDIR/usr/lib/pkgconfig/*.pc
   cp -al $DESTDIR/lib/*.so* $DESTDIR/usr/lib
  fi
  if   [ -d $DESTDIR/lib64/pkgconfig ]
  then mkdir -pvm 755 $DESTDIR/usr/lib64
       mv     -v      $DESTDIR/{lib64/pkgconfig,usr/lib64/}
   sed -i 's:libdir=${exec_prefix}/lib:libdir=/lib:
           s:^prefix=/$:prefix=/usr:' $DESTDIR/usr/lib64/pkgconfig/*.pc
   cp -al $DESTDIR/lib64/*.so* $DESTDIR/usr/lib64
  fi
  if   [ -d  $DESTDIR/man ]
  then mv -v $DESTDIR/{man,usr/}
  fi
 }

 strip_destdir(){
  local  LC_ALL
  export LC_ALL=C

  find $DESTDIR -type f     |
  xargs --max-lines=64 file |
  grep ', not stripped'     |
  cut -d : -f1              |
  xargs --max-lines=64 strip --strip-unneeded
 }

 local OS=linux-elf

 # Trying to control optimization and linking of openssl libraries
 # seems ineffective by the ways below.

 grep  -rl                       '\-O3 -Wall' * |
 xargs -r --max-lines=64 sed -i "s:-O3 -Wall:$CFLAGS:"
 grep  -rl                       '\-O3 -fomit-frame-pointer -Wall' * |
 xargs -r --max-lines=64 sed -i "s:-O3 -fomit-frame-pointer -Wall:$CFLAGS:"

 sed -i "s:^LDFLAGS=$:LDFLAGS=$LDFLAGS:
         s:^SHARED_LDFLAGS=$:SHARED_LDFLAGS=$LDFLAGS:" Makefile{,.org,.shared}

 sed -i 's:-Wl,-rpath,$(LIBRPATH)::' Makefile.shared

 if   [[ $HOSTTYPE == x86_64 ]]; then
  if  [[ $CFLAGS   =~ -m32   ]];
  then OS="linux-generic32"
  else OS="linux-x86_64"
  fi
 else  OS="linux-elf"
 fi

 if   [[ $HOSTTYPE == x86_64 ]] && ! [[ $CFLAGS =~ -m32 ]]
 then mkdir -pm 755 $DESTDIR/lib64/pkgconfig
 else mkdir -pm 755 $DESTDIR/lib/pkgconfig
 fi

#./Configure --prefix=/usr --openssldir=/etc/ssl shared $OPTS $OS &&
 ./Configure --prefix=/ --openssldir=/etc/ssl shared $OPTS $OS &&
 make &&
 rm -f $DESTDIR/usr/man/man3/EVP_BytesToKey.3 &&
 make install MANDIR=/usr/man INSTALL_PREFIX=$DESTDIR &&
 remove_ar &&
 move_include_man &&
 strip_destdir
}

post_install(){
          get_provider ntp     |
 pipe     get_provider openssh |
 pipe     show_installed       |
 LC_ALL=C sort                 |
          uniq -d              |
          pipe_queue $MOIL_QUEUE
}
