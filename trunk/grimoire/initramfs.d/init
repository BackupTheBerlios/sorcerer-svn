#!/bin/dash

# /init
# Copyright 2008-2010 Kyle Sallee All rights reserved
# /init executes only from the initramfs as PID 1.
# For use with Sorcerer only

[ $$ = 1 ] || exit 1

MR=/media/root

allpaths(){ export LC_ALL=C; sed -nr "p;:a;s:(.+)/.*:\1:p;ta" | sort -u; }

what(){
 if   [ -d /lib64 ]
 then find /bin /etc /init /lib /lib64 /sbin /usr -mount -anewer /start
 else find /bin /etc /init /lib        /sbin /usr -mount -anewer /start
 fi
 cp -a /lib/udev/dev/* /dev
 find /bin/sleep /dev/ /etc/init.d/dev.d /etc/coldplug /init /lib/udev/dev
 echo /media/root
}

rmnod(){
 find $1 -not -type d |
 xargs -r --max-lines=256 stat --printf "%t\t%n\n" 2>/dev/null |
 sed -n "s:^f[0-9abcde]\t::p" |
 xargs -r --max-lines=256 rm -f
}

used(){ what | sed '\,^/etc/mtab,d' | allpaths; }

construct(){
 if [     -f $MR/boot/fast/initrf ] ||
    [     -d $MR/boot/isolinux    ] ||
    [     -f    /tmp/coldpug      ] ||
  ! [     -d $MR/boot             ] ||
  ! [     -f $MR/usr/bin/cpio     ] ||
  ! [     -f $MR/etc/lilo/fast    ] ||
  ! mkdir -p $MR/boot/fast
 then return
 fi

 rm    -fr     $MR/etc/coldplug/*          /etc/coldplug/*
 mkdir -pm 700 $MR/etc/coldplug/dev        /etc/coldplug/dev
 cp    -a      $MR/dev/*                   /etc/coldplug/dev/
 rmnod            /etc/coldplug/dev
 cp    -a         /etc/coldplug/dev/*   $MR/etc/coldplug/dev/

 sed -n 's: .*::; 1! G; $ p; h' $MR/proc/modules |
 tee $MR/etc/coldplug/modules \
      > /etc/coldplug/modules

 umask 077
 read J J V J < $MR/proc/version &&
 if [ -f $MR/boot/$V/linux ]; then
  cp -al $MR/boot/$V/System.map $MR/boot/$V/linux $MR/boot/fast/ &&
  used | $MR/usr/bin/cpio -o -H newc --quiet >    $MR/boot/fast/initrf && 
  sync &&
  /sbin/lilo -r $MR -C /etc/lilo/fast
 else rmdir $MR/boot/fast
 fi
 umask 022
}


destruct(){
 sleep 60
 rm -fr /bin /dev /etc /init /lib /lib64 /sbin /usr
}

trap : INT QUIT TSTP
export PATH=/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin
umask 022

echo > /start
echo > /etc/mtab

[     -d /proc ] ||
mkdir -p /proc
mount -t  proc proc /proc

read l < /proc/cmdline
for c in $l; do
 case $c in
  root=/dev/*)
   r=${c##root=}
   sed -i 's:\t: :g; \, / ,d' /etc/fstab
   echo "$r / auto defaults 0 0" >> /etc/fstab
   echo "Using $r for /"
  ;;
 esac
done

/etc/init.d/rcS

if [ -f $MR/sbin/init ]; then
 construct
 destruct &
 cd $MR
 mount --move $MR /
 exec chroot . /sbin/init "$@"
elif grep -q boot=IR /proc/cmdline; then
 exec /sbin/init "$@"
else
 echo Unable to mount a root filesystem as $MR
 echo Unable to continue booting
 exec sulogin
fi
