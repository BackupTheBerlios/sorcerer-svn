#!/bin/bash
# Copyright 2011, 2012 by Kyle Sallee,
# All rights reserved.
# For use with the Sorcerer distribution only.

# sentinel-elf periodically verifies that
# important ELF libraries can be loaded.
# If a problem is detected
# then a previous backups of the library directory
# is restored in order to end the crisis.

if ! [ -f /media/root/real/usr/sbin/elfchain ]; then
 echo "sentinel-elf runs only on the Sorcerer's keep." 1>&2
 exit 1
fi

chain(){
 if ! [ -f   /media/root/real//usr/sbin/elfchain ]; then return 0; fi
 if ! chroot /media/root/real /usr/sbin/elfchain  ; then sleep 30
      chroot /media/root/real /usr/sbin/elfchain
 fi
}

repair(){
 fix(){
  if ! [ -d $f/$1 ]; then return 0; fi
  mv        $r/$1 $b/
  cp -a     $f/$1 $r/
  logger -p syslog.crit -s -t sentinel-elf -- $"ELF library failure detected"
  logger -p syslog.crit -s -t sentinel-elf -- $"$r/$1 moved  to $b/$1"
  logger -p syslog.crit -s -t sentinel-elf -- $"$f/$1 copied to $r/$1"
 }

 local r=/media/root/real
 local a=$r/aux
 local b=$a/bad
 local f=$a/fit

 rm    -fr     $b
 mkdir -pm 755 $a
 mkdir -pm 700 $b
 case $HOSTTYPE in
  x86_64) fix lib64 ;;
       *) fix lib   ;;
 esac
}

main(){
 if   [[     -x /media/root/real/usr/libexec/bash/sleep ]]
 then enable -f /media/root/real/usr/libexec/bash/sleep sleep
 fi
 while sleep 60; do chain || repair; done
}

main &>/dev/null &
exit 0
