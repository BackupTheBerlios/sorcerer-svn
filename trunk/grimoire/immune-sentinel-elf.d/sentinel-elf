#!/bin/bash
# Copyright 2011 by Kyle Sallee,
# All rights reserved.
# For use with the Sorcerer distribution only.

# sentinel-elf periodically verifies that
# important ELF libraries can be loaded.
# If a problem is detected
# then a previous backups of the library directory
# is restored in order to end the crisis.

if ! [ -f /media/root/usr/sbin/elfchain ]; then
 echo "sentinel-elf runs only on the Sorcerer's keep." 1>&2
 exit 1
fi

chain(){
 [ -f   /media/root/usr/sbin/elfchain ] || return 0
 chroot /media/root /usr/sbin/elfchain
}

repair(){
 fix(){
  if ! [ -d $1.sav ]; then return 0; fi
  mv    $1{,.bad}
  cp -a $1{.sav,}
  logger -p syslog.crit -s -t sentinel-elf -- $"ELF library failure detected"
  logger -p syslog.crit -s -t sentinel-elf -- $"$1     moved  to $1.bad"
  logger -p syslog.crit -s -t sentinel-elf -- $"$1.sav copied to $1"
 }

 case $HOSTTYPE in
  x86_64) fix /media/root/lib64 ;;
       *) fix /media/root/lib   ;;
 esac
}

lock(){
 [ -s            /var/run/sentinel-elf.pid ] &&
 kill -15    $(< /var/run/sentinel-elf.pid )
 echo $BASHPID > /var/run/sentinel-elf.pid
}

end(){ rm -f /var/run/sentinel-elf.pid; exit 0; }

main(){
 lock
 trap end EXIT
 if   [[     -x /media/root/usr/libexec/bash/sleep ]]
 then enable -f /media/root/usr/libexec/bash/sleep sleep
 fi
 while sleep 60; do chain || repair; done
}

main &>/dev/null &
exit 0
