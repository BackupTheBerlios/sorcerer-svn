#!/bin/bash
# Copyright 2000 through 2008 by Kyle Sallee,
# All rights reserved.
# For use with the distribution Sorcerer only.
# md5sum checks md5sums of files installed by spells.

. /etc/sorcery/config

export LC_ALL=C
trap : SIGHUP SIGINT SIGQUIT SIGILL SIGABRT SIGSTOP SIGTERM

renice 19      -p $$ &>/dev/null
ionice -c2 -n7 -p $$ &>/dev/null

SKIP='\:  /etc/init.d/:p;\:  /etc/:d'
WHAT='Unexpected md5sum'
 LOG='Cast MD5'
 EXT=$RANDOM$RANDOM$RANDOM
 OLD=/tmp/md5sums.old.$EXT
 MIS=/tmp/md5sums.mis.$EXT
 CHK=/tmp/md5sums.chk.$EXT

tsum(){ find $MD5SUM_LOGS -type f | sed '/\.gz$/d'; }
gsum(){ find $MD5SUM_LOGS -type f | sed '/\.gz$/p;d'; }
sums(){ tsum | xargs -r --max-lines=1024 cat
        gsum | xargs -r --max-lines=1024 gzip -cd; }
 use(){ sed "$SKIP"; }
 old(){ sums | use | tee $OLD; }
name(){ cut -b 35-; }
 now(){ name | sort -u | escape_qs | xargs -r --max-lines=1024 md5sum | tee $CHK; }
from(){ while read; do grep -rx "$REPLY" $INSTALL_LOGS; done | sed "s:$INSTALL_LOGS/::"; }
peal(){ sed  "s,:,\t,;s,^,$WHAT\t," | tee /dev/stderr | cut -f2 | sort -u; }
this(){ pipe_queue "$CAST_QUEUE"; }
miss(){ sed 's/^md5sum: //;s/: No such file or directory$//p;d' $MIS; }
prepare(){ echo -en "\r0%"; }
percent(){ SOLD=$( finfo -s $OLD ); SCHK=$( finfo -s $CHK );
           (( PER = SCHK * 100 / $SOLD )); echo -en "\r$PER%"; }

why(){
 echo 1>&2; while read R; do
  event "$R" "$( installed_version "$R" )" "$LOG"
  echo "$R"
 done
 }


check(){
 old  | now 2>$MIS | cat - $OLD $OLD | sort | uniq -u |
 name | pipe miss  | sort -u |
 from | peal       | why     | this
 rm -f $OLD $MIS $CHK
}


guess(){
 while [[ -f $OLD ]] && ! [[ -s $CHK ]]; do prepare; sleep 5; done
 while [[ -f $OLD ]];                    do percent; sleep 5; done
 echo
}

touch     $OLD $MIS $CHK
chmod 600 $OLD $MIS $CHK

sync
[ -f     /proc/sys/vm/drop_caches ] &&
echo 1 > /proc/sys/vm/drop_caches
check &
guess 2>/dev/null
