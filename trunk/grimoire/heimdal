# optional on x11 removed because causes circuliar requirement with xsm
#            'x11:::for forwarding X connections and for locking the screen'
# The 1.3.0 headers have a problem.

   version stable 1.4 1.3.3 1.3.2
   version unstable 1.5.pre2 1.5pre1
      info last  20100913
# otp has a link error because it is missing -ldb in version 1.3.2
# otp has a link error also in version 1.4
case $VERSION in
   1.4) opts --disable-otp ;;
 1.3.3) opts --disable-otp ;;
 1.3.2) opts --disable-otp ;;
esac
   require bison db e2fsprogs flex ncurses openssl pkgconfig
  optional libXt '' '' for forwarding X connections and locking the screen
      opts --enable-shared=yes  --enable-static=no
  category security/authentication security/encryption
 attribute console library
#attribute makej multilib-dual
    source http://www.h5l.org/dist/src/heimdal-$VERSION.tar.gz
      info home  http://www.h5l.org/
   provide kerberos
      desc 'free implementation of Kerberos 5'

build(){
 export CFLAGS+=' -fPIC'
 export CXXFLAGS+=' -fPIC'

 sed -i 's:db, fn, NULL,:db, (DB_TXN *) NULL, fn, NULL,:
         s:db, db->hdb_name, NULL,:db, (DB_TXN *) NULL, db->hdb_name, NULL,:' lib/hdb/db3.c


 sed -i 's:db, fn, NULL,:db, (DB_TXN *) NULL, fn, NULL,:' lib/roken/ndbm_wrap.c

 LOG='
[logging]
 kdc = FILE:/var/heimdal/kdc.log
 kdc = SYSLOG:INFO
 default = SYSLOG:INFO:USER
'

 install_conf(){
  echo "$LOG" >> krb5.conf
  mkdir -p $DESTDIR/etc
  install -vm 600 krb5.conf $DESTDIR/etc/
 }

 install_dir(){ mkdir -vp 700 $DESTDIR/var/heimdal; }

 # export  ac_cv_func_glob_working=yes

 case $MACHTYPE in
  *-uclibc) sed -i 's:ruserpass:ruserpw:' appl/ftp/ftp/{extern.h,ftp.c,ruserpass.c} ;;
 esac

# sed -i 's:lib_flags="-L${libdir}"::' tools/krb5-config.in

 default_build &&
 install_conf &&
 install_dir
}
