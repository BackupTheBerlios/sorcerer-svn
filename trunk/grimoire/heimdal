# optional on x11 removed because causes circuliar requirement with xsm
#            'x11:::for forwarding X connections and for locking the screen'
# The 1.3.0 headers have a problem.

    latest 1.3.2 1.3.1 1.3.0
    stable 1.3.2 1.2.1 1.2 1.1 1.0.2 1.0.1 1.0
  unstable 1.3.2 1.3.2rc2 1.3.2rc1 1.3.1rc1 1.3.0rc1 1.3.0pre11
# otp has a link error because it is missing -ldb in version 1.3.2
case $VERSION in
 1.3.2) opts --disable-otp ;;
esac
   require bison db e2fsprogs flex ncurses openssl
  optional libXt '' '' for forwarding X connections and locking the screen
  category security/authentication security/encryption
 attribute console
#       url 'ftp://ftp.sunet.se/pub/unix/admin/mirror-pdc/heimdal/src/
#            ftp://ftp.pdc.kth.se/pub/heimdal/src/
#            ftp://ftp.ayamura.org/pub/heimdal/
#            ftp://ftp.sunet.se/pub/unix/admin/mirror-pdc/pub/heimdal/src/'
#    source heimdal-$VERSION.tar.gz
    source http://www.h5l.org/dist/src/heimdal-$VERSION.tar.gz
  homepage http://www.h5l.org/
      opts --enable-shared=yes  --enable-static=no
   provide kerberos
  estimate 7000
      desc 'free implementation of Kerberos 5'

build(){
export CFLAGS+=' -fPIC'
export CXXFLAGS+=' -fPIC'

sed -i 's:db, fn, NULL,:db, (DB_TXN *) NULL, fn, NULL,:
        s:db, db->hdb_name, NULL,:db, (DB_TXN *) NULL, db->hdb_name, NULL,:' lib/hdb/db3.c


sed -i 's:db, fn, NULL,:db, (DB_TXN *) NULL, fn, NULL,:' lib/roken/ndbm_wrap.c



LOG='
[logging]
 kdc = FILE:/var/heimdal/kdc.log
 kdc = SYSLOG:INFO
 default = SYSLOG:INFO:USER
'

copy_headers(){
 mkdir -p                  save
 cp /usr/include/glob.h    save
 cp /usr/include/fnmatch.h save
 cp /usr/include/ss/ss.h   save
 true
}

restore_headers(){

 chk_or_cp(){
  cmp -s /usr/include/$1 save/$2 ||
  cp     save/$2 /usr/include/$1
}

 chk_or_cp glob.h    glob.h
 chk_or_cp fnmatch.h fnmatch.h
 chk_or_cp ss/ss.h   ss.h
 true
}

install_conf(){
 echo "$LOG" >> krb5.conf
 install -vm 0600 krb5.conf /etc/
}

install_dir(){ mkdir -vp 0700 /var/heimdal; }

# export  ac_cv_func_glob_working=yes

case $MACHTYPE in
 *-uclibc) sed -i 's:ruserpass:ruserpw:' appl/ftp/ftp/{extern.h,ftp.c,ruserpass.c} ;;
esac

# case $VERSION in
#  1.2.1) sed -i 's:openssl/md2.h:openssl/mdc2.h:' include/{make_crypto.c,crypto-headers.h} ;;
# esac

./configure          \
--prefix=/usr        \
--sysconfdir=/etc    \
--localstatedir=/var \
$OPTS                &&
make                 &&
prepare_install      &&
   copy_headers      &&
make    install      &&
restore_headers      &&
        install_conf &&
        install_dir
}
