#!/bin/bash

# Copyright Kyle Sallee 2011, 2012
# All rights reserved.
# For use with the distribution sorcerer only!

# A cgroup with a sub-cgroup can not be removed.
# That could be useful when wanting modifications
# for a user's provisioning to remain until reboot.

# Users can make their own sub cgroup
# in order to control some aspects such as
# CPU core affinity.
# However, users may not modify settings
# that of their main user cgroup.
# And user sub cgroups are still bound by the constraints
# of the cgroups that contain it such as the user cgroup.

export PATH=/bin

open(){
 if [ -f         $CG/dmz ]; then echo $PPID > $CG/tasks; return; fi
 mkdir -pm 700   $CG/{fast,idle,norm,slow}/user/$PAM_USER
 chown $PAM_USER $CG/{fast,idle,norm,slow}/user/$PAM_USER/tasks
 echo  $PPID >                    $CG/norm/user/$PAM_USER/tasks
 echo  900   >   $CG/fast/user/$PAM_USER/blkio.weight
 echo  700   >   $CG/norm/user/$PAM_USER/blkio.weight
 echo  100   >   $CG/slow/user/$PAM_USER/blkio.weight
 echo  10    >   $CG/idle/user/$PAM_USER/blkio.weight
}

close(){
 echo $$    > $CG/tasks
 echo $PPID > $CG/tasks
 cgroup_oust  $CG/{fast,idle,norm,slow}/user/$PAM_USER
}

[ -f /lib/cgroup/functions ] &&
.    /lib/cgroup/functions   &&
cgroup_find                  ||
exit 0

case $PAM_TYPE in
  open_session) open  ;;
 close_session) close ;;
esac
exit 0
