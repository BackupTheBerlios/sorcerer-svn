#!/bin/bash

# Copyright Kyle Sallee 2011
# All rights reserved.
# For use with the distribution sorcerer only!

help(){
 if [ -z "$1" ]; then
  echo "idle runs a process with minimal CPU and IO consumption."
  echo "The parameter can be a PID."
  echo "Otherwise specific a program to execute."
  echo "Additional parameters can be specified as the program's parameters."
  return 1
 fi 1>&2
}

find_cgroup(){
 if [ -n "$CG" ]; then return 0; fi
 local DEV JUNK TYPE
 while read DEV CG TYPE JUNK; do
  if   [[ $DEV == cgroup_root ]] && [[ $TYPE == tmpfs  ]]; then return 0
  elif [[ $DEV == cgroup      ]] && [[ $TYPE == cgroup ]]; then return 0
  fi
 done < /proc/mounts
 unset CG
 return 1
}

user_idle(){
 if   ! find_cgroup;  then echo "Error: Unable to locate cgroup filesystem." 1>&2; return 1
 elif [ -z "$USER" ]; then echo "Error: Unknown user." 1>&2; return 1; fi

 mkdir -pm 700 $CG/user/$USER
 echo 2      > $CG/user/$USER/cpu.shares
 echo 100    > $CG/user/$USER/blkio.weight
 echo $$     > $CG/user/$USER/tasks
}

execute(){
 if   grep -qx "$1"   $CG/user/$USER/tasks
 then echo     "$1" > $CG/user/$USER/idle/tasks
 else RUN=$1; shift 1; exec $RUN "$@"
 fi
}

help "$1" &&
user_idle &&
execute "$@"
